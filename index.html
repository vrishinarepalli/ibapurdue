<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>IBA Basketball Tournament</title>

  <!-- Mobile Detection & Redirect -->
  <script>
    // Detect mobile/tablet devices and redirect to mobile page
    // Mobile: 0-599px, Tablet: 600-1023px, Desktop: 1024px+
    (function() {
      // Check if we're already on the mobile page
      if (window.location.pathname.includes('mobile.html')) return;

      // Check if device is actually a mobile/tablet (User Agent detection)
      const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i.test(navigator.userAgent);

      // Check screen width (mobile/tablet if < 1024px)
      const isSmallScreen = window.innerWidth < 1024;

      // Only redirect if BOTH conditions are true:
      // 1. Device is mobile/tablet (User Agent)
      // 2. Screen is small (< 1024px)
      // This prevents desktop browsers with small windows from redirecting
      if (isMobileDevice && isSmallScreen) {
        window.location.replace('mobile.html');
      }
    })();
  </script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">

  <!-- GSAP for animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>

  <!-- Modular JavaScript - All features organized in js/ directory -->
  <script type="module" src="js/app.js"></script>

  <!-- Teams subtab styles -->
  <style>
    .teams-subtab.active {
      color: #CFB991 !important;
      border-bottom-color: #CFB991 !important;
    }
    .teams-subtab:hover {
      color: #000 !important;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Edit icon modal -->
    <div id="editIconModal" class="edit-icon-modal">
      <div class="edit-icon-content">
        <h3>Change Team Icon</h3>
        <p id="editIconTeamName" style="color: var(--muted); margin-bottom: 1rem;"></p>
        <div class="icon-picker" id="iconPicker">
          <!-- Icons will be populated by JavaScript -->
        </div>
        <div class="admin-buttons">
          <button type="button" class="admin-cancel" id="cancelIconEdit">Cancel</button>
          <button type="button" class="admin-submit" id="saveIcon">Save Icon</button>
        </div>
      </div>
    </div>

    <!-- Complete game modal -->
    <div id="completeGameModal" class="edit-game-modal">
      <div class="edit-game-content" style="max-width: 500px;">
        <h3>Complete Game</h3>
        <p id="completeGameMatchup" style="color: var(--text); text-align: center; font-size: 1.1rem; margin-bottom: 1.5rem;"></p>

        <div class="form-group">
          <label>Final Score</label>
          <div style="display: flex; gap: 1rem; align-items: center; justify-content: center;">
            <input type="number" id="team1Score" min="0" placeholder="0" required style="width: 80px; text-align: center; font-size: 1.2rem; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 8px;" />
            <span style="color: var(--muted); font-weight: 700;">-</span>
            <input type="number" id="team2Score" min="0" placeholder="0" required style="width: 80px; text-align: center; font-size: 1.2rem; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 8px;" />
          </div>
        </div>

        <div class="form-group">
          <label>Winner</label>
          <div style="display: flex; gap: 0.75rem;">
            <button type="button" id="team1WinBtn" class="winner-btn" style="flex: 1; padding: 0.75rem; background: var(--card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text); transition: all 0.2s;">
              <span id="team1WinName"></span>
            </button>
            <button type="button" id="team2WinBtn" class="winner-btn" style="flex: 1; padding: 0.75rem; background: var(--card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text); transition: all 0.2s;">
              <span id="team2WinName"></span>
            </button>
          </div>
        </div>

        <div class="admin-buttons" style="margin-top: 2rem;">
          <button type="button" class="admin-cancel" id="cancelCompleteGame">Cancel</button>
          <button type="button" class="admin-submit" id="submitCompleteGame">Complete Game</button>
        </div>
      </div>
    </div>

    <!-- Edit team modal -->
    <div id="editTeamModal" class="edit-game-modal">
      <div class="edit-game-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; padding: 2rem;">
        <h3 style="margin-top: 0;">Edit Team</h3>
        <form id="teamForm">
          <div class="form-group">
            <label>Team Name</label>
            <input type="text" id="editTeamName" required />
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label>Seed</label>
              <input type="number" id="teamSeed" min="1" max="32" required />
            </div>
            <div class="form-group">
              <label>Point Differential</label>
              <input type="number" id="teamPointDiff" required />
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label>Wins</label>
              <input type="number" id="teamWins" min="0" required />
            </div>
            <div class="form-group">
              <label>Losses</label>
              <input type="number" id="teamLosses" min="0" required />
            </div>
          </div>

          <div style="border-top: 2px solid var(--brand); margin: 2rem 0; padding-top: 1.5rem;">
            <h4 style="color: var(--brand); margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem;">‚ö° Roster Management</h4>

            <div id="rosterManager" style="margin-bottom: 1rem; min-height: 50px;">
              <!-- Roster items will be populated here -->
            </div>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" id="newPlayerName" class="input" placeholder="Player name" style="flex: 1; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.65rem; border-radius: 8px; font-size: 0.95rem;" />
              <button type="button" id="addPlayerBtn" style="padding: 0.65rem 1.2rem; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">+ Add Player</button>
            </div>
          </div>

          <div class="admin-buttons" style="margin-top: 2rem;">
            <button type="button" class="admin-cancel" id="cancelTeamEdit">Cancel</button>
            <button type="submit" class="admin-submit">Save Team</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Card Navigation -->
  <div class="card-nav-container">
      <nav class="card-nav" id="cardNav">
        <div class="card-nav-top">
          <div class="hamburger-menu" id="hamburgerMenu">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </div>

          <div class="nav-logo-container">
            <img src="images/iba-logo.png" alt="IBA Logo" class="nav-logo-img" />
            <div class="nav-title-text">
              <span class="nav-title-main">Indian Basketball Association</span>
              <span class="nav-title-sub">IBA Purdue</span>
            </div>
          </div>

          <!-- User Profile - Only shown when authenticated -->
          <div id="navUserProfile" style="display: none; position: relative; overflow: visible;">
            <button class="card-nav-user-button" id="navUserButton" style="position: relative; overflow: visible;">
              <img id="navUserAvatar" src="" alt="User Avatar" class="nav-user-avatar" style="overflow: hidden;" />
              <!-- Unread messages badge -->
              <span id="unreadBadge" style="position: absolute; top: -6px; right: -6px; background: #dc3545; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 11px; font-weight: 700; display: none; align-items: center; justify-content: center; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1000;">0</span>
            </button>
          </div>
        </div>

        <div class="card-nav-content" id="cardNavContent">
          <!-- Tournament Card -->
          <div class="nav-card" style="background: linear-gradient(135deg, #CFB991 0%, #D4BE9C 100%); color: #000;">
            <div class="nav-card-label">Tournament</div>
            <div class="nav-card-links">
              <a href="#" class="nav-card-link" data-tab="tab-current">
                <span>‚Üí</span>
                Current Season
              </a>
              <a href="#" class="nav-card-link" data-tab="tab-schedule">
                <span>‚Üí</span>
                Schedule
              </a>
              <a href="#" class="nav-card-link" data-tab="tab-bracket">
                <span>‚Üí</span>
                Bracket
              </a>
              <!-- Previous Tournaments link - Hidden for future use -->
              <!--
              <a href="#" class="nav-card-link" data-tab="tab-previous">
                <span>‚Üí</span>
                Previous Tournaments
              </a>
              -->
            </div>
          </div>

          <!-- Teams Card -->
          <div class="nav-card" style="background: linear-gradient(135deg, #D9C6A7 0%, #E4D4B8 100%); color: #000;">
            <div class="nav-card-label">Teams</div>
            <div class="nav-card-links">
              <a href="#" class="nav-card-link" onclick="switchToTeamsTab('all'); return false;">
                <span>‚Üí</span>
                All Teams
              </a>
              <a href="#" class="nav-card-link" id="navCreateTeamLink" onclick="switchToTeamsTab('create'); return false;">
                <span>‚Üí</span>
                Create Team
              </a>
              <a href="#" class="nav-card-link" onclick="switchToTeamsTab('freeagency'); return false;">
                <span>‚Üí</span>
                Free Agency
              </a>
            </div>
          </div>

          <!-- Info Card -->
          <div class="nav-card" style="background: linear-gradient(135deg, #EFE3C9 0%, #F5EDDA 100%); color: #000;">
            <div class="nav-card-label">Info</div>
            <div class="nav-card-links">
              <a href="about.html" class="nav-card-link">
                <span>‚Üí</span>
                About Us
              </a>
              <a href="#" class="nav-card-link" data-tab="tab-faq">
                <span>‚Üí</span>
                FAQ
              </a>
              <a href="#" class="nav-card-link" data-tab="tab-contact">
                <span>‚Üí</span>
                Contact
              </a>
            </div>
          </div>

          <!-- Social Media Card -->
          <div class="nav-card" style="background: linear-gradient(135deg, #FAF5EB 0%, #FFFCF5 100%); color: #000;">
            <div class="nav-card-label">Connect</div>
            <div class="nav-card-links">
              <a href="https://www.instagram.com/iba_purdue/" target="_blank" rel="noopener noreferrer" class="nav-card-link">
                <span>‚Üí</span>
                Instagram
              </a>
              <a href="https://www.youtube.com/@IBAPurdue" target="_blank" rel="noopener noreferrer" class="nav-card-link">
                <span>‚Üí</span>
                YouTube
              </a>
              <a href="https://groupme.com/join_group/103612585/ARKLYj6v?fbclid=PAZXh0bgNhZW0CMTEAAaeIjRa3CC7_aPN3OBin6Vwxb_526BpUeVZ17QKolQ1m9w-F70UaiJFOTz3s4Q_aem_2m9NaxxWRVEaJBnCeDxOxQ" target="_blank" rel="noopener noreferrer" class="nav-card-link">
                <span>‚Üí</span>
                GroupMe
              </a>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-bg">
        <img src="images/basketball-court.jpeg" alt="Basketball Court" onerror="this.style.display='none'">
        <div class="hero-overlay"></div>
      </div>
      <div class="hero-content">
        <h2>The Court. The Teams. The Glory</h2>
        <p id="heroSubtitle">IBA Spring 2026 ‚Ä¢ Tournament Applications Open</p>
        <button class="hero-btn" id="heroSignupBtn" style="cursor: pointer; border: none; font-size: inherit; font-family: inherit; padding: 15px 40px;">Sign In with Google</button>
      </div>
      <!-- Wave transition -->
      <div class="hero-wave">
        <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
          <path d="M0,0 C300,80 900,80 1200,0 L1200,120 L0,120 Z" fill="#fff"></path>
        </svg>
      </div>
    </section>

    <!-- League Stats Carousel Section -->
    <section class="stats-carousel-section">
      <div class="stats-carousel-container">
        <div class="stats-carousel-track" id="statsCarouselTrack">
          <div class="stat-card-large">
            <div class="stat-card-label">200+ Regular Season Games</div>
          </div>
          <div class="stat-card-large">
            <div class="stat-card-label">50+ Playoff Games</div>
          </div>
          <div class="stat-card-large">
            <div class="stat-card-label">3 Champions So Far</div>
          </div>
          <div class="stat-card-large">
            <div class="stat-card-label">50+ Unique Teams</div>
          </div>
          <div class="stat-card-large">
            <div class="stat-card-label">150+ Unique Players</div>
          </div>
          <div class="stat-card-large">
            <div class="stat-card-label">$630 in Prizes</div>
          </div>
          <div class="stat-card-large">
            <div class="stat-card-label">Longest Game: 1hr 4min<br><span style="font-size: 0.85em; opacity: 0.9;">67 Elite Freaks vs Tandoori Towers</span></div>
          </div>
        </div>
        <button class="carousel-btn carousel-btn-left" id="carouselBtnLeft">‚Äπ</button>
        <button class="carousel-btn carousel-btn-right" id="carouselBtnRight">‚Ä∫</button>
      </div>
    </section>

  <div class="wrap">
    <main class="tabs" role="main">
      <div class="tablist" role="tablist" aria-label="Tournament sections">
        <button role="tab" id="tab-current" aria-selected="true" aria-controls="panel-current">Current Season</button>
        <button role="tab" id="tab-schedule" aria-selected="false" aria-controls="panel-schedule">Schedule</button>
        <button role="tab" id="tab-teams" aria-selected="false" aria-controls="panel-teams">Teams</button>
        <button role="tab" id="tab-bracket" aria-selected="false" aria-controls="panel-bracket">Bracket</button>
        <!-- Previous Tournaments tab - Hidden for future use -->
        <!-- <button role="tab" id="tab-previous" aria-selected="false" aria-controls="panel-previous" style="display: none;">Previous Tournaments</button> -->
        <button role="tab" id="tab-myteams" aria-selected="false" aria-controls="panel-myteams" style="display: none;" class="player-only">My Teams</button>
        <button role="tab" id="tab-adminrequests" aria-selected="false" aria-controls="panel-adminrequests" style="display: none;" class="admin-only">Admin Requests</button>
        <a href="about.html" style="text-decoration: none;">
          <button role="tab" style="background: transparent; border: none; cursor: pointer;">About Us</button>
        </a>
        <button role="tab" id="tab-faq" aria-selected="false" aria-controls="panel-faq">FAQ</button>
        <button role="tab" id="tab-contact" aria-selected="false" aria-controls="panel-contact">Contact Us</button>
        <button role="tab" id="tab-signup" aria-selected="false" aria-controls="panel-signup">üîê Sign In / Account</button>
      </div>

      <section id="panel-current" class="tabpanel active" role="tabpanel" aria-labelledby="tab-current">
        <div style="max-width: 900px; margin: 0 auto; padding: 2rem 1rem;">

          <!-- Hero Header -->
          <div style="background: linear-gradient(135deg, #CFB991 0%, #A89968 100%); padding: 2.5rem 2rem; border-radius: 16px; text-align: center; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(207, 185, 145, 0.3);">
            <h2 style="font-size: 2.5rem; font-weight: 700; color: #000; margin-bottom: 0.5rem;">üèÄ Spring 2026 Tournament</h2>
            <p style="font-size: 1.2rem; color: #1a1a1a; font-weight: 500;">Starts February 2026</p>
          </div>

          <!-- Tournament Info Images -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem; max-width: 700px; margin-left: auto; margin-right: auto;">
            <div style="border-radius: 16px; overflow: hidden; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); height: 400px;">
              <img src="images/32teamsplayoffs.png" alt="32 Teams Playoffs" style="width: 100%; height: 100%; object-fit: cover; object-position: center 20%; display: block;" />
            </div>
            <div style="border-radius: 16px; overflow: hidden; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); height: 400px;">
              <img src="images/3regseasongames.png" alt="3 Regular Season Games" style="width: 100%; height: 100%; object-fit: cover; object-position: center 20%; display: block;" />
            </div>
          </div>

          <!-- Prize Pool -->
          <div style="margin-bottom: 2rem;">
            <h3 style="text-align: center; font-size: 1.8rem; margin-bottom: 1.5rem; color: var(--text);">üí∞ Prize Pool</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
              <!-- Black Division -->
              <div style="background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%); border-radius: 16px; padding: 2rem; text-align: center; position: relative; overflow: hidden; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);">
                <div style="position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1;">‚ö´</div>
                <div style="position: relative; z-index: 1;">
                  <div style="font-size: 1.3rem; color: white; font-weight: 600; margin-bottom: 0.5rem;">Black Division</div>
                  <div style="font-size: 0.9rem; color: #999; margin-bottom: 1rem;">16 Teams Competing</div>
                  <div style="font-size: 3rem; font-weight: 700; color: #CFB991;">$150</div>
                  <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">Grand Prize</div>
                </div>
              </div>
              <!-- Gold Division -->
              <div style="background: linear-gradient(135deg, #CFB991 0%, #A89968 100%); border-radius: 16px; padding: 2rem; text-align: center; position: relative; overflow: hidden; box-shadow: 0 8px 24px rgba(207, 185, 145, 0.4);">
                <div style="position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1;">üü°</div>
                <div style="position: relative; z-index: 1;">
                  <div style="font-size: 1.3rem; color: #000; font-weight: 600; margin-bottom: 0.5rem;">Gold Division</div>
                  <div style="font-size: 0.9rem; color: #3a3a3a; margin-bottom: 1rem;">16 Teams Competing</div>
                  <div style="font-size: 3rem; font-weight: 700; color: #000;">$150</div>
                  <div style="font-size: 0.85rem; color: #3a3a3a; margin-top: 0.5rem;">Grand Prize</div>
                </div>
              </div>
            </div>
            <p style="text-align: center; margin-top: 1.5rem; font-size: 1.1rem; color: var(--text); font-weight: 500;">Every team has a chance to win! üåü</p>
          </div>

          <!-- Format Explanation with Images -->
          <div style="background: linear-gradient(to right, #f8f9fa, #ffffff); border-left: 4px solid #CFB991; border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem;">
            <h4 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--text); font-weight: 700; text-align: center;">üìã How It Works</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
              <!-- 32 Teams Info -->
              <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                <div style="width: 120px; height: 120px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 1rem;">
                  <img src="images/32teamsplayoffs.png" alt="32 Teams" style="width: 100%; height: 100%; object-fit: cover; object-position: center 20%;" />
                </div>
                <h5 style="font-size: 1.1rem; font-weight: 600; color: var(--brand); margin-bottom: 0.5rem;">32 Teams Compete</h5>
                <p style="font-size: 0.9rem; color: var(--text); line-height: 1.5; margin: 0;">Every team makes the playoffs! No one is left out of championship contention.</p>
              </div>

              <!-- 3 Regular Season Games -->
              <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                <div style="width: 120px; height: 120px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 1rem;">
                  <img src="images/3regseasongames.png" alt="3 Regular Season Games" style="width: 100%; height: 100%; object-fit: cover; object-position: center 20%;" />
                </div>
                <h5 style="font-size: 1.1rem; font-weight: 600; color: var(--brand); margin-bottom: 0.5rem;">3-Game Regular Season</h5>
                <p style="font-size: 0.9rem; color: var(--text); line-height: 1.5; margin: 0;">Teams compete in 3 games to determine playoff division placement.</p>
              </div>
            </div>

            <!-- Tournament Format Text -->
            <div style="background: white; border-radius: 8px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <p style="line-height: 1.8; color: var(--text); margin-bottom: 1rem;">
                After the regular season, the <strong>top 16 teams</strong> advance to the <strong>Black Division</strong> playoffs,
                while the <strong>lower 16 teams</strong> compete in the <strong style="color: #CFB991;">Gold Division</strong> playoffs.
              </p>
              <p style="line-height: 1.8; color: var(--text); margin: 0;">
                Both divisions crown a champion with a <strong style="color: #CFB991; font-size: 1.1rem;">$150 prize</strong>!
                Every team has a shot at the championship. üèÜ
              </p>
            </div>
          </div>

          <!-- Important Notices -->
          <div style="display: grid; gap: 1rem;">
            <div style="background: #fff9e6; border-left: 4px solid #ffc107; border-radius: 8px; padding: 1rem 1.25rem;">
              <div style="font-weight: 600; color: #856404; margin-bottom: 0.25rem;">‚ö†Ô∏è Payment Required</div>
              <div style="font-size: 0.9rem; color: #856404;">All teams must complete payment before participating in tournament games.</div>
            </div>
            <div style="background: #e8f4f8; border-left: 4px solid #17a2b8; border-radius: 8px; padding: 1rem 1.25rem;">
              <div style="font-weight: 600; color: #0c5460; margin-bottom: 0.5rem;">ü§ù Fair Play Commitment</div>
              <div style="font-size: 0.9rem; color: #0c5460; line-height: 1.6;">
                IBA is committed to maintaining fair and competitive play throughout the tournament. To ensure balanced competition:
                <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                  <li style="margin-bottom: 0.25rem;">IBA may ask teams to split up if their skill level is significantly higher than other teams.</li>
                  <li>Teams should refrain from having multiple players who have played basketball at any level higher than high school.</li>
                </ul>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section id="panel-schedule" class="tabpanel" role="tabpanel" aria-labelledby="tab-schedule">
        <button class="add-game-btn" id="addGameBtn">+ Add New Game</button>
        <div class="quick-add-section" style="display: none; margin-bottom: 1rem;">
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="quickAddInput" class="input" style="flex: 1;" placeholder="Team1 vs Team2,Date,Day,Time,Court,Round,Status (e.g. KOS vs BBB,2025-01-10,Friday,800pm,Court A,Round of 16,Scheduled)" />
            <button class="admin-submit" id="quickAddBtn" style="padding: 0.55rem 1rem; border-radius: 10px;">Quick Add</button>
          </div>
          <div style="color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem;">
            Format: Team1 vs Team2,Date,Day,Time,Court,Round,Status (Date: YYYY-MM-DD, Time: 800pm, 1000pm, etc.)
          </div>
        </div>
        <div class="controls">
          <input id="search" class="input" type="search" placeholder="Search team..." aria-label="Search schedule" />
          <select id="dayFilter" class="select" aria-label="Filter by day">
            <option value="">All days</option>
          </select>
          <select id="courtFilter" class="select" aria-label="Filter by court">
            <option value="">All courts</option>
          </select>
          <button id="searchBtn" class="admin-submit" style="padding: 0.55rem 1rem; border-radius: 10px;">Search</button>
        </div>
        <div class="table-wrap">
          <table id="scheduleTable" aria-describedby="scheduleCaption">
            <caption id="scheduleCaption" class="sr-only">Tournament game schedule</caption>
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Day</th>
                <th scope="col">Time</th>
                <th scope="col">Matchup</th>
                <th scope="col">Court</th>
                <th scope="col">Round</th>
                <th scope="col">Status</th>
                <th scope="col" class="admin-mode" style="display: none;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Games will be loaded from Firestore -->
            </tbody>
          </table>
        </div>
      </section>

      <section id="panel-teams" class="tabpanel" role="tabpanel" aria-labelledby="tab-teams">
        <!-- Teams Sub-Navigation -->
        <div style="display: flex; gap: 0.75rem; margin-bottom: 2rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0;">
          <button id="teams-subtab-all" class="teams-subtab active" onclick="switchTeamsTab('all')" style="padding: 0.75rem 1.5rem; border: none; background: none; font-size: 1rem; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
            All Teams
          </button>
          <button id="teams-subtab-create" class="teams-subtab" onclick="switchTeamsTab('create')" style="padding: 0.75rem 1.5rem; border: none; background: none; font-size: 1rem; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
            Create Team
          </button>
          <button id="teams-subtab-freeagency" class="teams-subtab" onclick="switchTeamsTab('freeagency')" style="padding: 0.75rem 1.5rem; border: none; background: none; font-size: 1rem; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
            Free Agency
          </button>
        </div>

        <!-- All Teams Panel -->
        <div id="teams-panel-all" class="teams-subpanel">
          <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; color: #000; font-weight: 700; font-size: 1.5rem;">Spring 2026 Teams</h3>
            <p style="margin: 0; color: #666; line-height: 1.6;">All teams registered for the Spring 2026 tournament will appear here once registration opens.</p>
          </div>
          <div id="teamsGrid" class="grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
            <!-- Teams will be loaded dynamically from Firestore -->
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #999;">
              <p style="font-size: 1.1rem; margin: 0;">No teams registered yet. Be the first to create a team!</p>
            </div>
          </div>
        </div>

        <!-- Create Team Panel -->
        <div id="teams-panel-create" class="teams-subpanel" style="display: none;">
          <div style="max-width: 600px; margin: 0 auto;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <h3 style="margin: 0 0 0.5rem 0; color: #000; font-weight: 700; font-size: 1.5rem;">Create Your Team</h3>
              <p style="margin: 0 0 2rem 0; color: #666; line-height: 1.6;">Fill out the form below to register your team for the Spring 2026 tournament.</p>

              <form id="createTeamForm" onsubmit="handleCreateTeam(event)">
                <!-- Team Name -->
                <div style="margin-bottom: 1.5rem;">
                  <label for="teamName" style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600; font-size: 0.95rem;">Team Name *</label>
                  <input type="text" id="teamName" name="teamName" required
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;"
                    placeholder="Enter your team name" />
                </div>

                <!-- Captain Email -->
                <div style="margin-bottom: 1.5rem;">
                  <label for="captainEmail" style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600; font-size: 0.95rem;">Captain Email *</label>
                  <input type="email" id="captainEmail" name="captainEmail" required readonly
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: #f8f9fa; color: #666;"
                    placeholder="Sign in to auto-fill" />
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #666;">Auto-filled from your signed-in account</p>
                </div>

                <!-- Contact Information -->
                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; margin-bottom: 0.75rem; color: #000; font-weight: 600; font-size: 0.95rem;">Team Contact Information (Optional)</label>

                  <div style="margin-bottom: 0.75rem;">
                    <label for="instagramHandle" style="display: block; margin-bottom: 0.35rem; color: #666; font-size: 0.9rem;">Instagram Handle</label>
                    <input type="text" id="instagramHandle" name="instagramHandle"
                      style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                      placeholder="@username" />
                  </div>

                  <div style="margin-bottom: 0.75rem;">
                    <label for="groupmeLink" style="display: block; margin-bottom: 0.35rem; color: #666; font-size: 0.9rem;">GroupMe Contact</label>
                    <input type="text" id="groupmeLink" name="groupmeLink"
                      style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                      placeholder="https://groupme.com/join_group/..." />
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #666;">
                      Join the <a href="https://groupme.com/join_group/YOUR_IBA_GROUPME_LINK" target="_blank" style="color: #CFB991; text-decoration: none; font-weight: 600;">IBA GroupMe</a> for tournament updates
                    </p>
                  </div>

                  <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-top: 1rem;">
                    <p style="margin: 0; color: #856404; font-size: 0.85rem; line-height: 1.5;">
                      <strong>‚ö†Ô∏è Important:</strong> Teams are responsible for responding to messages from IBA staff in a timely manner. If a team fails to respond, IBA staff reserves the right to make decisions on behalf of the team.
                    </p>
                  </div>
                </div>

                <!-- Players -->
                <div style="margin-bottom: 2rem;">
                  <label style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600; font-size: 0.95rem;">Team Players (Up to 4 Players) *</label>
                  <p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #666;">Enter team member names. Captain is required, other positions are optional (maximum 4 players total).</p>

                  <div id="playersContainer">
                    <div style="margin-bottom: 0.75rem;">
                      <input type="text" name="player1" required
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                        placeholder="Captain Name *" />
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                      <input type="text" name="player2"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                        placeholder="Starter 1 Name (Optional)" />
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                      <input type="text" name="player3"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                        placeholder="Starter 2 Name (Optional)" />
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                      <input type="text" name="player4"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                        placeholder="Reserve Name (Optional)" />
                    </div>
                  </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #CFB991 0%, #A89968 100%); color: #000; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(207, 185, 145, 0.3);">
                  Create Team
                </button>
              </form>

              <div id="createTeamMessage" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none;"></div>
            </div>
          </div>
        </div>

        <!-- Free Agency Panel -->
        <div id="teams-panel-freeagency" class="teams-subpanel" style="display: none;">
          <!-- Join Free Agency Form (shown when signed in and no team) -->
          <div id="joinFreeAgencyForm" style="display: none; max-width: 600px; margin: 0 auto;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <h3 style="margin: 0 0 0.5rem 0; color: #000; font-weight: 700; font-size: 1.5rem;">Join Free Agency</h3>
              <p style="margin: 0 0 2rem 0; color: #666; line-height: 1.6;">Post your profile to let teams know you're looking to join!</p>

              <form id="freeAgencyForm" onsubmit="handleJoinFreeAgency(event)">
                <!-- Player Name -->
                <div style="margin-bottom: 1.5rem;">
                  <label for="freeAgencyName" style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600; font-size: 0.95rem;">Your Name *</label>
                  <input type="text" id="freeAgencyName" name="freeAgencyName" required readonly
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: #f8f9fa; color: #666;"
                    placeholder="Auto-filled from your account" />
                </div>

                <!-- Email -->
                <div style="margin-bottom: 1.5rem;">
                  <label for="freeAgencyEmail" style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600; font-size: 0.95rem;">Email *</label>
                  <input type="email" id="freeAgencyEmail" name="freeAgencyEmail" required readonly
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: #f8f9fa; color: #666;"
                    placeholder="Auto-filled from your account" />
                </div>

                <!-- Contact Info -->
                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; margin-bottom: 0.75rem; color: #000; font-weight: 600; font-size: 0.95rem;">Contact Information</label>

                  <div style="margin-bottom: 0.75rem;">
                    <label for="freeAgencyInstagram" style="display: block; margin-bottom: 0.35rem; color: #666; font-size: 0.9rem;">Instagram Handle</label>
                    <input type="text" id="freeAgencyInstagram" name="freeAgencyInstagram"
                      style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                      placeholder="@username" />
                  </div>

                  <div style="margin-bottom: 0.75rem;">
                    <label for="freeAgencyGroupme" style="display: block; margin-bottom: 0.35rem; color: #666; font-size: 0.9rem;">GroupMe Contact</label>
                    <input type="text" id="freeAgencyGroupme" name="freeAgencyGroupme"
                      style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                      placeholder="Your GroupMe username or link" />
                  </div>
                </div>

                <!-- Player Bio/Notes -->
                <div style="margin-bottom: 2rem;">
                  <label for="freeAgencyNotes" style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600; font-size: 0.95rem;">About You (Optional)</label>
                  <textarea id="freeAgencyNotes" name="freeAgencyNotes" rows="4"
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;"
                    placeholder="Tell teams about your playing style, experience, availability, or anything else that might help them contact you..."></textarea>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #666;">This helps teams find players that fit their style!</p>
                </div>

                <!-- Submit Button -->
                <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #CFB991 0%, #A89968 100%); color: #000; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(207, 185, 145, 0.3);">
                  Join Free Agency
                </button>
              </form>

              <div id="freeAgencyMessage" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none;"></div>
            </div>
          </div>

          <!-- Free Agents List (shown for all users) -->
          <div id="freeAgentsList" style="max-width: 800px; margin: 0 auto;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.5rem;">
              <h3 style="margin: 0 0 1rem 0; color: #000; font-weight: 700; font-size: 1.5rem;">Free Agents</h3>
              <p style="margin: 0 0 1rem 0; color: #666; line-height: 1.6;">Players looking for teams</p>
            </div>
            <div id="freeAgentsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
              <!-- Free agents will be loaded here -->
              <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #999;">
                <p style="font-size: 1.1rem; margin: 0;">No players in free agency yet. Be the first!</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-bracket" class="tabpanel" role="tabpanel" aria-labelledby="tab-bracket">
        <button class="add-game-btn" id="bulkImportBracketBtn" style="display: none;">üì• Bulk Import Bracket</button>

        <!-- Black Bracket -->
        <h2 style="color: #1a1a1a; font-size: 1.75rem; margin: 2rem 0 1rem 0; text-align: center; font-weight: 700;">‚ö´ Black Bracket</h2>
        <div style="overflow-x: auto;">
          <div class="bracket-container">
            <!-- Round of 16 -->
            <div class="bracket-round">
              <div class="bracket-round-title">Round of 16</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-1-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-1-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-1-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-1-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-2-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-2-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-2-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-2-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-3-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-3-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-3-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-3-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-4-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-4-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-4-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-4-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-5-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-5-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-5-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-5-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-6-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-6-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-6-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-6-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-7-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-7-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-7-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-7-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-r16-8-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-8-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-r16-8-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-r16-8-2')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Quarterfinals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Quarterfinals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-qf-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-qf-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-qf-3">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-3')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-qf-4">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-4')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-qf-5">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-5')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-qf-6">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-6')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-qf-7">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-7')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-qf-8">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-qf-8')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Semifinals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Semifinals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-sf-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-sf-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-sf-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-sf-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-sf-3">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-sf-3')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-sf-4">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-sf-4')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Finals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Finals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="black-f-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-f-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="black-f-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-f-2')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Champion -->
            <div class="bracket-round">
              <div class="bracket-round-title">Champion</div>
              <div class="bracket-match">
                <div class="bracket-team champion" data-slot="black-champion">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('black-champion')">Edit</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Gold Bracket -->
        <h2 style="color: #d4af37; font-size: 1.75rem; margin: 3rem 0 1rem 0; text-align: center; font-weight: 700;">üü° Gold Bracket</h2>
        <div style="overflow-x: auto;">
          <div class="bracket-container">
            <!-- Round of 16 -->
            <div class="bracket-round">
              <div class="bracket-round-title">Round of 16</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-1-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-1-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-1-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-1-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-2-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-2-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-2-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-2-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-3-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-3-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-3-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-3-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-4-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-4-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-4-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-4-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-5-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-5-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-5-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-5-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-6-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-6-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-6-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-6-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-7-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-7-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-7-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-7-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-r16-8-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-8-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-r16-8-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-r16-8-2')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Quarterfinals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Quarterfinals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-qf-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-qf-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-qf-3">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-3')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-qf-4">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-4')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-qf-5">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-5')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-qf-6">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-6')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-qf-7">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-7')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-qf-8">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-qf-8')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Semifinals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Semifinals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-sf-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-sf-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-sf-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-sf-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-sf-3">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-sf-3')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-sf-4">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-sf-4')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Finals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Finals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="gold-f-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-f-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="gold-f-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-f-2')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Champion -->
            <div class="bracket-round">
              <div class="bracket-round-title">Champion</div>
              <div class="bracket-match">
                <div class="bracket-team champion" data-slot="gold-champion">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('gold-champion')">Edit</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Previous Tournaments panel - Hidden for future use -->
      <!--
      <section id="panel-previous" class="tabpanel" role="tabpanel" aria-labelledby="tab-previous">
        <h2 style="color: var(--brand); margin-bottom: 1.5rem;">Previous Tournaments</h2>

        <div style="margin-bottom: 2rem;">
          <label for="tournamentSelect" style="font-weight: 600; color: #222; margin-bottom: 0.5rem; display: block;">Select Tournament:</label>
          <select id="tournamentSelect" class="select" style="max-width: 300px;">
            <option value="">Choose a tournament...</option>
            <option value="fall-2025">Fall 2025</option>
          </select>
        </div>

        <div id="previousTournamentData" style="display: none;">
          <div style="margin-bottom: 2rem;">
            <h3 id="selectedTournamentTitle" style="color: var(--brand); margin-bottom: 1rem;"></h3>

            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
              <div class="stat-box">
                <div class="label">Champion</div>
                <div class="value" id="prevChampion" style="font-size: 1.5rem;">-</div>
              </div>
              <div class="stat-box">
                <div class="label">Total Teams</div>
                <div class="value" id="prevTotalTeams">-</div>
              </div>
              <div class="stat-box">
                <div class="label">Total Games</div>
                <div class="value" id="prevTotalGames">-</div>
              </div>
              <div class="stat-box">
                <div class="label">Total Players</div>
                <div class="value" id="prevTotalPlayers">-</div>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <button class="prev-view-btn active" data-view="standings" style="padding: 0.5rem 1rem; border: none; background: var(--brand); color: #000; border-radius: 4px; cursor: pointer; font-weight: 600;">Final Standings</button>
            <button class="prev-view-btn" data-view="bracket" style="padding: 0.5rem 1rem; border: none; background: #f5f1e8; color: #222; border-radius: 4px; cursor: pointer; font-weight: 600;">Bracket</button>
            <button class="prev-view-btn" data-view="schedule" style="padding: 0.5rem 1rem; border: none; background: #f5f1e8; color: #222; border-radius: 4px; cursor: pointer; font-weight: 600;">Schedule</button>
          </div>

          <div id="prevStandingsView" class="prev-view">
            <h3 style="margin-bottom: 1rem;">Final Standings</h3>
            <div class="grid" id="prevTeamsGrid">
            </div>
          </div>

          <div id="prevBracketView" class="prev-view" style="display: none;">
            <h3 style="margin-bottom: 1rem;">Tournament Bracket</h3>
            <div style="overflow-x: auto;">
              <div class="bracket-container" id="prevBracketContainer">
              </div>
            </div>
          </div>

          <div id="prevScheduleView" class="prev-view" style="display: none;">
            <h3 style="margin-bottom: 1rem;">Game Schedule</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Teams</th>
                    <th>Time</th>
                    <th>Court</th>
                    <th>Round</th>
                    <th>Result</th>
                  </tr>
                </thead>
                <tbody id="prevScheduleTable">
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="noTournamentSelected" style="text-align: center; padding: 3rem; color: var(--muted);">
          <p>Select a tournament from the dropdown above to view its data.</p>
        </div>
      </section>
      -->

      <section id="panel-myteams" class="tabpanel" role="tabpanel" aria-labelledby="tab-myteams">
        <div style="margin-bottom: 2rem;">
          <h2 style="color: var(--brand); margin-bottom: 1rem;">My Teams</h2>

          <div id="playerTeamSection" style="margin-bottom: 2rem;">
            <div id="myTeamDisplay" style="display: none;">
              <h3>Your Team</h3>
              <div id="myTeamCard" class="team-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem;">
                <!-- Team info will be populated here -->
              </div>
            </div>

            <div id="noTeamDisplay">
              <button id="createTeamBtn" class="admin-submit" style="margin-right: 1rem;">+ Create New Team</button>
              <p style="color: var(--muted); margin-top: 1rem;">Or browse teams below to request to join</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Admin Requests Panel -->
      <section id="panel-adminrequests" class="tabpanel" role="tabpanel" aria-labelledby="tab-adminrequests">
        <div style="margin-bottom: 2rem;">
          <h2 style="color: var(--brand); margin-bottom: 1rem;">Admin Access Requests</h2>
          <p style="color: var(--muted); margin-bottom: 2rem;">Review and manage admin access requests from users.</p>

          <!-- Filter buttons -->
          <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            <button id="filterAll" class="admin-submit" style="padding: 0.5rem 1rem;">All Requests</button>
            <button id="filterPending" class="admin-submit" style="padding: 0.5rem 1rem; background: #f39c12;">Pending</button>
            <button id="filterApproved" class="admin-submit" style="padding: 0.5rem 1rem; background: var(--success);">Approved</button>
            <button id="filterRejected" class="admin-submit" style="padding: 0.5rem 1rem; background: #e74c3c;">Rejected</button>
          </div>

          <!-- Requests container -->
          <div id="adminRequestsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            <!-- Admin requests will be populated here -->
          </div>

          <div id="noRequestsMessage" style="display: none; text-align: center; padding: 3rem; color: var(--muted);">
            <p style="font-size: 1.1rem;">No admin requests found.</p>
          </div>
        </div>
      </section>

      <section id="panel-faq" class="tabpanel" role="tabpanel" aria-labelledby="tab-faq">
        <div class="faq">
          <details>
            <summary>How many players are allowed per team?</summary>
            <p>Each team may have up to 4 players on the roster.</p>
          </details>
          <details>
            <summary>Who is eligible to participate?</summary>
            <p>All currently enrolled Purdue University students are eligible to play. Valid student ID may be required.</p>
          </details>
          <details>
            <summary>What is the registration fee?</summary>
            <p>The registration fee is $5 per person, paid at the time of team registration.</p>
          </details>
          <details>
            <summary>How long are games?</summary>
            <p>Each game is 30 minutes in length.</p>
          </details>
          <details>
            <summary>How do I know what jersey colors to wear?</summary>
            <p>Teams listed on the right side of the schedule wear white jerseys, while teams on the left wear black. We will also send reminders before each game.</p>
          </details>
          <details>
            <summary>Will there be referees and scorekeepers?</summary>
            <p>Yes, all games will have referees officiating and a dedicated scorekeeper tracking the game.</p>
          </details>
          <details>
            <summary>Is there a penalty for arriving late?</summary>
            <p>Yes. Teams arriving late will be penalized one point per minute for the opposing team. Please arrive at least 10 minutes before your scheduled game time.</p>
          </details>
          <details>
            <summary>What happens if my team wears incorrect jersey colors?</summary>
            <p>Teams wearing incorrect jersey colors will be assessed a penalty of one free throw per violation for the opposing team.</p>
          </details>
          <details>
            <summary>What if we cannot make it to our scheduled game?</summary>
            <p>If your team cannot attend, you may forfeit the game or contact the opposing team directly to request a reschedule. Please provide as much advance notice as possible.</p>
          </details>
          <details>
            <summary>Where are games played?</summary>
            <p>All games are held at the France A. C√≥rdova Recreational Sports Center. The specific court assignment for each game is listed in the schedule.</p>
          </details>
        </div>
      </section>

      <section id="panel-contact" class="tabpanel" role="tabpanel" aria-labelledby="tab-contact">
        <div class="faq" style="max-width: 700px;">
          <h2 style="color: var(--brand); margin-top: 0;">Get in Touch</h2>
          <p style="color: var(--muted); margin-bottom: 2rem;">Have a question or need assistance? Send us a message and we'll get back to you as soon as possible.</p>

          <form id="contactForm" style="display: flex; flex-direction: column; gap: 1.25rem;">
            <div class="form-group">
              <label style="display: block; color: var(--text); font-weight: 600; margin-bottom: 0.5rem;">Your Contact Info</label>
              <input
                type="text"
                id="contactInfo"
                class="input"
                placeholder="Instagram username, GroupMe name, phone number, or email"
                required
                style="width: 100%; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 10px; font-size: 1rem;"
              />
              <p style="color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem;">We'll use this to respond to your message</p>
            </div>

            <div class="form-group">
              <label style="display: block; color: var(--text); font-weight: 600; margin-bottom: 0.5rem;">Message</label>
              <textarea
                id="contactMessage"
                class="input"
                placeholder="Type your message here..."
                required
                rows="6"
                style="width: 100%; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 10px; font-size: 1rem; resize: vertical; font-family: inherit;"
              ></textarea>
            </div>

            <div id="contactStatus" style="display: none; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;"></div>

            <button
              type="submit"
              id="contactSubmit"
              style="background: var(--brand); color: #0b0f1a; border: none; padding: 0.85rem 1.5rem; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s ease;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 157, 0, 0.4)';"
              onmouseout="this.style.transform=''; this.style.boxShadow='';"
            >
              Send Message
            </button>
          </form>
        </div>
      </section>

      <section id="panel-signup" class="tabpanel" role="tabpanel" aria-labelledby="tab-signup">
        <div style="max-width: 900px; margin: 0 auto;">
          <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; background: linear-gradient(90deg, var(--brand), var(--brand-2)); background-clip: text; -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">
            üèÄ IBA Spring 2026 Tournament ‚Äî Applications Open!
          </h2>

          <div style="background: linear-gradient(135deg, #f8f5f0, #faf7f2); border: 2px solid var(--brand); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(207, 185, 145, 0.15);">
            <p style="color: #0a1122; margin: 0 0 0.75rem 0; font-size: 1rem; line-height: 1.6;">
              <strong style="color: var(--brand);">üìÖ Date:</strong> TBD (Spring 2026)
            </p>
            <p style="color: #0a1122; margin: 0 0 1.25rem 0; font-size: 1rem; line-height: 1.6;">
              <strong style="color: var(--brand);">üïê Time:</strong> TBD
            </p>

            <p style="color: #0a1122; margin: 0 0 1.25rem 0; font-size: 1rem; line-height: 1.6;">
              We're hosting a <strong>basketball tournament with a 3-game regular season</strong> with <strong>32 teams (no higher or lower)</strong> ‚Äî so spread the word and get your squad ready!
            </p>

            <p style="color: #0a1122; margin: 0 0 0.5rem 0; font-size: 1rem; line-height: 1.6;">
              <strong style="color: var(--brand);">üí∞ Entry Fee:</strong> $5 per player
            </p>

            <p style="color: #0a1122; margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600;">
              üèÜ Prizes:
            </p>
            <ul style="color: #0a1122; margin: 0 0 1.25rem 0; padding-left: 2rem; line-height: 1.8;">
              <li>‚ö´ <strong>Black Division Winner</strong> ‚Äî $150</li>
              <li>üü° <strong style="color: #CFB991;">Gold Division Winner</strong> ‚Äî $150</li>
            </ul>

            <p style="color: #0a1122; margin: 0 0 1.25rem 0; font-size: 1rem; line-height: 1.6;">
              If you're interested in participating, <strong>sign up ASAP</strong> so we can lock in the bracket.
            </p>

            <div style="background: rgba(207, 185, 145, 0.2); border-left: 4px solid var(--brand); padding: 1rem; border-radius: 6px; margin-top: 1.5rem;">
              <p style="color: #0a1122; margin: 0 0 0.5rem 0; font-size: 0.95rem; line-height: 1.6;">
                <strong>‚ö†Ô∏è Important:</strong> Payment information will be sent out once the tournament is confirmed.
              </p>
              <p style="color: #0a1122; margin: 0 0 0.5rem 0; font-size: 0.95rem; line-height: 1.6;">
                Signing up now does <strong>not guarantee a spot</strong> in the tournament. Only teams that complete payment will be playing.
              </p>
              <p style="color: #0a1122; margin: 0; font-size: 0.95rem; line-height: 1.6;">
                <strong>Fairness Policy:</strong> IBA reserves the right to ask teams to divide up their players to promote fairness, especially concerning any players that currently or formerly have played basketball at any level above high school basketball.
              </p>
            </div>
          </div>

          <!-- User's Current Submission Status -->
          <div id="userSubmissionStatus" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f8f5f0, #faf7f2); border: 2px solid var(--brand); border-radius: 12px; box-shadow: 0 4px 20px rgba(207, 185, 145, 0.15);">
            <h3 style="color: #0a1122; margin: 0 0 1rem 0; font-size: 1.2rem; font-weight: 700; border-bottom: 2px solid var(--brand); padding-bottom: 0.5rem;">Your Submission</h3>
            <div id="submissionDetails" style="color: #0a1122;"></div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
              <button id="editSubmissionBtn" style="flex: 1; padding: 0.75rem; background: var(--brand); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Edit Submission</button>
              <button id="withdrawSubmissionBtn" style="flex: 1; padding: 0.75rem; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Withdraw</button>
            </div>
          </div>

          <!-- Admin View All Submissions Button -->
          <div id="adminSubmissionsBtn" style="display: none; margin-bottom: 2rem;">
            <button onclick="showAllSubmissions()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: #000; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
              üëë View All Tournament Submissions (Admin)
            </button>
          </div>

          <!-- Tournament Entry Form -->
          <div id="tournamentEntryForm" style="background: linear-gradient(135deg, #f8f5f0, #faf7f2); padding: 2rem; border-radius: 12px; border: 2px solid var(--brand); box-shadow: 0 4px 20px rgba(207, 185, 145, 0.15);">
            <form id="springTournamentForm">
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Team Name *</label>
                <input type="text" id="tournamentTeamName" required placeholder="Enter your team name"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Captain Name *</label>
                <input type="text" id="tournamentCaptainName" required placeholder="Enter captain's name"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Captain Email *</label>
                <input type="email" id="tournamentCaptainEmail" required placeholder="Enter captain's email"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Captain Instagram (Optional)</label>
                <input type="text" id="tournamentCaptainPhone" placeholder="@username"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Captain Name *</label>
                <input type="text" id="tournamentPlayer1" required placeholder="Enter captain name"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Starter 1 Name *</label>
                <input type="text" id="tournamentPlayer2" required placeholder="Enter starter 1 name"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Starter 2 Name (Optional)</label>
                <input type="text" id="tournamentPlayer3" placeholder="Enter starter 2 name (optional)"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'" />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #0a1122; font-weight: 600; margin-bottom: 0.5rem;">Additional Notes (Optional)</label>
                <textarea id="tournamentNotes" rows="3" placeholder="Any additional information"
                  style="width: 100%; padding: 0.75rem; background: #ffffff; border: 2px solid rgba(207, 185, 145, 0.4); border-radius: 8px; color: #0a1122; font-size: 1rem; resize: vertical; transition: all 0.2s;"
                  onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='0 0 0 3px rgba(207, 185, 145, 0.1)'"
                  onblur="this.style.borderColor='rgba(207, 185, 145, 0.4)'; this.style.boxShadow='none'"></textarea>
              </div>

              <button type="submit" id="submitTournamentBtn"
                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--brand), #d4be9c); color: #000; font-weight: 700; font-size: 1.1rem; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(207, 185, 145, 0.3);"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(207, 185, 145, 0.4)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(207, 185, 145, 0.3)'">
                Submit Tournament Entry
              </button>
            </form>
          </div>
        </div>
      </section>
    </main>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2>üì¨ Notifications</h2>
          <button class="modal-close" id="closeNotifications">&times;</button>
        </div>
        <div id="notificationsContent" style="max-height: 500px; overflow-y: auto;">
          <!-- Notifications will be populated here -->
        </div>
      </div>
    </div>

    <!-- Team Detail Modal -->
    <div id="teamModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTeamName">Team Name</h2>
          <button class="close-btn" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="stats-grid">
            <div class="stat-box">
              <div class="label">Record</div>
              <div class="value" id="teamRecord">0-0</div>
            </div>
            <div class="stat-box">
              <div class="label">Point Differential</div>
              <div class="value" id="teamDiff">+0</div>
            </div>
            <div class="stat-box">
              <div class="label">Seed</div>
              <div class="value" id="teamSeedDisplay">-</div>
            </div>
          </div>

          <h3 class="section-title">Roster</h3>
          <ul class="roster-list" id="rosterList">
            <!-- Roster items populated by JS -->
          </ul>

          <h3 class="section-title">Completed Games</h3>
          <div id="completedGames">
            <!-- Game items populated by JS -->
          </div>

          <h3 class="section-title">Upcoming Games</h3>
          <div id="upcomingGames">
            <!-- Game items populated by JS -->
          </div>
        </div>
      </div>
    </div>

    <footer>
      ¬© <span id="y"></span> IBA ‚Äî Questions? DM us on Instagram <a href="https://www.instagram.com/iba_purdue/" target="_blank" rel="noopener noreferrer" style="color: var(--text); text-decoration: underline;">@iba_purdue</a> or email <a href="mailto:ibapurdue@gmail.com" style="color: var(--text); text-decoration: underline;">ibapurdue@gmail.com</a>
    </footer>

    <!-- Profile Modal -->
    <div id="profileModal" class="admin-modal" style="display: none;">
      <div class="admin-modal-content" style="max-width: 500px;">
        <h3>My Profile</h3>

        <div style="text-align: center; margin: 2rem 0;">
          <img id="profileAvatar" src="" alt="Profile Avatar" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--brand); object-fit: cover;" />
        </div>

        <div style="margin: 1.5rem 0;">
          <label style="display: block; color: var(--muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Username</label>
          <div id="profileUsername" style="padding: 0.75rem; background: #0a1122; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;"></div>
        </div>

        <div style="margin: 1.5rem 0;">
          <label style="display: block; color: var(--muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Email</label>
          <div id="profileEmail" style="padding: 0.75rem; background: #0a1122; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;"></div>
        </div>

        <div style="margin: 1.5rem 0;">
          <label style="display: block; color: var(--muted); font-size: 0.85rem; margin-bottom: 0.5rem;">My Team</label>
          <div id="profileTeam" style="padding: 0.75rem; background: #0a1122; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;">No team yet</div>
        </div>

        <!-- Admin Access Section -->
        <div id="adminAccessSection" style="display: none; margin: 1.5rem 0; padding: 1rem; background: #0a1122; border: 1px solid var(--border); border-radius: 8px;">
          <label style="display: block; color: var(--muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Admin Access</label>
          <div id="adminRequestStatus" style="color: var(--text); font-size: 0.9rem; margin-bottom: 1rem;">
            You don't have admin privileges.
          </div>
          <button type="button" class="admin-submit" id="requestAdminBtn" style="width: 100%; background: var(--brand);">
            Request Admin Access
          </button>
        </div>

        <div class="admin-buttons" style="margin-top: 2rem;">
          <button type="button" class="admin-submit" id="profileCloseBtn" style="width: 100%;">Close</button>
        </div>
      </div>
    </div>

    <!-- Admin button -->
    <button class="admin-btn" id="adminBtn">Admin</button>

    <!-- Admin login modal -->
    <div id="adminModal" class="admin-modal">
      <div class="admin-modal-content">
        <h3>Admin Access</h3>
        <div class="admin-error" id="adminError" style="display: none;">Authentication failed</div>

        <!-- Logged In View -->
        <div id="adminLoggedInView" style="display: none;">
          <div style="text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Signed in as:</p>
            <p id="adminCurrentEmail" style="color: var(--brand); font-weight: 600; font-size: 1rem;"></p>
          </div>

          <!-- Admin Verification (shown only if user is registered admin) -->
          <div id="adminVerificationSection" style="display: none;">
            <p style="color: var(--muted); text-align: center; margin-bottom: 1.5rem;">Choose your authentication method</p>

            <!-- Email/Password Login -->
            <div style="margin-bottom: 1rem;">
              <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text);">Password</label>
                <input type="password" id="adminPassword" placeholder="Enter your password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: #222; font-size: 1rem;" />
              </div>
              <button class="admin-submit" id="adminEmailPasswordBtn" style="width: 100%; margin-bottom: 1rem;">üîë Login with Password</button>
            </div>

            <div style="text-align: center; margin: 1rem 0; color: var(--muted); font-size: 0.9rem;">
              <span style="display: inline-block; position: relative;">
                <span style="position: relative; z-index: 1; background: #fff; padding: 0 1rem;">OR</span>
                <span style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border);"></span>
              </span>
            </div>

            <!-- Biometric Login Button -->
            <button class="admin-submit" id="adminBiometricBtn" style="width: 100%; margin-bottom: 1rem;">üîê Use Touch ID / Face ID</button>
          </div>

          <!-- Request Admin Access (shown if user is NOT admin) -->
          <div id="adminRequestSection" style="display: none;">
            <p style="color: var(--muted); text-align: center; margin-bottom: 1.5rem;">You don't have admin access yet. Request access below:</p>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text);">Your Name</label>
              <input type="text" id="requestAdminName" placeholder="Enter your full name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: #222; font-size: 1rem;" />
            </div>

            <button class="admin-submit" id="submitAdminRequestBtn" style="width: 100%; margin-bottom: 1rem;">üìù Submit Request</button>
          </div>

          <div class="admin-buttons">
            <button class="admin-cancel" id="adminCancel">Cancel</button>
          </div>
        </div>

        <!-- Not Logged In View -->
        <div id="adminNotLoggedInView" style="display: none;">
          <p style="color: var(--muted); text-align: center; margin-bottom: 1.5rem;">Please sign in first to access admin features</p>
          <a href="login.html" class="admin-submit" style="display: block; width: 100%; text-align: center; text-decoration: none; padding: 0.75rem;">Sign In</a>
          <div class="admin-buttons">
            <button class="admin-cancel" id="adminCancelNotLoggedIn">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit/Add game modal -->
    <div id="editGameModal" class="edit-game-modal">
      <div class="edit-game-content">
        <h3 id="editGameTitle">Edit Game</h3>
        <form id="gameForm">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="gameDate" required />
          </div>
          <div class="form-group">
            <label>Day</label>
            <select id="gameDay" required>
              <option value="">Select day...</option>
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </select>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" id="gameTime" placeholder="e.g. 6:00 PM" required />
          </div>
          <div class="form-group">
            <label>Matchup</label>
            <input type="text" id="gameMatchup" placeholder="e.g. Team A vs Team B" required />
          </div>
          <div class="form-group">
            <label>Court</label>
            <select id="gameCourt" required>
              <option value="">Select court...</option>
              <option value="Black and Gold Court 1">Black and Gold Court 1</option>
              <option value="Black and Gold Court 2">Black and Gold Court 2</option>
              <option value="Black and Gold Court 3">Black and Gold Court 3</option>
              <option value="Black and Gold Court 4">Black and Gold Court 4</option>
              <option value="Black and Gold Court 5">Black and Gold Court 5</option>
              <option value="Black and Gold Court 6">Black and Gold Court 6</option>
              <option value="Upper Court 1">Upper Court 1</option>
              <option value="Upper Court 2">Upper Court 2</option>
              <option value="Upper Court 3">Upper Court 3</option>
            </select>
          </div>
          <div class="form-group">
            <label>Round</label>
            <input type="text" id="gameRound" placeholder="e.g. Round of 16" required />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="gameStatus" required>
              <option value="Scheduled">Scheduled</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="TBD">TBD</option>
            </select>
          </div>
          <div class="admin-buttons">
            <button type="button" class="admin-cancel" id="cancelEdit">Cancel</button>
            <button type="submit" class="admin-submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bulk Import Bracket Modal -->
    <div id="bulkImportModal" class="edit-game-modal">
      <div class="edit-game-content" style="max-width: 700px;">
        <h3>Bulk Import Bracket</h3>
        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
          Paste your bracket data in JSON format. This will replace all existing bracket data.
        </p>
        <textarea id="bulkBracketData" style="width: 100%; min-height: 400px; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.85rem; background: var(--card); color: var(--text);" placeholder='Example format:
{
  "r16-1-1": "Slam Squad",
  "r16-1-2": "Phoenix",
  "r16-2-1": "Panthers",
  "r16-2-2": "KOS",
  ...
}'></textarea>
        <div class="admin-buttons" style="margin-top: 1rem;">
          <button type="button" class="admin-cancel" id="cancelBulkImport">Cancel</button>
          <button type="button" class="admin-submit" id="submitBulkImport">Import Bracket</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Wait for Firebase to be available
    function waitForFirebase(callback) {
      if (window.db && window.firestoreImports) {
        callback();
      } else {
        setTimeout(() => waitForFirebase(callback), 100);
      }
    }

    // ============================================
    // Google Sign-In Function for Non-Authenticated Users
    // ============================================
    function signInWithGoogle() {
      // Use waitForFirebase to ensure Firebase is ready before proceeding
      waitForFirebase(async () => {
        try {
          console.log('üî• Firebase ready, starting sign-in...');

          // Import GoogleAuthProvider and signInWithPopup from Firebase
          const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

          const provider = new GoogleAuthProvider();
          const result = await signInWithPopup(window.auth, provider);
          const user = result.user;

          console.log('‚úÖ Signed in successfully:', user.email);

          // Check if user document exists, create if not
          const { doc, getDoc, setDoc, updateDoc } = window.firestoreImports;
          const userDocRef = doc(window.db, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);

          if (!userDoc.exists()) {
            // Create user document
            await setDoc(userDocRef, {
              email: user.email,
              displayName: user.displayName || user.email.split('@')[0],
              photoURL: user.photoURL || '',
              roles: ['player'],
              createdAt: new Date().toISOString(),
              lastLogin: new Date().toISOString()
            });
            console.log('‚úÖ Created user document');
          } else {
            // Update last login
            await updateDoc(userDocRef, {
              lastLogin: new Date().toISOString()
            });
          }

          // onAuthStateChanged will handle UI updates automatically

        } catch (error) {
          console.error('‚ùå Error signing in:', error);
          if (error.code === 'auth/popup-closed-by-user') {
            console.log('User closed the sign-in popup');
          } else if (error.code === 'auth/cancelled-popup-request') {
            console.log('Another popup already open');
          } else {
            alert('Error signing in. Please try again.');
          }
        }
      });
    }

    // Make signInWithGoogle available globally
    window.signInWithGoogle = signInWithGoogle;

    // Hero button click handler is set dynamically in the auth state listener
    // based on whether user is signed in or not

    // ============================================
    // Teams Tab Functions
    // ============================================

    // Switch between teams sub-tabs
    window.switchTeamsTab = function(tab) {
      // Update button states
      document.querySelectorAll('.teams-subtab').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`teams-subtab-${tab}`).classList.add('active');

      // Show/hide panels
      document.querySelectorAll('.teams-subpanel').forEach(panel => {
        panel.style.display = 'none';
      });
      document.getElementById(`teams-panel-${tab}`).style.display = 'block';
    };

    // Helper function to switch to Teams tab and specific sub-tab from navigation
    window.switchToTeamsTab = function(subtab) {
      console.log('switchToTeamsTab called with:', subtab);

      // First, switch to the Teams main tab
      const teamsTab = document.getElementById('tab-teams');
      if (teamsTab) {
        console.log('Clicking teams tab');
        teamsTab.click();
      } else {
        console.error('Teams tab not found');
      }

      // Then switch to the specific sub-tab after a delay
      setTimeout(() => {
        console.log('Switching to subtab:', subtab);
        switchTeamsTab(subtab);

        // Scroll to the Teams section
        const teamsPanel = document.getElementById('panel-teams');
        if (teamsPanel) {
          console.log('Scrolling to Teams panel');
          teamsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Close mobile navigation AFTER switching
        const cardNav = document.getElementById('cardNav');
        if (cardNav && cardNav.classList.contains('open')) {
          console.log('Closing mobile nav');
          cardNav.classList.remove('open');
        }
      }, 200);
    };

    // Handle create team form submission
    window.handleCreateTeam = async function(event) {
      event.preventDefault();

      const messageDiv = document.getElementById('createTeamMessage');
      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating Team...';

        const user = window.auth?.currentUser;
        if (!user) {
          throw new Error('You must be signed in to create a team');
        }

        // Collect player names
        const players = [];
        for (let i = 1; i <= 4; i++) {
          const playerName = form[`player${i}`].value.trim();
          if (playerName) {
            players.push(playerName);
          }
        }

        if (players.length < 1) {
          throw new Error('Please add at least the captain');
        }

        // Create team document
        const teamData = {
          teamName: form.teamName.value.trim(),
          captainName: user.displayName || user.email.split('@')[0],
          captainEmail: form.captainEmail.value.trim(),
          captainUid: user.uid,
          instagram: form.instagramHandle.value.trim() || '',
          groupme: form.groupmeLink.value.trim() || '',
          players: players,
          createdAt: new Date().toISOString(),
          tournament: 'spring-2026',
          status: 'active'
        };

        const { collection, addDoc, doc, setDoc, query, where, getDocs, updateDoc } = window.firestoreImports;

        // Add team to teams collection
        const teamRef = await addDoc(collection(window.db, 'teams'), teamData);

        // Update user document with team reference
        const userDocRef = doc(window.db, 'users', user.uid);
        await setDoc(userDocRef, {
          teamId: teamRef.id,
          teamName: teamData.teamName,
          isCaptain: true
        }, { merge: true });

        // Remove user from free agency if they're in it
        const freeAgentsQuery = query(
          collection(window.db, 'freeAgents'),
          where('uid', '==', user.uid),
          where('status', '==', 'active')
        );
        const freeAgentsSnapshot = await getDocs(freeAgentsQuery);
        freeAgentsSnapshot.forEach(async (docSnapshot) => {
          await updateDoc(doc(window.db, 'freeAgents', docSnapshot.id), {
            status: 'inactive'
          });
        });

        // Show success message
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
        messageDiv.style.color = '#155724';
        messageDiv.innerHTML = `
          <strong>Success!</strong> Your team "${teamData.teamName}" has been created.
          <br>Refresh the page to see your team in "My Team".
        `;

        // Reset form
        form.reset();

        // Reload user team to show "My Team" panel
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        console.error('Error creating team:', error);
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;

        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Team';
      }
    };

    // Load user's team if they have one
    window.loadUserTeam = async function(user) {
      if (!user) return;

      try {
        const { doc, getDoc, updateDoc } = window.firestoreImports;
        const userDocRef = doc(window.db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists() && userDoc.data().teamId) {
          const userData = userDoc.data();

          // Get full team data first to verify team exists
          const teamDocRef = doc(window.db, 'teams', userData.teamId);
          const teamDoc = await getDoc(teamDocRef);

          if (teamDoc.exists()) {
            // Team exists - change "Create Team" to "My Team"
            const createBtn = document.getElementById('teams-subtab-create');
            if (createBtn) {
              createBtn.textContent = 'My Team';
            }

            // Also update navigation dropdown link
            const navCreateLink = document.getElementById('navCreateTeamLink');
            if (navCreateLink) {
              navCreateLink.innerHTML = '<span>‚Üí</span> My Team';
            }
            const teamData = teamDoc.data();

            // Replace create team panel with my team panel
            const createPanel = document.getElementById('teams-panel-create');
            if (createPanel) {
              createPanel.innerHTML = `
                <div style="max-width: 700px; margin: 0 auto;">
                  <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <!-- Team Name Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                      <div style="flex: 1;">
                        <h3 id="displayTeamName" style="margin: 0; color: #000; font-weight: 700; font-size: 1.5rem;">${teamData.teamName}</h3>
                        <div id="editTeamNameForm" style="display: none;">
                          <input type="text" id="editTeamNameInput" value="${teamData.teamName}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1.1rem; font-weight: 700;" />
                          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button onclick="saveTeamName('${userData.teamId}')" style="padding: 0.5rem 1rem; background: #CFB991; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Save</button>
                            <button onclick="cancelEditTeamName()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Cancel</button>
                          </div>
                        </div>
                      </div>
                      <button id="editTeamNameBtn" onclick="showEditTeamName()" style="padding: 0.5rem 1rem; background: #f8f9fa; color: #000; border: 1px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer; margin-left: 1rem;">Edit Name</button>
                    </div>

                    <!-- Team Info Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #000; font-weight: 700;">Team Information</h4>
                        <button id="editContactBtn" onclick="showEditContact()" style="padding: 0.5rem 1rem; background: #f8f9fa; color: #000; border: 1px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">Edit Contact</button>
                      </div>

                      <!-- Display Mode -->
                      <div id="displayContact">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                          <div>
                            <p style="margin: 0 0 0.25rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">Captain Email</p>
                            <p style="margin: 0; color: #000;">${teamData.captainEmail}</p>
                          </div>
                          <div>
                            <p style="margin: 0 0 0.25rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">Tournament</p>
                            <p style="margin: 0; color: #000;">Spring 2026</p>
                          </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                          <div>
                            <p style="margin: 0 0 0.25rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">Instagram</p>
                            <p style="margin: 0; color: #000;">${teamData.instagram || 'Not provided'}</p>
                          </div>
                          <div>
                            <p style="margin: 0 0 0.25rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">GroupMe</p>
                            <p style="margin: 0; color: #000;">${teamData.groupme ? '<a href="' + teamData.groupme + '" target="_blank" style="color: #CFB991; text-decoration: none;">Link</a>' : 'Not provided'}</p>
                          </div>
                        </div>
                      </div>

                      <!-- Edit Mode -->
                      <div id="editContactForm" style="display: none;">
                        <div style="margin-bottom: 0.75rem;">
                          <label style="display: block; margin-bottom: 0.35rem; color: #666; font-size: 0.9rem;">Instagram Handle</label>
                          <input type="text" id="editInstagram" value="${teamData.instagram || ''}" placeholder="@teamhandle" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" />
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                          <label style="display: block; margin-bottom: 0.35rem; color: #666; font-size: 0.9rem;">GroupMe Link</label>
                          <input type="text" id="editGroupme" value="${teamData.groupme || ''}" placeholder="https://groupme.com/join_group/..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" />
                        </div>
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">
                          <p style="margin: 0; color: #856404; font-size: 0.85rem; line-height: 1.5;">
                            <strong>‚ö†Ô∏è Important:</strong> Teams are responsible for responding to messages from IBA staff in a timely manner. If a team fails to respond, IBA staff reserves the right to make decisions on behalf of the team.
                          </p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                          <button onclick="saveContact('${userData.teamId}')" style="padding: 0.5rem 1rem; background: #CFB991; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Save</button>
                          <button onclick="cancelEditContact()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Cancel</button>
                        </div>
                      </div>
                    </div>

                    <!-- Roster Section -->
                    <div style="margin-bottom: 1.5rem;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #000; font-weight: 700;">Team Roster</h4>
                        ${teamData.players.length < 4 ? `<button onclick="showAddPlayerForm('${userData.teamId}')" style="padding: 0.5rem 1rem; background: #CFB991; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">+ Add Player</button>` : ''}
                      </div>

                      <div id="playersList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${teamData.players.map((player, index) => `
                          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <span style="color: #000; font-weight: 500;">${player}</span>
                            <button onclick="removePlayer('${userData.teamId}', ${index}, '${player}')" style="padding: 0.35rem 0.75rem; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">Remove</button>
                          </div>
                        `).join('')}
                      </div>
                    </div>

                    <!-- Add Player Form -->
                    <div id="addPlayerFormContainer" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                      <form id="addPlayerForm" onsubmit="handleAddPlayer(event, '${userData.teamId}')">
                        <label for="newPlayerName" style="display: block; margin-bottom: 0.5rem; color: #000; font-weight: 600;">New Player Name</label>
                        <div style="display: flex; gap: 0.75rem;">
                          <input type="text" id="newPlayerName" name="newPlayerName" required
                            style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;"
                            placeholder="Player name" />
                          <button type="submit" style="padding: 0.75rem 1.5rem; background: #CFB991; color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Add</button>
                          <button type="button" onclick="hideAddPlayerForm()" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                        </div>
                      </form>
                    </div>

                    <!-- Captain Actions -->
                    ${(userData.isCaptain || teamData.captainUid === window.auth.currentUser?.uid) ? `
                      <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                        <h4 style="margin: 0 0 1rem 0; color: #000; font-weight: 700;">Captain Actions</h4>
                        <button onclick="deleteTeam('${userData.teamId}', '${teamData.teamName}')" style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                          üóëÔ∏è Delete Team
                        </button>
                        <p style="margin: 0.75rem 0 0 0; color: #666; font-size: 0.85rem;">Deleting the team will permanently remove it and all associated data.</p>
                      </div>
                    ` : ''}

                    <div id="teamMessage" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                  </div>
                </div>
              `;
            }

            // Free agency form visibility is handled in loadFreeAgents()
          } else {
            // Team doesn't exist anymore - clear stale teamId
            console.log('‚ö†Ô∏è Team no longer exists, clearing stale teamId');
            await updateDoc(userDocRef, {
              teamId: null,
              teamName: null,
              isCaptain: null
            });

            // Keep button as "Create Team" (default state)
          }
        } else {
          // Free agency form visibility is handled in loadFreeAgents()
        }
      } catch (error) {
        console.error('Error loading user team:', error);
      }
    };

    // Show add player form
    window.showAddPlayerForm = function(teamId) {
      document.getElementById('addPlayerFormContainer').style.display = 'block';
    };

    // Hide add player form
    window.hideAddPlayerForm = function() {
      document.getElementById('addPlayerFormContainer').style.display = 'none';
      document.getElementById('addPlayerForm').reset();
    };

    // Handle add player
    window.handleAddPlayer = async function(event, teamId) {
      event.preventDefault();

      const messageDiv = document.getElementById('teamMessage');
      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        const newPlayerName = form.newPlayerName.value.trim();

        const { doc, getDoc, updateDoc, arrayUnion } = window.firestoreImports;
        const teamDocRef = doc(window.db, 'teams', teamId);
        const teamDoc = await getDoc(teamDocRef);

        if (!teamDoc.exists()) {
          throw new Error('Team not found');
        }

        const teamData = teamDoc.data();
        if (teamData.players.length >= 4) {
          throw new Error('Team already has maximum 4 players');
        }

        // Add player to team
        await updateDoc(teamDocRef, {
          players: arrayUnion(newPlayerName)
        });

        messageDiv.style.display = 'block';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
        messageDiv.style.color = '#155724';
        messageDiv.textContent = `${newPlayerName} has been added to the team!`;

        // Reload page to show updated roster
        setTimeout(() => {
          window.location.reload();
        }, 1500);

      } catch (error) {
        console.error('Error adding player:', error);
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = error.message;

        submitBtn.disabled = false;
        submitBtn.textContent = 'Add';
      }
    };

    // Remove player from team
    window.removePlayer = async function(teamId, playerIndex, playerName) {
      if (!confirm(`Are you sure you want to remove ${playerName} from the team?`)) {
        return;
      }

      const messageDiv = document.getElementById('teamMessage');

      try {
        const { doc, getDoc, updateDoc, addDoc, collection, query, where, getDocs } = window.firestoreImports;
        const teamDocRef = doc(window.db, 'teams', teamId);
        const teamDoc = await getDoc(teamDocRef);

        if (!teamDoc.exists()) {
          throw new Error('Team not found');
        }

        const teamData = teamDoc.data();
        const updatedPlayers = teamData.players.filter((_, index) => index !== playerIndex);

        if (updatedPlayers.length === 0) {
          throw new Error('Team must have at least one player');
        }

        // Update team with new players array
        await updateDoc(teamDocRef, {
          players: updatedPlayers
        });

        // Find and clear team info from the removed player's user document
        const usersQuery = query(
          collection(window.db, 'users'),
          where('teamId', '==', teamId)
        );
        const usersSnapshot = await getDocs(usersQuery);

        // Clear team info from removed player and create free agent profile
        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const userDisplayName = userData.displayName || userData.email?.split('@')[0];

          // Check if this user matches the removed player name
          if (userDisplayName === playerName || userData.email === playerName) {
            // Clear team info from user document
            await updateDoc(doc(window.db, 'users', userDoc.id), {
              teamId: null,
              teamName: null,
              isCaptain: null
            });

            // Create free agent profile for this user
            await addDoc(collection(window.db, 'freeAgents'), {
              uid: userDoc.id,
              email: userData.email,
              displayName: userData.displayName || userData.email?.split('@')[0],
              createdAt: new Date().toISOString(),
              status: 'active'
            });
            break;
          }
        }

        messageDiv.style.display = 'block';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
        messageDiv.style.color = '#155724';
        messageDiv.textContent = `${playerName} has been removed from the team and added to free agents.`;

        // Reload page to show updated roster
        setTimeout(() => {
          window.location.reload();
        }, 1500);

      } catch (error) {
        console.error('Error removing player:', error);
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = error.message;
      }
    };

    // Show edit team name form
    window.showEditTeamName = function() {
      document.getElementById('displayTeamName').style.display = 'none';
      document.getElementById('editTeamNameForm').style.display = 'block';
      document.getElementById('editTeamNameBtn').style.display = 'none';
    };

    // Cancel edit team name
    window.cancelEditTeamName = function() {
      document.getElementById('displayTeamName').style.display = 'block';
      document.getElementById('editTeamNameForm').style.display = 'none';
      document.getElementById('editTeamNameBtn').style.display = 'block';
    };

    // Save team name
    window.saveTeamName = async function(teamId) {
      const messageDiv = document.getElementById('teamMessage');
      const newName = document.getElementById('editTeamNameInput').value.trim();

      if (!newName) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Team name cannot be empty';
        return;
      }

      try {
        const { doc, updateDoc } = window.firestoreImports;
        const teamDocRef = doc(window.db, 'teams', teamId);

        await updateDoc(teamDocRef, {
          teamName: newName
        });

        messageDiv.style.display = 'block';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
        messageDiv.style.color = '#155724';
        messageDiv.textContent = 'Team name updated successfully!';

        setTimeout(() => {
          window.location.reload();
        }, 1500);

      } catch (error) {
        console.error('Error updating team name:', error);
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = error.message;
      }
    };

    // Show edit contact form
    window.showEditContact = function() {
      document.getElementById('displayContact').style.display = 'none';
      document.getElementById('editContactForm').style.display = 'block';
      document.getElementById('editContactBtn').style.display = 'none';
    };

    // Cancel edit contact
    window.cancelEditContact = function() {
      document.getElementById('displayContact').style.display = 'block';
      document.getElementById('editContactForm').style.display = 'none';
      document.getElementById('editContactBtn').style.display = 'block';
    };

    // Save contact info
    window.saveContact = async function(teamId) {
      const messageDiv = document.getElementById('teamMessage');
      const instagram = document.getElementById('editInstagram').value.trim();
      const groupme = document.getElementById('editGroupme').value.trim();

      try {
        const { doc, updateDoc } = window.firestoreImports;
        const teamDocRef = doc(window.db, 'teams', teamId);

        await updateDoc(teamDocRef, {
          instagram: instagram,
          groupme: groupme
        });

        messageDiv.style.display = 'block';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
        messageDiv.style.color = '#155724';
        messageDiv.textContent = 'Contact information updated successfully!';

        setTimeout(() => {
          window.location.reload();
        }, 1500);

      } catch (error) {
        console.error('Error updating contact info:', error);
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = error.message;
      }
    };

    // Load all teams from Firestore
    window.loadAllTeams = async function() {
      try {
        const { collection, getDocs, query, where, orderBy } = window.firestoreImports;
        const teamsGrid = document.getElementById('teamsGrid');

        if (!teamsGrid) return;

        // Query teams for Spring 2026 tournament
        const teamsQuery = query(
          collection(window.db, 'teams'),
          where('tournament', '==', 'spring-2026'),
          where('status', '==', 'active')
        );

        const teamsSnapshot = await getDocs(teamsQuery);

        if (teamsSnapshot.empty) {
          teamsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #999;">
              <p style="font-size: 1.1rem; margin: 0;">No teams registered yet. Be the first to create a team!</p>
            </div>
          `;
          return;
        }

        // Display teams
        const teamsHTML = [];
        teamsSnapshot.forEach((doc) => {
          const team = doc.data();
          teamsHTML.push(`
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #e5e7eb; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
              <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #CFB991 0%, #A89968 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 1rem;">
                  üèÄ
                </div>
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 0.25rem 0; color: #000; font-weight: 700; font-size: 1.1rem;">${team.teamName}</h4>
                  <p style="margin: 0; color: #666; font-size: 0.85rem;">Captain: ${team.captainName || team.captainEmail}</p>
                </div>
              </div>
              <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">Players (${team.players.length}):</p>
                <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                  ${team.players.slice(0, 3).map(player => `
                    <p style="margin: 0; color: #000; font-size: 0.9rem;">${player}</p>
                  `).join('')}
                  ${team.players.length > 3 ? `<p style="margin: 0; color: #666; font-size: 0.85rem; font-style: italic;">+ ${team.players.length - 3} more</p>` : ''}
                </div>
              </div>
            </div>
          `);
        });

        teamsGrid.innerHTML = teamsHTML.join('');

      } catch (error) {
        console.error('Error loading teams:', error);
      }
    };

    // Call loadAllTeams when Firebase is ready and Teams tab is opened
    document.addEventListener('DOMContentLoaded', () => {
      const teamsTab = document.getElementById('tab-teams');
      if (teamsTab) {
        teamsTab.addEventListener('click', () => {
          waitForFirebase(() => {
            loadAllTeams();
            loadFreeAgents();
          });
        });
      }
    });

    // ============================================
    // Free Agency Functions
    // ============================================

    // Handle join free agency form submission
    window.handleJoinFreeAgency = async function(event) {
      event.preventDefault();

      const messageDiv = document.getElementById('freeAgencyMessage');
      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Joining...';

        const user = window.auth?.currentUser;
        if (!user) {
          throw new Error('You must be signed in to join free agency');
        }

        // Create free agent document
        const freeAgentData = {
          playerName: form.freeAgencyName.value.trim(),
          email: form.freeAgencyEmail.value.trim(),
          uid: user.uid,
          instagram: form.freeAgencyInstagram.value.trim() || '',
          groupme: form.freeAgencyGroupme.value.trim() || '',
          notes: form.freeAgencyNotes.value.trim() || '',
          createdAt: new Date().toISOString(),
          tournament: 'spring-2026',
          status: 'active'
        };

        const { collection, addDoc } = window.firestoreImports;

        // Add to free agents collection
        await addDoc(collection(window.db, 'freeAgents'), freeAgentData);

        messageDiv.style.display = 'block';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
        messageDiv.style.color = '#155724';
        messageDiv.innerHTML = `
          <strong>Success!</strong> You've joined free agency. Teams can now see your profile and contact you!
        `;

        // Hide form and reload free agents list
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        console.error('Error joining free agency:', error);
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.style.color = '#721c24';
        messageDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;

        submitBtn.disabled = false;
        submitBtn.textContent = 'Join Free Agency';
      }
    };

    // Load all free agents from Firestore
    window.loadFreeAgents = async function() {
      try {
        const { collection, getDocs, query, where, doc, getDoc } = window.firestoreImports;
        const freeAgentsGrid = document.getElementById('freeAgentsGrid');
        const joinFreeAgencyForm = document.getElementById('joinFreeAgencyForm');

        if (!freeAgentsGrid) return;

        // Check if current user is a team captain with less than 4 players or admin
        const user = window.auth?.currentUser;
        let canSendInvite = false;
        let userTeam = null;
        let userIsInFreeAgency = false;
        let userHasTeam = false;
        let isAdmin = window.currentUserData?.roles?.includes('admin') || false;

        // Check if user has a team
        if (user) {
          const userDocRef = doc(window.db, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists() && userDoc.data().teamId) {
            userHasTeam = true;
            const userData = userDoc.data();
            const teamId = userData.teamId;

            // Get team data
            const teamDocRef = doc(window.db, 'teams', teamId);
            const teamDoc = await getDoc(teamDocRef);

            if (teamDoc.exists()) {
              userTeam = { id: teamId, ...teamDoc.data() };
              const playerCount = userTeam.players ? userTeam.players.length : 0;

              // User can send invites if they are captain AND team is not full
              canSendInvite = userData.isCaptain && playerCount < 4;
            }
          }
        }

        // Query free agents for Spring 2026 tournament
        const freeAgentsQuery = query(
          collection(window.db, 'freeAgents'),
          where('tournament', '==', 'spring-2026'),
          where('status', '==', 'active')
        );

        const freeAgentsSnapshot = await getDocs(freeAgentsQuery);

        // Check if current user is already in free agency
        if (user) {
          freeAgentsSnapshot.forEach((doc) => {
            const agent = doc.data();
            if (agent.uid === user.uid || agent.email === user.email) {
              userIsInFreeAgency = true;
            }
          });
        }

        // Show or hide the Join Free Agency form
        if (joinFreeAgencyForm) {
          // Hide form if user has a team or is already in free agency
          if (userHasTeam || userIsInFreeAgency) {
            joinFreeAgencyForm.style.display = 'none';
          } else if (user) {
            joinFreeAgencyForm.style.display = 'block';
          } else {
            joinFreeAgencyForm.style.display = 'none';
          }
        }

        if (freeAgentsSnapshot.empty) {
          freeAgentsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #999;">
              <p style="font-size: 1.1rem; margin: 0;">No players in free agency yet. Be the first!</p>
            </div>
          `;
          return;
        }

        // Display free agents
        const freeAgentsHTML = [];
        freeAgentsSnapshot.forEach((doc) => {
          const agent = doc.data();
          const agentId = doc.id;

          freeAgentsHTML.push(`
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #e5e7eb; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
              <div style="margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #000; font-weight: 700; font-size: 1.1rem;">${agent.playerName}</h4>
                <p style="margin: 0; color: #666; font-size: 0.85rem;">${agent.email}</p>
              </div>

              ${agent.instagram || agent.groupme ? `
                <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb; margin-bottom: 1rem;">
                  <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">Contact:</p>
                  ${agent.instagram ? `<p style="margin: 0 0 0.25rem 0; color: #000; font-size: 0.9rem;">üì∑ ${agent.instagram}</p>` : ''}
                  ${agent.groupme ? `<p style="margin: 0; color: #000; font-size: 0.9rem;">üí¨ GroupMe</p>` : ''}
                </div>
              ` : ''}

              ${agent.notes ? `
                <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb; margin-bottom: 1rem;">
                  <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.85rem; font-weight: 600;">About:</p>
                  <p style="margin: 0; color: #000; font-size: 0.9rem; line-height: 1.5;">${agent.notes}</p>
                </div>
              ` : ''}

              ${canSendInvite || isAdmin ? `
                <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb; ${canSendInvite && isAdmin ? 'display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;' : ''}">
                  ${canSendInvite ? `
                    <button onclick="sendTeamInvite('${agentId}', '${agent.playerName}', '${agent.email}')" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #CFB991 0%, #A89968 100%); color: #000; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(207, 185, 145, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                      Send Team Invite
                    </button>
                  ` : ''}
                  ${isAdmin ? `
                    <button onclick="removeFreeAgent('${agentId}', '${agent.playerName}')" style="width: 100%; padding: 0.75rem; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                      Remove
                    </button>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          `);
        });

        freeAgentsGrid.innerHTML = freeAgentsHTML.join('');

      } catch (error) {
        console.error('Error loading free agents:', error);
      }
    };

    // Accept team invite from free agency
    window.acceptTeamInvite = async function(inviteId, teamId, teamName) {
      try {
        const user = window.auth?.currentUser;
        if (!user) {
          alert('You must be signed in to accept team invites');
          return;
        }

        const { doc, getDoc, updateDoc, setDoc, collection, query, where, getDocs, deleteDoc, arrayUnion, serverTimestamp } = window.firestoreImports;

        // Get team data to check current roster (use player_teams collection)
        const teamRef = doc(window.db, 'player_teams', teamId);
        const teamDoc = await getDoc(teamRef);

        if (!teamDoc.exists()) {
          alert('Team not found. It may have been deleted.');
          return;
        }

        const teamData = teamDoc.data();
        const currentMembers = teamData.members || [];

        // Check if team has space
        if (currentMembers.length >= 4) {
          alert(`Team "${teamName}" is full (4/4 players). Please check the roster and try another team.`);
          return;
        }

        // Check if user is already on the team
        if (currentMembers.includes(user.uid)) {
          alert('You are already a member of this team.');
          await updateDoc(doc(window.db, 'teamInvites', inviteId), {
            status: 'accepted'
          });
          window.location.reload();
          return;
        }

        // Confirm acceptance
        const confirmed = confirm(`Join "${teamName}"? They currently have ${currentMembers.length}/4 players.`);
        if (!confirmed) return;

        // Add player to team (use uid, not display name)
        await updateDoc(teamRef, {
          members: arrayUnion(user.uid)
        });

        // Update user document with team info and player role
        const userRef = doc(window.db, 'users', user.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
          await updateDoc(userRef, {
            teamId: teamId,
            teamName: teamName,
            isCaptain: false,
            roles: arrayUnion('player')
          });
        } else {
          await setDoc(userRef, {
            teamId: teamId,
            teamName: teamName,
            isCaptain: false,
            roles: ['player'],
            createdAt: serverTimestamp()
          });
        }

        // Remove from free agency - delete the document entirely
        const freeAgentsQuery = query(
          collection(window.db, 'freeAgents'),
          where('uid', '==', user.uid)
        );
        const freeAgentsSnapshot = await getDocs(freeAgentsQuery);
        for (const docSnapshot of freeAgentsSnapshot.docs) {
          await deleteDoc(doc(window.db, 'freeAgents', docSnapshot.id));
        }

        // Update invite status
        await updateDoc(doc(window.db, 'teamInvites', inviteId), {
          status: 'accepted'
        });

        // Create notification for team captain (use 'captain' field)
        const { addDoc } = window.firestoreImports;
        const playerName = user.displayName || user.email.split('@')[0];
        await addDoc(collection(window.db, 'notifications'), {
          userId: teamData.captain,
          type: 'invite_accepted',
          title: 'Team Invite Accepted',
          message: `${playerName} has joined your team "${teamName}"!`,
          teamId: teamId,
          teamName: teamName,
          read: false,
          createdAt: new Date().toISOString()
        });

        alert(`Successfully joined "${teamName}"!`);
        window.location.reload();

      } catch (error) {
        console.error('Error accepting team invite:', error);
        alert('Failed to accept invite: ' + error.message);
      }
    };

    // Reject team invite
    window.rejectTeamInvite = async function(inviteId, teamName) {
      try {
        const confirmed = confirm(`Decline team invite from "${teamName}"?`);
        if (!confirmed) return;

        const { doc, updateDoc, collection, query, where, getDocs, deleteDoc } = window.firestoreImports;

        await updateDoc(doc(window.db, 'teamInvites', inviteId), {
          status: 'declined'
        });

        // Remove notification
        const user = window.auth?.currentUser;
        if (user) {
          const notificationQuery = query(
            collection(window.db, 'notifications'),
            where('inviteId', '==', inviteId),
            where('userId', '==', user.email)
          );
          const notificationSnapshot = await getDocs(notificationQuery);
          notificationSnapshot.forEach(async (notifDoc) => {
            await deleteDoc(doc(window.db, 'notifications', notifDoc.id));
          });
        }

        alert('Team invite declined.');
        window.location.reload();

      } catch (error) {
        console.error('Error declining invite:', error);
        alert('Failed to decline invite: ' + error.message);
      }
    };

    // Alias for backwards compatibility
    window.declineTeamInvite = window.rejectTeamInvite;

    // Remove free agent (admin only)
    window.removeFreeAgent = async function(agentId, playerName) {
      try {
        // Check if user is admin
        if (!window.currentUserData?.roles?.includes('admin')) {
          alert('Only admins can remove free agents.');
          return;
        }

        const confirmed = confirm(`Remove ${playerName} from free agency?`);
        if (!confirmed) return;

        const { doc, updateDoc } = window.firestoreImports;

        await updateDoc(doc(window.db, 'freeAgents', agentId), {
          status: 'inactive'
        });

        alert(`${playerName} has been removed from free agency.`);
        loadFreeAgents(); // Reload the list

      } catch (error) {
        console.error('Error removing free agent:', error);
        alert('Failed to remove free agent: ' + error.message);
      }
    };

    // Update unread notifications badge
    window.updateUnreadBadge = async function() {
      try {
        const user = window.auth?.currentUser;
        if (!user) return;

        const { collection, query, where, getDocs } = window.firestoreImports;
        const unreadBadge = document.getElementById('unreadBadge');

        if (!unreadBadge) return;

        // Query unread notifications for current user
        const notificationsQuery = query(
          collection(window.db, 'notifications'),
          where('userId', '==', user.email),
          where('read', '==', false)
        );

        const unreadSnapshot = await getDocs(notificationsQuery);
        const unreadCount = unreadSnapshot.size;

        if (unreadCount > 0) {
          unreadBadge.textContent = unreadCount;
          unreadBadge.style.display = 'flex';
        } else {
          unreadBadge.style.display = 'none';
        }

      } catch (error) {
        console.error('Error updating unread badge:', error);
      }
    };

    // Send team invite to free agent
    window.sendTeamInvite = async function(agentId, playerName, playerEmail) {
      try {
        const user = window.auth?.currentUser;
        if (!user) {
          alert('You must be signed in to send team invites');
          return;
        }

        // Get user's team info
        const { doc, getDoc, collection, addDoc, query, where, getDocs } = window.firestoreImports;
        const userDocRef = doc(window.db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);

        if (!userDoc.exists() || !userDoc.data().teamId) {
          alert('You must have a team to send invites');
          return;
        }

        const userData = userDoc.data();

        console.log('=== TEAM INVITE DEBUG ===');
        console.log('User data:', userData);
        console.log('User UID from auth:', user.uid);
        console.log('User email from auth:', user.email);
        console.log('Is captain:', userData.isCaptain);

        if (!userData.isCaptain) {
          alert('Only the team captain can send invites');
          return;
        }

        // Get team data
        const teamDocRef = doc(window.db, 'teams', userData.teamId);
        const teamDoc = await getDoc(teamDocRef);

        if (!teamDoc.exists()) {
          alert('Team not found');
          return;
        }

        const team = { id: userData.teamId, ...teamDoc.data() };
        const playerCount = team.players ? team.players.length : 0;

        if (playerCount >= 4) {
          alert('Your team already has 4 players. You cannot add more.');
          return;
        }

        // Confirm before sending
        const confirmed = confirm(`Send team invite to ${playerName} to join ${team.teamName}?`);
        if (!confirmed) return;

        // Check if invite already exists
        const existingInviteQuery = query(
          collection(window.db, 'teamInvites'),
          where('captainUid', '==', user.uid),
          where('teamId', '==', team.id),
          where('freeAgentId', '==', agentId),
          where('status', '==', 'pending')
        );

        const existingInvites = await getDocs(existingInviteQuery);
        if (!existingInvites.empty) {
          alert('You have already sent an invite to this player. Please wait for their response.');
          return;
        }

        // Create team invite
        const inviteData = {
          teamId: team.id,
          teamName: team.teamName,
          captainUid: user.uid,
          captainEmail: user.email,
          captainName: user.displayName || user.email.split('@')[0],
          freeAgentId: agentId,
          playerName: playerName,
          playerEmail: playerEmail,
          status: 'pending',
          createdAt: new Date().toISOString(),
          tournament: 'spring-2026'
        };

        console.log('Creating team invite with data:', inviteData);
        console.log('Current user UID:', user.uid);

        try {
          const inviteDocRef = await addDoc(collection(window.db, 'teamInvites'), inviteData);
          console.log('Team invite created successfully:', inviteDocRef.id);

          // Create notification for the free agent
          const notificationData = {
            userId: playerEmail, // Use email as identifier since free agents might not have uid
            type: 'team_invite',
            title: 'Team Invite',
            message: `${team.teamName} has invited you to join their team!`,
            teamId: team.id,
            teamName: team.teamName,
            inviteId: inviteDocRef.id, // Use the actual teamInvites document ID
            read: false,
            createdAt: new Date().toISOString()
          };

          console.log('Creating notification with data:', notificationData);
          await addDoc(collection(window.db, 'notifications'), notificationData);
          console.log('Notification created successfully');

          alert(`Team invite sent to ${playerName}!`);
        } catch (createError) {
          console.error('Error creating invite or notification:', createError);
          throw createError;
        }

      } catch (error) {
        console.error('Error sending team invite:', error);
        alert('Failed to send team invite: ' + error.message);
      }
    };

    // Profile modal handlers
    const profileModal = document.getElementById('profileModal');
    const profileCloseBtn = document.getElementById('profileCloseBtn');

    // Close profile modal
    if (profileCloseBtn) {
      profileCloseBtn.addEventListener('click', () => {
        if (profileModal) {
          profileModal.style.display = 'none';
        }
      });
    }

    // Close profile modal when clicking outside
    if (profileModal) {
      profileModal.addEventListener('click', (e) => {
        if (e.target === profileModal) {
          profileModal.style.display = 'none';
        }
      });
    }

    // ============================================================================
    // ADMIN CHECK HELPER - Fetches from Firestore (NO HARDCODED EMAILS)
    // ============================================================================
    async function isApprovedAdmin(email) {
      try {
        if (!email || !window.db || !window.firestoreImports) {
          return false;
        }

        const { collection, query, where, getDocs, doc, getDoc } = window.firestoreImports;
        const userUid = window.auth?.currentUser?.uid;

        // Check if user is main admin (matches the UID in firestore.rules)
        const MAIN_ADMIN_UID = 'seZ01FolJbSajEKTIsljwGtYHGD3';
        if (userUid === MAIN_ADMIN_UID) {
          console.log('‚úÖ User is main admin:', email);
          return true;
        }

        // Check approved_admins collection
        const approvedAdminsQuery = query(
          collection(window.db, 'approved_admins'),
          where('email', '==', email)
        );

        const snapshot = await getDocs(approvedAdminsQuery);

        if (!snapshot.empty) {
          console.log('‚úÖ User is approved admin (from approved_admins):', email);
          return true;
        }

        // Also check admin_requests collection for approved requests
        if (userUid) {
          const requestDoc = await getDoc(doc(window.db, 'admin_requests', userUid));
          if (requestDoc.exists() && requestDoc.data().status === 'approved') {
            console.log('‚úÖ User is approved admin (from admin_requests):', email);
            return true;
          }
        }

        console.log('‚ùå User is not an approved admin:', email);
        return false;

      } catch (error) {
        console.error('Error checking admin status:', error);
        return false;
      }
    }

    // Admin functionality - must be outside Firebase callback so button works immediately
    const adminBtn = document.getElementById('adminBtn');
    const adminModal = document.getElementById('adminModal');
    const adminPassword = document.getElementById('adminPassword');
    const adminSubmit = document.getElementById('adminSubmit');
    const adminCancel = document.getElementById('adminCancel');
    const adminError = document.getElementById('adminError');

    let isAdminMode = false;
    let currentEditRow = null;

    // Check for existing admin session on page load
    async function checkAdminSession() {
      const sessionToken = sessionStorage.getItem('adminSessionToken');
      const sessionExpiry = sessionStorage.getItem('adminSessionExpiry');

      if (sessionToken && sessionExpiry && Date.now() < parseInt(sessionExpiry)) {
        // Verify user is still an approved admin
        const currentUser = window.auth?.currentUser;
        if (!currentUser) {
          // Clear session if not logged in
          sessionStorage.removeItem('adminSessionToken');
          sessionStorage.removeItem('adminAuthMethod');
          sessionStorage.removeItem('adminSessionExpiry');
          return;
        }

        // Check if user is approved admin (from Firestore)
        const isUserApprovedAdmin = await isApprovedAdmin(currentUser.email);

        if (!isUserApprovedAdmin) {
          // User is no longer an admin - clear session
          sessionStorage.removeItem('adminSessionToken');
          sessionStorage.removeItem('adminAuthMethod');
          sessionStorage.removeItem('adminSessionExpiry');
          console.log('‚ùå Admin session invalid - user not approved');
          return;
        }

        // Valid session exists and user is approved - restore admin mode
        isAdminMode = true;
        document.body.classList.add('admin-mode');
        adminBtn.textContent = 'Logout';
        adminBtn.style.background = 'var(--success)';
        document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = '');
        const quickAddSection = document.querySelector('.quick-add-section');
        if (quickAddSection) quickAddSection.style.display = 'block';
        const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
        if (bulkImportBtn) bulkImportBtn.style.display = 'block';
        console.log('‚úÖ Admin session restored');
      } else {
        // Clear expired session
        sessionStorage.removeItem('adminSessionToken');
        sessionStorage.removeItem('adminAuthMethod');
        sessionStorage.removeItem('adminSessionExpiry');
      }
    }

    // Check for existing session when page loads
    checkAdminSession();

    // Admin button click handler - check Gmail and approved list
    adminBtn.addEventListener('click', async () => {
      if (!isAdminMode) {
        // Check if user is signed in with Google
        const currentUser = window.auth?.currentUser;
        if (!currentUser) {
          alert('Please sign in with Google first to access admin mode');
          return;
        }

        // Check if user is approved admin (from Firestore)
        const isUserApprovedAdmin2 = await isApprovedAdmin(currentUser.email);

        if (!isUserApprovedAdmin2) {
          alert('You do not have admin privileges.\n\nYour Gmail (' + currentUser.email + ') is not in the approved admins list.\n\nPlease request admin access from your profile.');
          return;
        }

        // User is approved - enable admin mode directly
        console.log('‚úÖ Admin verified:', currentUser.email);
        isAdminMode = true;
        document.body.classList.add('admin-mode');
        adminBtn.textContent = 'Exit Admin';
        adminBtn.style.background = 'var(--success)';
        document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = '');
        const quickAddSection = document.querySelector('.quick-add-section');
        if (quickAddSection) quickAddSection.style.display = 'block';
        const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
        if (bulkImportBtn) bulkImportBtn.style.display = 'block';

        // Store session info
        sessionStorage.setItem('adminSessionToken', 'gmail-' + Date.now());
        sessionStorage.setItem('adminAuthMethod', 'gmail');
        sessionStorage.setItem('adminSessionExpiry', Date.now() + 24 * 60 * 60 * 1000); // 24 hours

        console.log('‚úÖ Admin mode enabled for', currentUser.email);
        return;
      } else {
        // Disable admin mode (logout)
        window.adminLogout();
      }
    });

    adminCancel.addEventListener('click', () => {
      adminModal.style.display = 'none';
      // Clear form when closing
      document.getElementById('adminPassword').value = '';
      document.getElementById('requestAdminName').value = '';
      document.getElementById('adminError').style.display = 'none';
    });

    // Handle cancel for not logged in view
    document.getElementById('adminCancelNotLoggedIn')?.addEventListener('click', () => {
      adminModal.style.display = 'none';
    });

    adminModal.addEventListener('click', (e) => {
      if (e.target === adminModal) {
        adminModal.style.display = 'none';
        // Clear form when closing
        document.getElementById('adminPassword').value = '';
        document.getElementById('requestAdminName').value = '';
        document.getElementById('adminError').style.display = 'none';
      }
    });

    // WebAuthn helper functions for server-side verification
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function base64urlToBase64(base64url) {
      let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
      while (base64.length % 4 !== 0) {
        base64 += '=';
      }
      return base64;
    }

    function arrayBufferToBase64url(buffer) {
      const base64 = arrayBufferToBase64(buffer);
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Server-verified WebAuthn registration
    async function registerWebAuthn() {
      try {
        // Check if WebAuthn is supported
        if (!window.PublicKeyCredential) {
          throw new Error('WebAuthn is not supported on this device');
        }

        // Wait for Firebase to be ready
        if (!window.auth || !window.authImports || !window.functions) {
          throw new Error('Firebase not initialized. Please refresh and try again.');
        }

        const { signInWithEmailAndPassword } = window.authImports;

        // Check if already authenticated
        let user = window.auth.currentUser;

        if (!user) {
          // Not logged in - need to authenticate first
          const email = prompt('Enter your admin email for initial registration:');
          const password = prompt('Enter your admin password for initial registration:');

          if (!email || !password) {
            throw new Error('Email and password required for initial setup');
          }

          const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
          user = userCredential.user;
        }

        // Verify user is an admin (will be checked by server too)
        console.log('Registering Touch ID for user:', user.uid, user.email);

        // Get registration options from server
        const { httpsCallable } = window.functionsImports;
        const generateRegOptions = httpsCallable(window.functions, 'generateRegistrationOptions');
        const optionsResponse = await generateRegOptions();
        const options = optionsResponse.data;

        // Convert challenge from base64url to Uint8Array
        const challengeArray = base64ToArrayBuffer(base64urlToBase64(options.challenge));

        // Convert excludeCredentials IDs from base64url to ArrayBuffer
        const excludeCredentials = options.excludeCredentials?.map(cred => ({
          id: base64ToArrayBuffer(base64urlToBase64(cred.id)),
          type: cred.type,
          transports: cred.transports,
        })) || [];

        // Create credential options for browser
        const publicKeyCredentialCreationOptions = {
          challenge: challengeArray,
          rp: {
            name: options.rpName,
            id: options.rpID,
          },
          user: {
            id: Uint8Array.from(options.userID, c => c.charCodeAt(0)),
            name: options.userName,
            displayName: 'IBA Admin',
          },
          pubKeyCredParams: [
            { alg: -7, type: 'public-key' },  // ES256
            { alg: -257, type: 'public-key' } // RS256
          ],
          excludeCredentials: excludeCredentials,
          authenticatorSelection: options.authenticatorSelection,
          timeout: options.timeout,
          attestation: options.attestationType || 'none',
        };

        // Create credential with Touch ID/Face ID
        console.log('Creating WebAuthn credential...');
        const credential = await navigator.credentials.create({
          publicKey: publicKeyCredentialCreationOptions
        });

        // Prepare credential for server verification (use base64url format)
        const rawIdBase64url = arrayBufferToBase64url(credential.rawId);
        const credentialData = {
          id: rawIdBase64url, // Use the base64url encoding of rawId
          rawId: rawIdBase64url,
          type: credential.type,
          response: {
            clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
            attestationObject: arrayBufferToBase64url(credential.response.attestationObject),
            transports: credential.response.getTransports ? credential.response.getTransports() : ['internal'],
          },
        };

        // Validate base64url format (should only contain: A-Z, a-z, 0-9, -, _)
        const isValidBase64url = /^[A-Za-z0-9\-_]+$/.test(credentialData.id);
        console.log('Sending credential data:', {
          id: credentialData.id.substring(0, 30) + '...',
          type: credentialData.type,
          isValidBase64url,
          length: credentialData.id.length
        });

        // Send to server for verification and storage
        const verifyReg = httpsCallable(window.functions, 'verifyRegistration');
        const verificationResponse = await verifyReg({ credential: credentialData });

        if (verificationResponse.data.verified) {
          console.log('‚úÖ Biometric credential registered successfully on server');
          console.log('‚úÖ Touch ID/Face ID is now enabled for your account!');
          // Keep user logged in - they can use Touch ID next time
          return true;
        } else {
          throw new Error('Server verification failed');
        }
      } catch (error) {
        console.error('WebAuthn registration error:', error);
        throw error;
      }
    }

    // Server-verified WebAuthn authentication
    async function authenticateWebAuthn() {
      try {
        // Check if WebAuthn is supported
        if (!window.PublicKeyCredential) {
          throw new Error('WebAuthn is not supported on this device');
        }

        // Wait for Firebase to be ready
        if (!window.functions) {
          throw new Error('Firebase not initialized. Please refresh and try again.');
        }

        // Get authentication options from server
        const { httpsCallable } = window.functionsImports;
        const generateAuthOptions = httpsCallable(window.functions, 'generateAuthenticationOptions');
        const optionsResponse = await generateAuthOptions();
        const options = optionsResponse.data;

        // Convert challenge from base64url to Uint8Array
        const challengeArray = base64ToArrayBuffer(base64urlToBase64(options.challenge));

        // Convert allowCredentials IDs from base64url to ArrayBuffer
        const allowCredentials = options.allowCredentials.map(cred => ({
          id: base64ToArrayBuffer(base64urlToBase64(cred.id)),
          type: cred.type,
          transports: cred.transports,
        }));

        // Create authentication options for browser
        const publicKeyCredentialRequestOptions = {
          challenge: challengeArray,
          allowCredentials: allowCredentials,
          timeout: options.timeout,
          userVerification: options.userVerification,
          rpId: options.rpID,
        };

        // Get credential with Touch ID/Face ID
        console.log('Authenticating with biometrics...');
        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions
        });

        // Prepare assertion for server verification (use base64url format for SimpleWebAuthn)
        const assertionData = {
          id: assertion.id,
          rawId: arrayBufferToBase64url(assertion.rawId),
          type: assertion.type,
          response: {
            clientDataJSON: arrayBufferToBase64url(assertion.response.clientDataJSON),
            authenticatorData: arrayBufferToBase64url(assertion.response.authenticatorData),
            signature: arrayBufferToBase64url(assertion.response.signature),
            userHandle: assertion.response.userHandle ? arrayBufferToBase64url(assertion.response.userHandle) : null,
          },
        };

        // Send to server for verification
        const verifyAuth = httpsCallable(window.functions, 'verifyAuthentication');
        const verificationResponse = await verifyAuth({ credential: assertionData });

        if (verificationResponse.data.verified) {
          console.log('‚úÖ Biometric authentication verified by server');

          // Store session token for this session
          sessionStorage.setItem('adminSessionToken', verificationResponse.data.sessionToken);
          sessionStorage.setItem('adminAuthMethod', 'webauthn');
          sessionStorage.setItem('adminSessionExpiry', Date.now() + 24 * 60 * 60 * 1000); // 24 hours

          // Note: For write operations, user will need to also be signed in with Firebase Auth
          // Check if user is already signed in with Firebase
          if (!window.auth.currentUser || window.auth.currentUser.uid !== 'seZ01FolJbSajEKTIsljwGtYHGD3') {
            console.log('‚ÑπÔ∏è Note: You will need to sign in with email/password for write operations');
          }

          return true;
        } else {
          throw new Error('Server verification failed');
        }
      } catch (error) {
        console.error('WebAuthn authentication error:', error);
        throw error;
      }
    }

    // Admin logout function
    window.adminLogout = function() {
      isAdminMode = false;
      document.body.classList.remove('admin-mode');
      adminBtn.textContent = 'Admin';
      adminBtn.style.background = 'var(--brand)';
      document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = 'none');
      const quickAddSection = document.querySelector('.quick-add-section');
      if (quickAddSection) quickAddSection.style.display = 'none';
      const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
      if (bulkImportBtn) bulkImportBtn.style.display = 'none';

      // Clear session storage
      sessionStorage.removeItem('adminSessionToken');
      sessionStorage.removeItem('adminAuthMethod');
      sessionStorage.removeItem('adminSessionExpiry');

      console.log('Admin logged out');
    };

    // Biometric authentication button handler with server verification
    document.getElementById('adminBiometricBtn').addEventListener('click', async () => {
      const adminError = document.getElementById('adminError');
      const adminBiometricBtn = document.getElementById('adminBiometricBtn');
      adminError.style.display = 'none';

      try {
        // Disable button during processing
        adminBiometricBtn.disabled = true;
        adminBiometricBtn.textContent = 'Processing...';

        // Try to authenticate first
        try {
          console.log('Attempting biometric authentication...');
          await authenticateWebAuthn();

          // Verify user is an approved admin
          const currentUser = window.auth?.currentUser;
          if (!currentUser) {
            throw new Error('Please sign in first');
          }

          // Check if user is approved admin (from Firestore)
          const isUserApprovedAdmin3 = await isApprovedAdmin(currentUser.email);

          if (!isUserApprovedAdmin3) {
            throw new Error('Unauthorized: Not an admin account. Please request admin access.');
          }

          // Success - user is authenticated with biometrics and is an approved admin
          adminModal.style.display = 'none';
          isAdminMode = true;
          document.body.classList.add('admin-mode');
          adminBtn.textContent = 'Logout';
          adminBtn.style.background = 'var(--success)';
          document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = '');
          const quickAddSection = document.querySelector('.quick-add-section');
          if (quickAddSection) quickAddSection.style.display = 'block';
          const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
          if (bulkImportBtn) bulkImportBtn.style.display = 'block';

          // Store session info
          sessionStorage.setItem('adminSessionToken', 'biometric-' + Date.now());
          sessionStorage.setItem('adminAuthMethod', 'biometric');
          sessionStorage.setItem('adminSessionExpiry', Date.now() + 24 * 60 * 60 * 1000); // 24 hours

          console.log('‚úÖ Admin logged in successfully with server-verified biometrics');
        } catch (authError) {
          // If authentication fails because no credentials exist, offer registration
          if (authError.message?.includes('No biometric credentials registered') ||
              authError.code === 'functions/failed-precondition') {
            console.log('No credentials found. Starting registration...');

            // Show registration prompt
            const shouldRegister = confirm(
              'No biometric credentials found.\n\n' +
              'This is your first time setting up Touch ID/Face ID.\n' +
              'You will need to enter your admin email and password once for verification.\n\n' +
              'Continue?'
            );

            if (!shouldRegister) {
              throw new Error('Registration cancelled');
            }

            // Register new credentials
            await registerWebAuthn();

            adminError.textContent = '‚úÖ Successfully registered! Click the button again to login with Touch ID.';
            adminError.style.color = 'var(--success)';
            adminError.style.display = 'block';
            document.getElementById('adminSetupText').style.display = 'none';

            setTimeout(() => {
              adminError.style.display = 'none';
              adminError.style.color = '';
            }, 5000);
          } else {
            // Re-throw other authentication errors
            throw authError;
          }
        }
      } catch (error) {
        console.error('Biometric authentication error:', error);

        // Handle specific error types
        if (error.name === 'NotAllowedError') {
          adminError.textContent = 'Authentication cancelled or not allowed';
        } else if (error.name === 'NotSupportedError') {
          adminError.textContent = 'Touch ID / Face ID not available on this device';
        } else if (error.message?.includes('not supported')) {
          adminError.textContent = 'Biometric authentication not supported on this browser';
        } else if (error.message?.includes('Firebase not initialized')) {
          adminError.textContent = 'Loading... Please wait and try again';
        } else if (error.message?.includes('cancelled')) {
          adminError.textContent = 'Registration cancelled';
        } else {
          adminError.textContent = error.message || 'Authentication failed. Please try again.';
        }
        adminError.style.display = 'block';
      } finally {
        // Re-enable button
        adminBiometricBtn.disabled = false;
        adminBiometricBtn.textContent = 'üîê Use Touch ID / Face ID';
      }
    });

    // Email/Password authentication button handler
    document.getElementById('adminEmailPasswordBtn').addEventListener('click', async () => {
      const adminError = document.getElementById('adminError');
      const adminEmailPasswordBtn = document.getElementById('adminEmailPasswordBtn');
      const passwordInput = document.getElementById('adminPassword');
      adminError.style.display = 'none';

      try {
        const currentUser = window.auth.currentUser;
        if (!currentUser) {
          throw new Error('Please sign in first');
        }

        const email = currentUser.email;
        const password = passwordInput.value;

        if (!password) {
          throw new Error('Please enter your password');
        }

        // Disable button during processing
        adminEmailPasswordBtn.disabled = true;
        adminEmailPasswordBtn.textContent = 'Logging in...';

        // Wait for Firebase to be ready
        if (!window.auth || !window.authImports) {
          throw new Error('Firebase not initialized. Please refresh and try again.');
        }

        const { signInWithEmailAndPassword } = window.authImports;

        // Sign in with email and password (re-authenticate)
        const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
        console.log('‚úÖ Re-authenticated with password:', userCredential.user.uid);

        // Check if user is approved admin (from Firestore)
        const isUserApprovedAdmin4 = await isApprovedAdmin(userCredential.user.email);

        if (!isUserApprovedAdmin4) {
          throw new Error('Unauthorized: Not an admin account. Please request admin access.');
        }

        console.log('‚úÖ Admin verified:', userCredential.user.email);

        // Success - enable admin mode
        adminModal.style.display = 'none';
        isAdminMode = true;
        document.body.classList.add('admin-mode');
        adminBtn.textContent = 'Logout';
        adminBtn.style.background = 'var(--success)';
        document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = '');
        const quickAddSection = document.querySelector('.quick-add-section');
        if (quickAddSection) quickAddSection.style.display = 'block';
        const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
        if (bulkImportBtn) bulkImportBtn.style.display = 'block';

        // Store session info
        sessionStorage.setItem('adminSessionToken', 'email-' + Date.now());
        sessionStorage.setItem('adminAuthMethod', 'email');
        sessionStorage.setItem('adminSessionExpiry', Date.now() + 24 * 60 * 60 * 1000); // 24 hours

        // Clear form
        passwordInput.value = '';

        console.log('‚úÖ Admin logged in successfully with password');
      } catch (error) {
        console.error('Email/Password authentication error:', error);

        // Handle specific error types
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          adminError.textContent = 'Invalid password';
        } else if (error.code === 'auth/too-many-requests') {
          adminError.textContent = 'Too many failed attempts. Please try again later.';
        } else if (error.code === 'auth/network-request-failed') {
          adminError.textContent = 'Network error. Please check your connection.';
        } else if (error.message?.includes('Firebase not initialized')) {
          adminError.textContent = 'Loading... Please wait and try again';
        } else {
          adminError.textContent = error.message || 'Authentication failed. Please try again.';
        }
        adminError.style.display = 'block';
      } finally {
        // Re-enable button
        adminEmailPasswordBtn.disabled = false;
        adminEmailPasswordBtn.textContent = 'üîë Login with Password';
      }
    });

    // Submit Admin Request button handler
    document.getElementById('submitAdminRequestBtn')?.addEventListener('click', async () => {
      const adminError = document.getElementById('adminError');
      const submitBtn = document.getElementById('submitAdminRequestBtn');
      const nameInput = document.getElementById('requestAdminName');
      adminError.style.display = 'none';

      try {
        const currentUser = window.auth.currentUser;
        if (!currentUser) {
          throw new Error('Please sign in first');
        }

        const name = nameInput.value.trim();
        if (!name) {
          throw new Error('Please enter your name');
        }

        // Disable button during processing
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        // Check if Firebase is ready
        if (!window.db || !window.firestoreImports) {
          throw new Error('Firebase not initialized. Please refresh and try again.');
        }

        const { collection, addDoc } = window.firestoreImports;

        // Submit admin request to Firestore
        await addDoc(collection(window.db, 'admin_requests'), {
          email: currentUser.email,
          name: name,
          uid: currentUser.uid,
          status: 'pending',
          requestedAt: new Date(),
        });

        adminError.textContent = '‚úÖ Admin access request submitted! You will be notified once approved.';
        adminError.style.color = 'var(--success)';
        adminError.style.display = 'block';

        // Clear form
        nameInput.value = '';

        setTimeout(() => {
          adminModal.classList.remove('active');
          adminError.style.display = 'none';
          adminError.style.color = '';
        }, 3000);

      } catch (error) {
        console.error('Error submitting admin request:', error);
        adminError.textContent = error.message || 'Failed to submit request. Please try again.';
        adminError.style.display = 'block';
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'üìù Submit Request';
      }
    });

    // Allow Enter key to submit email/password form
    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('adminEmailPasswordBtn').click();
      }
    });

    waitForFirebase(() => {
      const { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot } = window.firestoreImports;
      const db = window.db;

      // Load games from Firestore in real-time
      function loadGames() {
        console.log('üì• Loading games from Firestore...');
        const gamesCollection = collection(db, 'games');

        onSnapshot(gamesCollection, (snapshot) => {
          console.log(`üìä Loaded ${snapshot.size} games from database`);
          const tbody = document.querySelector('#scheduleTable tbody');
          tbody.innerHTML = ''; // Clear existing rows

          if (snapshot.empty) {
            console.log('‚ÑπÔ∏è No games in database yet');
          }

          // Convert snapshot to array and sort by date and time
          const games = [];
          snapshot.forEach((docSnapshot) => {
            games.push({
              id: docSnapshot.id,
              data: docSnapshot.data()
            });
          });

          // Sort games chronologically by date, then by time
          games.sort((a, b) => {
            const dateA = a.data.date || '9999-12-31'; // Put games without dates at the end
            const dateB = b.data.date || '9999-12-31';

            if (dateA !== dateB) {
              return dateA.localeCompare(dateB);
            }

            // If dates are the same, sort by time
            const timeA = convertTo24Hour(a.data.time || '');
            const timeB = convertTo24Hour(b.data.time || '');
            return timeA.localeCompare(timeB);
          });

          // Render sorted games
          games.forEach(({ id, data: game }) => {
            const row = tbody.insertRow();
            row.dataset.docId = id;
            row.innerHTML = `
              <td>${game.date || ''}</td>
              <td>${game.day}</td>
              <td>${game.time}</td>
              <td>${game.matchup}</td>
              <td>${game.court}</td>
              <td>${game.round}</td>
              <td><span class="badge">${game.status}</span></td>
              <td>
                <button class="edit-btn" onclick="editGame(this)">Edit</button>
                <button class="delete-btn" onclick="deleteGame(this)">Delete</button>
              </td>
            `;
          });
        }, (error) => {
          console.error('‚ùå Error loading games:', error);
          alert('Error loading games from database: ' + error.message);
        });
      }

      // Helper function to convert 12-hour time to 24-hour for sorting
      function convertTo24Hour(timeStr) {
        if (!timeStr) return '00:00';

        const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
        if (!match) return timeStr;

        let [_, hours, minutes, period] = match;
        hours = parseInt(hours);

        if (period.toUpperCase() === 'PM' && hours !== 12) {
          hours += 12;
        } else if (period.toUpperCase() === 'AM' && hours === 12) {
          hours = 0;
        }

        return `${hours.toString().padStart(2, '0')}:${minutes}`;
      }

      // Start loading games
      loadGames();

      // Auto-delete completed games older than 1 day
      async function cleanupOldGames() {
        try {
          const { collection, query, where, getDocs, deleteDoc, doc } = window.firestoreImports;
          const gamesRef = collection(db, 'games');

          const snapshot = await getDocs(gamesRef);
          const oneDayAgo = new Date();
          oneDayAgo.setDate(oneDayAgo.getDate() - 1);

          let deletedCount = 0;
          for (const docSnap of snapshot.docs) {
            const game = docSnap.data();

            if (game.status === 'Completed' && game.completedAt) {
              const completedDate = new Date(game.completedAt);

              if (completedDate < oneDayAgo) {
                await deleteDoc(doc(db, 'games', docSnap.id));
                console.log(`üóëÔ∏è Deleted old game: ${game.matchup}`);
                deletedCount++;
              }
            }
          }

          if (deletedCount > 0) {
            console.log(`‚úÖ Cleaned up ${deletedCount} old completed game(s)`);
          }
        } catch (error) {
          console.error('‚ùå Error cleaning up old games:', error);
        }
      }

      // Run cleanup on page load
      cleanupOldGames();

      // Run cleanup every hour
      setInterval(cleanupOldGames, 60 * 60 * 1000);

      // Teams data - will be loaded from Firestore
      let teamsData = {};
      let bracketData = {};

      // Load teams from Firestore in real-time
      function loadTeams() {
        console.log('üì• Loading teams from Firestore...');
        const teamsCollection = collection(db, 'teams');

        onSnapshot(teamsCollection, (snapshot) => {
          console.log(`üìä Loaded ${snapshot.size} teams from database`);
          teamsData = {}; // Reset teams data

          snapshot.forEach((docSnapshot) => {
            const teamId = docSnapshot.id;
            const teamDataFromDb = docSnapshot.data();
            teamsData[teamId] = teamDataFromDb;
          });

          // Render teams grid
          renderTeamsGrid();

          // Update stats bar with new team/player counts
          if (typeof updateStatsBar === 'function') {
            updateStatsBar();
          }
        }, (error) => {
          console.error('‚ùå Error loading teams:', error);
          alert('Error loading teams from database: ' + error.message);
        });
      }

      // Render teams grid
      function renderTeamsGrid() {
        const grid = document.getElementById('teamsGrid');
        grid.innerHTML = '';

        // Sort teams by seed
        const sortedTeams = Object.entries(teamsData).sort((a, b) => {
          const seedA = a[1].seed || 999;
          const seedB = b[1].seed || 999;
          return seedA - seedB;
        });

        sortedTeams.forEach(([teamId, team]) => {
          const card = document.createElement('article');
          card.className = 'team-card';
          card.dataset.team = teamId;

          const seedDisplay = team.seed ? `<span class="pill" title="Seed">#${team.seed}</span>` : '';

          card.innerHTML = `
            <button class="edit-icon-btn" onclick="editTeamIcon('${teamId}')">Edit Icon</button>
            <button class="edit-btn edit-team-btn" onclick="editTeamData('${teamId}')">Edit Team</button>
            <div class="avatar" aria-hidden="true">${team.icon || 'üèÄ'}</div>
            <div>
              <h4>${team.name} ${seedDisplay}</h4>
              <p>Seed #${team.seed || 'N/A'} ‚Ä¢ Click to view roster and stats</p>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // Start loading teams
      loadTeams();

      // Load bracket from Firestore in real-time
      function loadBracket() {
        console.log('üì• Loading bracket from Firestore...');
        const { doc, onSnapshot } = window.firestoreImports;
        const bracketRef = doc(db, 'tournament', 'bracket');

        onSnapshot(bracketRef, (docSnap) => {
          if (docSnap.exists()) {
            bracketData = docSnap.data();
            console.log('üìä Loaded bracket data from database');

            // Update all bracket slots
            Object.entries(bracketData).forEach(([slotId, teamName]) => {
              const slotElement = document.querySelector(`[data-slot="${slotId}"] .team-name`);
              if (slotElement) {
                slotElement.textContent = teamName || 'TBD';
              }
            });

            // Update stats bar with champion name
            if (typeof updateStatsBar === 'function') {
              updateStatsBar();
            }
          } else {
            console.log('‚ÑπÔ∏è No bracket data in database yet');
          }
        }, (error) => {
          console.error('‚ùå Error loading bracket:', error);
        });
      }

      // Start loading bracket
      loadBracket();

      // Track visitor count
      async function trackVisitor() {
        try {
          const { doc, getDoc, setDoc, increment } = window.firestoreImports;
          const visitorRef = doc(db, 'system', 'visitor_count');

          // Check if visitor has already been counted in this session
          if (sessionStorage.getItem('visitorCounted')) {
            console.log('Visitor already counted in this session');
            return;
          }

          // Increment visitor count
          const visitorDoc = await getDoc(visitorRef);
          if (visitorDoc.exists()) {
            const currentCount = visitorDoc.data().count || 0;
            await setDoc(visitorRef, {
              count: currentCount + 1,
              lastVisit: new Date().toISOString()
            });
          } else {
            // Initialize visitor count
            await setDoc(visitorRef, {
              count: 1,
              lastVisit: new Date().toISOString()
            });
          }

          // Mark this session as counted
          sessionStorage.setItem('visitorCounted', 'true');
          console.log('‚úÖ Visitor tracked');
        } catch (error) {
          console.error('‚ùå Error tracking visitor:', error);
        }
      }

      // Track visitor on page load
      trackVisitor();

      // Load visitor count for admin
      function loadVisitorCount() {
        const { doc, onSnapshot } = window.firestoreImports;
        const visitorRef = doc(db, 'system', 'visitor_count');

        onSnapshot(visitorRef, (docSnap) => {
          if (docSnap.exists()) {
            const visitorCount = docSnap.data().count || 0;
            const visitorDisplay = document.getElementById('visitorCount');
            if (visitorDisplay) {
              visitorDisplay.textContent = visitorCount.toLocaleString();
            }
          }
        });
      }

      // Start loading visitor count
      loadVisitorCount();

      // Helper function to find team ID by name
      function findTeamIdByName(teamName) {
        return Object.keys(teamsData).find(id =>
          teamsData[id].name.toLowerCase() === teamName.toLowerCase().trim()
        );
      }

      // Helper function to update team games in Firestore
      async function syncGameToTeams(gameData, gameId) {
        const { doc, updateDoc, getDoc } = window.firestoreImports;

        // Parse matchup to get team names
        const matchupParts = gameData.matchup.split(' vs ');
        if (matchupParts.length !== 2) {
          console.error('Invalid matchup format:', gameData.matchup);
          return;
        }

        const team1Name = matchupParts[0].trim();
        const team2Name = matchupParts[1].trim();

        const team1Id = findTeamIdByName(team1Name);
        const team2Id = findTeamIdByName(team2Name);

        if (!team1Id || !team2Id) {
          console.warn('Could not find team IDs for:', team1Name, 'vs', team2Name);
          return;
        }

        // Only sync to upcoming games - completed games are handled by the complete game modal
        const isCompleted = gameData.status === 'Completed';

        if (isCompleted) {
          // Don't do anything here - completed games are handled by the complete game modal
          return;
        }

        try {
          // Update team 1 - add to upcoming games
          const team1Ref = doc(db, 'teams', team1Id);
          const team1Doc = await getDoc(team1Ref);
          if (team1Doc.exists()) {
            const team1Data = team1Doc.data();
            const upcomingGames = team1Data.upcomingGames || [];

            // Remove any existing entry for this game
            const filteredGames = upcomingGames.filter(
              g => !(g.opponent === team2Name && g.date === gameData.day)
            );

            // Add the new/updated game
            filteredGames.push({
              opponent: team2Name,
              date: gameData.day,
              time: gameData.time,
              court: gameData.court,
              round: gameData.round
            });

            await updateDoc(team1Ref, {
              upcomingGames: filteredGames
            });
          }

          // Update team 2 - add to upcoming games
          const team2Ref = doc(db, 'teams', team2Id);
          const team2Doc = await getDoc(team2Ref);
          if (team2Doc.exists()) {
            const team2Data = team2Doc.data();
            const upcomingGames = team2Data.upcomingGames || [];

            // Remove any existing entry for this game
            const filteredGames = upcomingGames.filter(
              g => !(g.opponent === team1Name && g.date === gameData.day)
            );

            // Add the new/updated game
            filteredGames.push({
              opponent: team1Name,
              date: gameData.day,
              time: gameData.time,
              court: gameData.court,
              round: gameData.round
            });

            await updateDoc(team2Ref, {
              upcomingGames: filteredGames
            });
          }

          console.log('‚úÖ Synced game to teams:', team1Name, 'vs', team2Name);
        } catch (error) {
          console.error('‚ùå Error syncing game to teams:', error);
        }
      }

      // Helper function to remove game from teams
      async function removeGameFromTeams(matchup, day) {
        const { doc, updateDoc, getDoc } = window.firestoreImports;

        const matchupParts = matchup.split(' vs ');
        if (matchupParts.length !== 2) return;

        const team1Name = matchupParts[0].trim();
        const team2Name = matchupParts[1].trim();

        const team1Id = findTeamIdByName(team1Name);
        const team2Id = findTeamIdByName(team2Name);

        if (!team1Id || !team2Id) return;

        try {
          // Update team 1
          const team1Ref = doc(db, 'teams', team1Id);
          const team1Doc = await getDoc(team1Ref);
          if (team1Doc.exists()) {
            const team1Data = team1Doc.data();
            const upcomingGames = (team1Data.upcomingGames || []).filter(
              g => !(g.opponent === team2Name && g.date === day)
            );
            const completedGames = (team1Data.completedGames || []).filter(
              g => !(g.opponent === team2Name && g.date === day)
            );

            await updateDoc(team1Ref, {
              upcomingGames: upcomingGames,
              completedGames: completedGames
            });
          }

          // Update team 2
          const team2Ref = doc(db, 'teams', team2Id);
          const team2Doc = await getDoc(team2Ref);
          if (team2Doc.exists()) {
            const team2Data = team2Doc.data();
            const upcomingGames = (team2Data.upcomingGames || []).filter(
              g => !(g.opponent === team1Name && g.date === day)
            );
            const completedGames = (team2Data.completedGames || []).filter(
              g => !(g.opponent === team1Name && g.date === day)
            );

            await updateDoc(team2Ref, {
              upcomingGames: upcomingGames,
              completedGames: completedGames
            });
          }

          console.log('‚úÖ Removed game from teams:', team1Name, 'vs', team2Name);
        } catch (error) {
          console.error('‚ùå Error removing game from teams:', error);
        }
      }

    // Navigation code moved to js/ui/navigation.logic.js

    // Modal functionality
    const modal = document.getElementById('teamModal');
    const closeBtn = document.getElementById('closeModal');

    function openTeamModal(teamId) {
      const team = teamsData[teamId];
      if (!team) return;

      document.getElementById('modalTeamName').textContent = team.name;
      document.getElementById('teamRecord').textContent = `${team.record?.wins || 0}-${team.record?.losses || 0}`;
      document.getElementById('teamDiff').textContent = team.pointDiff > 0 ? `+${team.pointDiff}` : (team.pointDiff || 0);
      document.getElementById('teamSeedDisplay').textContent = team.seed ? `#${team.seed}` : 'N/A';

      // Populate roster
      const rosterList = document.getElementById('rosterList');
      if (team.roster && team.roster.length > 0) {
        rosterList.innerHTML = team.roster.map(player =>
          `<li>
            <span>
              ${player.name}
              ${player.isCaptain ? '<span class="captain-badge">CAPTAIN</span>' : ''}
            </span>
          </li>`
        ).join('');
      } else {
        rosterList.innerHTML = '<li style="color: var(--muted); text-align: center;">No roster available</li>';
      }

      // Populate completed games
      const completedDiv = document.getElementById('completedGames');
      completedDiv.innerHTML = team.completedGames.length ? team.completedGames.map(game =>
        `<div class="game-item">
          <div class="game-header">
            <span class="matchup">${game.result === 'W' ? '‚úì' : '‚úó'} vs ${game.opponent}</span>
            <span class="badge">${game.score}</span>
          </div>
          <div class="game-info">${game.date}</div>
        </div>`
      ).join('') : '<p style="color: var(--muted);">No completed games yet</p>';

      // Populate upcoming games
      const upcomingDiv = document.getElementById('upcomingGames');
      upcomingDiv.innerHTML = team.upcomingGames.length ? team.upcomingGames.map(game =>
        `<div class="game-item">
          <div class="game-header">
            <span class="matchup">vs ${game.opponent}</span>
            <span class="badge">${game.court}</span>
          </div>
          <div class="game-info">${game.date} at ${game.time}</div>
        </div>`
      ).join('') : '<p style="color: var(--muted);">No upcoming games scheduled</p>';

      modal.classList.add('active');
    }

    closeBtn.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });

    // Team card click handlers
    document.getElementById('teamsGrid').addEventListener('click', (e) => {
      // Don't open modal if clicking edit icon button or edit button
      if (e.target.classList.contains('edit-icon-btn') || e.target.classList.contains('edit-btn')) {
        return;
      }

      const card = e.target.closest('.team-card');
      if (card) {
        const teamId = card.dataset.team;
        openTeamModal(teamId);
      }
    });

    // Edit team data functionality
    const editTeamModal = document.getElementById('editTeamModal');
    const teamForm = document.getElementById('teamForm');
    const cancelTeamEdit = document.getElementById('cancelTeamEdit');
    const rosterManager = document.getElementById('rosterManager');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    let currentEditTeamId = null;
    let currentRoster = [];

    // Render roster in edit modal
    function renderRosterManager() {
      rosterManager.innerHTML = '';

      if (currentRoster.length === 0) {
        rosterManager.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No players added yet</p>';
        return;
      }

      currentRoster.forEach((player, index) => {
        const rosterItem = document.createElement('div');
        rosterItem.className = 'roster-item';
        rosterItem.innerHTML = `
          <div class="roster-item-info">
            <div class="roster-item-name">
              ${player.name}
              ${player.isCaptain ? '<span class="captain-badge">CAPTAIN</span>' : ''}
            </div>
          </div>
          <div class="roster-item-actions">
            ${!player.isCaptain ? `<button type="button" class="make-captain-btn" onclick="makeCaptain(${index})">Make Captain</button>` : ''}
            <button type="button" class="remove-player-btn" onclick="removeRosterPlayer(${index})">Remove</button>
          </div>
        `;
        rosterManager.appendChild(rosterItem);
      });
    }

    // Add player to roster
    addPlayerBtn.addEventListener('click', () => {
      const nameInput = document.getElementById('newPlayerName');
      const name = nameInput.value.trim();

      if (!name) {
        alert('Please enter a player name');
        return;
      }

      // Check if player already exists
      if (currentRoster.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        alert('This player is already on the roster');
        return;
      }

      currentRoster.push({
        name: name,
        isCaptain: false
      });

      nameInput.value = '';
      renderRosterManager();
    });

    // Make player captain
    window.makeCaptain = function(index) {
      // Remove captain status from all players
      currentRoster.forEach(p => p.isCaptain = false);
      // Set this player as captain
      currentRoster[index].isCaptain = true;
      renderRosterManager();
    };

    // Remove player from roster (admin roster manager)
    window.removeRosterPlayer = function(index) {
      if (confirm('Remove this player from the roster?')) {
        currentRoster.splice(index, 1);
        renderRosterManager();
      }
    };

    window.editTeamData = function(teamId) {
      if (!isAdminMode) return;

      currentEditTeamId = teamId;
      const team = teamsData[teamId];

      if (!team) return;

      document.getElementById('editTeamName').value = team.name;
      document.getElementById('teamSeed').value = team.seed;
      document.getElementById('teamWins').value = team.record?.wins || 0;
      document.getElementById('teamLosses').value = team.record?.losses || 0;
      document.getElementById('teamPointDiff').value = team.pointDiff || 0;

      // Load roster
      currentRoster = team.roster ? JSON.parse(JSON.stringify(team.roster)) : [];
      renderRosterManager();

      editTeamModal.classList.add('active');
    };

    cancelTeamEdit.addEventListener('click', () => {
      editTeamModal.classList.remove('active');
    });

    editTeamModal.addEventListener('click', (e) => {
      if (e.target === editTeamModal) {
        editTeamModal.classList.remove('active');
      }
    });

    teamForm.addEventListener('submit', (e) => {
      e.preventDefault();

      if (!currentEditTeamId) return;

      const { doc, updateDoc } = window.firestoreImports;
      const teamRef = doc(db, 'teams', currentEditTeamId);

      const updatedData = {
        name: document.getElementById('editTeamName').value,
        seed: parseInt(document.getElementById('teamSeed').value),
        record: {
          wins: parseInt(document.getElementById('teamWins').value),
          losses: parseInt(document.getElementById('teamLosses').value)
        },
        pointDiff: parseInt(document.getElementById('teamPointDiff').value),
        roster: currentRoster
      };

      updateDoc(teamRef, updatedData).then(() => {
        console.log('Team updated in database');
        editTeamModal.classList.remove('active');
      }).catch(error => {
        console.error('Error updating team:', error);
        alert('Error updating team: ' + error.message);
      });
    });

    // Copy link
    const chip = document.getElementById('copyLink');
    chip?.addEventListener('click', async () => {
      try { 
        await navigator.clipboard.writeText(location.href); 
        chip.textContent = 'Link copied!'; 
        setTimeout(() => chip.textContent = 'iba.tourney/2025', 1200); 
      } catch {}
    });

    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // Update stats bar counts
    function updateStatsBar() {
      // Update teams count
      const teamsCountEl = document.getElementById('teamsCount');
      if (teamsCountEl) {
        teamsCountEl.textContent = Object.keys(teamsData).length;
      }

      // Update players count (sum of all roster sizes)
      const playersCountEl = document.getElementById('playersCount');
      if (playersCountEl) {
        let totalPlayers = 0;
        Object.values(teamsData).forEach(team => {
          if (team.roster && Array.isArray(team.roster)) {
            totalPlayers += team.roster.length;
          }
        });
        playersCountEl.textContent = totalPlayers > 0 ? totalPlayers : '64+';
      }

      // Update champion name from bracket
      const championNameEl = document.getElementById('championName');
      if (championNameEl && bracketData) {
        const champion = bracketData['champion'];
        if (champion && champion !== 'TBD') {
          championNameEl.textContent = champion;
          championNameEl.style.fontSize = '1.5rem';
        } else {
          championNameEl.textContent = 'TBD';
          championNameEl.style.fontSize = '1.5rem';
        }
      }
    }

    // Initial update
    updateStatsBar();
    // Update whenever games change (use MutationObserver)
    const scheduleTable = document.querySelector('#scheduleTable tbody');
    if (scheduleTable) {
      const observer = new MutationObserver(updateStatsBar);
      observer.observe(scheduleTable, { childList: true });
    }

    // Admin lock monitoring function
    function startAdminLockMonitor() {
      const { doc, onSnapshot } = window.firestoreImports;
      const adminLockRef = doc(db, 'system', 'adminLock');

      // Listen for changes to admin lock
      window.adminLockUnsubscribe = onSnapshot(adminLockRef, (docSnap) => {
        if (isAdminMode && docSnap.exists()) {
          const lockData = docSnap.data();

          // If lock is released, log out this admin
          if (!lockData.isLocked) {
            console.log('Admin lock released - logging out');
            isAdminMode = false;
            document.body.classList.remove('admin-mode');
            adminBtn.textContent = 'Admin';
            adminBtn.style.background = 'var(--brand)';
            document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = 'none');
            quickAddSection.style.display = 'none';
            const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
            if (bulkImportBtn) bulkImportBtn.style.display = 'none';

            // Stop monitoring
            if (window.adminLockUnsubscribe) {
              window.adminLockUnsubscribe();
              window.adminLockUnsubscribe = null;
            }

            // Show notification
            alert('Admin session ended.');
          }
        }
      });
    }

    // Add game functionality
    const addGameBtn = document.getElementById('addGameBtn');
    const editGameModal = document.getElementById('editGameModal');
    const gameForm = document.getElementById('gameForm');
    const cancelEdit = document.getElementById('cancelEdit');
    const editGameTitle = document.getElementById('editGameTitle');
    const quickAddSection = document.querySelector('.quick-add-section');
    const quickAddInput = document.getElementById('quickAddInput');
    const quickAddBtn = document.getElementById('quickAddBtn');

    addGameBtn.addEventListener('click', () => {
      currentEditRow = null;
      editGameTitle.textContent = 'Add New Game';
      gameForm.reset();
      editGameModal.classList.add('active');
    });

    // Quick add functionality
    quickAddBtn.addEventListener('click', async () => {
      const input = quickAddInput.value.trim();
      if (!input) {
        alert('Please enter game details');
        return;
      }

      const parts = input.split(',').map(p => p.trim());
      if (parts.length !== 7) {
        alert('Invalid format. Use: Team1 vs Team2,Date,Day,Time,Court,Round,Status');
        return;
      }

      const [matchup, date, day, timeRaw, court, round, status] = parts;

      // Check if matchup contains " vs " (with spaces)
      if (!matchup.includes(' vs ')) {
        alert('Matchup must use " vs " format (e.g., "Team A vs Team B")');
        return;
      }

      // Convert time format (800pm -> 8:00 PM, 1000pm -> 10:00 PM)
      let time = timeRaw.toLowerCase().replace('pm', ' PM').replace('am', ' AM');
      time = time.replace(/(\d{1,2})(\d{2})\s/, '$1:$2 ');

      const gameData = {
        date,
        day,
        time,
        matchup, // Already has " vs " in it
        court,
        round,
        status
      };

      const { collection, addDoc } = window.firestoreImports;
      const db = window.db;

      try {
        const docRef = await addDoc(collection(db, 'games'), gameData);

        // Sync to teams
        await syncGameToTeams(gameData, docRef.id);

        quickAddInput.value = '';
        alert('Game added successfully!');
      } catch (error) {
        console.error('Error adding game:', error);
        alert('Error adding game: ' + error.message);
      }
    });

    // Allow Enter key for quick add
    quickAddInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        quickAddBtn.click();
      }
    });

    // Team icon editing functionality
    const editIconModal = document.getElementById('editIconModal');
    const editIconTeamName = document.getElementById('editIconTeamName');
    const iconPicker = document.getElementById('iconPicker');
    const cancelIconEdit = document.getElementById('cancelIconEdit');
    const saveIconBtn = document.getElementById('saveIcon');
    let currentEditTeam = null;
    let selectedIcon = null;

    const availableIcons = ['üèÄ', 'üî•', '‚ö°', 'üí™', 'üèÜ', 'üëë', '‚≠ê', 'üåü', 'üíé', 'üöÄ', 'üõ°Ô∏è', 'üéØ', 'ü™£', 'üå∂Ô∏è', 'üèüÔ∏è', '‚öΩ', 'üéÆ', 'üé®', 'ü¶Å', 'üêØ', 'ü¶Ö', 'üêâ', 'ü¶à', 'üê∫', 'ü¶ä', 'üêª', 'ü¶Ñ', 'üî±', '‚öîÔ∏è', 'üé™'];

    window.editTeamIcon = function(teamId) {
      if (!isAdminMode) return;
      
      currentEditTeam = teamId;
      const team = teamsData[teamId];
      editIconTeamName.textContent = team.name;
      
      // Get current icon
      const teamCard = document.querySelector(`[data-team="${teamId}"]`);
      const currentIcon = teamCard.querySelector('.avatar').textContent;
      selectedIcon = currentIcon;
      
      // Populate icon picker
      iconPicker.innerHTML = availableIcons.map(icon => 
        `<div class="icon-option ${icon === currentIcon ? 'selected' : ''}" data-icon="${icon}">${icon}</div>`
      ).join('');
      
      // Add click handlers
      iconPicker.querySelectorAll('.icon-option').forEach(option => {
        option.addEventListener('click', () => {
          iconPicker.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedIcon = option.dataset.icon;
        });
      });
      
      editIconModal.classList.add('active');
    };

    cancelIconEdit.addEventListener('click', () => {
      editIconModal.classList.remove('active');
    });

    editIconModal.addEventListener('click', (e) => {
      if (e.target === editIconModal) {
        editIconModal.classList.remove('active');
      }
    });

    saveIconBtn.addEventListener('click', () => {
      if (!currentEditTeam || !selectedIcon) return;

      // Save to Firestore
      const { doc, updateDoc } = window.firestoreImports;
      const teamRef = doc(db, 'teams', currentEditTeam);

      updateDoc(teamRef, { icon: selectedIcon }).then(() => {
        console.log('Team icon updated in database');
        editIconModal.classList.remove('active');
      }).catch(error => {
        console.error('Error updating team icon:', error);
        alert('Error updating team icon: ' + error.message);
      });
    });

    // Bracket editing functionality
    window.editBracketSlot = function(slotId) {
      if (!isAdminMode) return;

      const currentName = document.querySelector(`[data-slot="${slotId}"] .team-name`).textContent;
      const teamName = prompt('Enter team name for this slot:', currentName);

      if (teamName !== null) {
        const newName = teamName.trim() || 'TBD';
        document.querySelector(`[data-slot="${slotId}"] .team-name`).textContent = newName;

        // Save to Firebase
        const { doc, setDoc, getDoc } = window.firestoreImports;
        const bracketRef = doc(db, 'tournament', 'bracket');

        getDoc(bracketRef).then((docSnap) => {
          const currentBracket = docSnap.exists() ? docSnap.data() : {};
          currentBracket[slotId] = newName;

          setDoc(bracketRef, currentBracket).then(() => {
            console.log('Bracket updated in database');
          }).catch(error => {
            console.error('Error saving bracket:', error);
            alert('Error saving bracket: ' + error.message);
          });
        });
      }
    };

    // Bulk import bracket functionality
    const bulkImportBracketBtn = document.getElementById('bulkImportBracketBtn');
    const bulkImportModal = document.getElementById('bulkImportModal');
    const bulkBracketData = document.getElementById('bulkBracketData');
    const cancelBulkImport = document.getElementById('cancelBulkImport');
    const submitBulkImport = document.getElementById('submitBulkImport');

    bulkImportBracketBtn.addEventListener('click', () => {
      if (!isAdminMode) return;
      bulkImportModal.classList.add('active');
    });

    cancelBulkImport.addEventListener('click', () => {
      bulkImportModal.classList.remove('active');
    });

    bulkImportModal.addEventListener('click', (e) => {
      if (e.target === bulkImportModal) {
        bulkImportModal.classList.remove('active');
      }
    });

    submitBulkImport.addEventListener('click', () => {
      if (!isAdminMode) return;

      try {
        const bracketDataInput = bulkBracketData.value.trim();
        if (!bracketDataInput) {
          alert('Please enter bracket data');
          return;
        }

        const bracketObj = JSON.parse(bracketDataInput);

        // Validate the data structure
        if (typeof bracketObj !== 'object' || Array.isArray(bracketObj)) {
          alert('Invalid bracket data format. Must be a JSON object.');
          return;
        }

        // Save to Firestore
        const { doc, setDoc } = window.firestoreImports;
        const bracketRef = doc(db, 'tournament', 'bracket');

        setDoc(bracketRef, bracketObj).then(() => {
          console.log('‚úÖ Bracket imported successfully');
          alert('Bracket data imported successfully!');
          bulkImportModal.classList.remove('active');
          bulkBracketData.value = '';

          // Update UI immediately
          Object.entries(bracketObj).forEach(([slotId, teamName]) => {
            const slotElement = document.querySelector(`[data-slot="${slotId}"] .team-name`);
            if (slotElement) {
              slotElement.textContent = teamName || 'TBD';
            }
          });
        }).catch(error => {
          console.error('‚ùå Error importing bracket:', error);
          alert('Error importing bracket: ' + error.message);
        });
      } catch (error) {
        console.error('‚ùå Error parsing JSON:', error);
        alert('Invalid JSON format. Please check your data and try again.');
      }
    });

    cancelEdit.addEventListener('click', () => {
      editGameModal.classList.remove('active');
    });

    editGameModal.addEventListener('click', (e) => {
      if (e.target === editGameModal) {
        editGameModal.classList.remove('active');
      }
    });

    // Complete game modal logic
    const completeGameModal = document.getElementById('completeGameModal');
    const completeGameMatchup = document.getElementById('completeGameMatchup');
    const team1Score = document.getElementById('team1Score');
    const team2Score = document.getElementById('team2Score');
    const team1WinBtn = document.getElementById('team1WinBtn');
    const team2WinBtn = document.getElementById('team2WinBtn');
    const team1WinName = document.getElementById('team1WinName');
    const team2WinName = document.getElementById('team2WinName');
    const submitCompleteGame = document.getElementById('submitCompleteGame');
    const cancelCompleteGame = document.getElementById('cancelCompleteGame');
    let selectedWinner = null;
    let currentCompleteGameData = null;

    // Winner button selection
    team1WinBtn.addEventListener('click', () => {
      selectedWinner = 1;
      team1WinBtn.classList.add('selected');
      team2WinBtn.classList.remove('selected');
    });

    team2WinBtn.addEventListener('click', () => {
      selectedWinner = 2;
      team2WinBtn.classList.add('selected');
      team1WinBtn.classList.remove('selected');
    });

    cancelCompleteGame.addEventListener('click', () => {
      completeGameModal.classList.remove('active');
    });

    completeGameModal.addEventListener('click', (e) => {
      if (e.target === completeGameModal) {
        completeGameModal.classList.remove('active');
      }
    });

    submitCompleteGame.addEventListener('click', async () => {
      const score1 = parseInt(team1Score.value);
      const score2 = parseInt(team2Score.value);

      if (isNaN(score1) || isNaN(score2)) {
        alert('Please enter valid scores for both teams');
        return;
      }

      if (!selectedWinner) {
        alert('Please select a winner');
        return;
      }

      try {
        const { doc, updateDoc, getDoc } = window.firestoreImports;
        const gameRef = doc(db, 'games', currentCompleteGameData.docId);

        // Update game status to completed and add completion timestamp
        await updateDoc(gameRef, {
          status: 'Completed',
          completedAt: new Date().toISOString()
        });

        console.log('üéØ Completing game:', currentCompleteGameData.matchup);

        // Update team records with win/loss and score
        const teams = currentCompleteGameData.matchup.split(' vs ');
        const team1Name = teams[0].trim();
        const team2Name = teams[1].trim();

        console.log('üë• Team 1:', team1Name);
        console.log('üë• Team 2:', team2Name);
        console.log('üìã Available teams:', Object.keys(teamsData).map(id => teamsData[id].name));
        console.log('üìä Full teamsData:', teamsData);

        const team1Id = findTeamIdByName(team1Name);
        const team2Id = findTeamIdByName(team2Name);

        console.log('üîë Team 1 ID:', team1Id);
        console.log('üîë Team 2 ID:', team2Id);

        if (!team1Id || !team2Id) {
          console.error('‚ùå Could not find team IDs!');
          console.log('üîç Searching for:', team1Name, 'and', team2Name);
          console.log('üìù Team names in database:');
          Object.keys(teamsData).forEach(id => {
            console.log(`  - "${teamsData[id].name}" (ID: ${id})`);
          });
          alert('Error: Could not find teams. Please check console for details.');
          return;
        }

        if (team1Id && team2Id) {
          const team1Ref = doc(db, 'teams', team1Id);
          const team2Ref = doc(db, 'teams', team2Id);

          const team1Doc = await getDoc(team1Ref);
          const team2Doc = await getDoc(team2Ref);

          console.log('üìÑ Team 1 exists:', team1Doc.exists());
          console.log('üìÑ Team 2 exists:', team2Doc.exists());

          if (team1Doc.exists() && team2Doc.exists()) {
            const team1Data = team1Doc.data();
            const team2Data = team2Doc.data();

            // Determine winner and loser
            const team1Won = selectedWinner === 1;
            const team2Won = selectedWinner === 2;

            // Remove from upcoming games
            const team1UpcomingGames = (team1Data.upcomingGames || []).filter(
              g => !(g.opponent === team2Name && g.date === currentCompleteGameData.day)
            );
            const team2UpcomingGames = (team2Data.upcomingGames || []).filter(
              g => !(g.opponent === team1Name && g.date === currentCompleteGameData.day)
            );

            // Remove from completed games if already exists (to avoid duplicates), then add new one
            let team1CompletedGames = (team1Data.completedGames || []).filter(
              g => !(g.opponent === team2Name && g.date === currentCompleteGameData.day)
            );
            let team2CompletedGames = (team2Data.completedGames || []).filter(
              g => !(g.opponent === team1Name && g.date === currentCompleteGameData.day)
            );

            // Add the completed game with actual results
            team1CompletedGames.push({
              opponent: team2Name,
              result: team1Won ? 'W' : 'L',
              score: `${score1}-${score2}`,
              date: currentCompleteGameData.day
            });

            team2CompletedGames.push({
              opponent: team1Name,
              result: team2Won ? 'W' : 'L',
              score: `${score2}-${score1}`,
              date: currentCompleteGameData.day
            });

            console.log('üìù About to update teams:');
            console.log(`  Team 1 (${team1Name}) completed games:`, team1CompletedGames);
            console.log(`  Team 2 (${team2Name}) completed games:`, team2CompletedGames);

            // Update both teams (do not change win/loss records)
            await updateDoc(team1Ref, {
              upcomingGames: team1UpcomingGames,
              completedGames: team1CompletedGames
            });
            console.log('‚úÖ Team 1 updated successfully');

            await updateDoc(team2Ref, {
              upcomingGames: team2UpcomingGames,
              completedGames: team2CompletedGames
            });
            console.log('‚úÖ Team 2 updated successfully');

            console.log('‚úÖ Game completed and teams updated');
          }
        }

        // Close both modals
        completeGameModal.classList.remove('active');
        editGameModal.classList.remove('active');

        // Reset state
        currentEditRow = null;
        selectedWinner = null;
      } catch (error) {
        console.error('Error completing game:', error);
        alert('Error completing game: ' + error.message);
      }
    });

    gameForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const { collection, addDoc, updateDoc, doc } = window.firestoreImports;
      const db = window.db;

      const date = document.getElementById('gameDate').value;
      const day = document.getElementById('gameDay').value;
      const time = document.getElementById('gameTime').value;
      const matchup = document.getElementById('gameMatchup').value;
      const court = document.getElementById('gameCourt').value;
      const round = document.getElementById('gameRound').value;
      const status = document.getElementById('gameStatus').value;

      // Check if status is being changed to Completed
      if (status === 'Completed' && currentEditRow) {
        const docId = currentEditRow.dataset.docId;
        currentCompleteGameData = { docId, matchup, day, date, time, court, round };

        // Parse team names
        const teams = matchup.split(' vs ');
        if (teams.length !== 2) {
          alert('Invalid matchup format. Must be "Team A vs Team B"');
          return;
        }

        team1WinName.textContent = teams[0].trim();
        team2WinName.textContent = teams[1].trim();

        // Reset form
        team1Score.value = '';
        team2Score.value = '';
        selectedWinner = null;
        team1WinBtn.classList.remove('selected');
        team2WinBtn.classList.remove('selected');

        // Show complete game modal (don't close edit game modal yet)
        completeGameMatchup.textContent = matchup;
        completeGameModal.classList.add('active');
        return; // Stop here - don't save the game yet
      }

      const gameData = { date, day, time, matchup, court, round, status };

      try {
        if (currentEditRow) {
          // Update existing game in Firestore
          const docId = currentEditRow.dataset.docId;
          const gameRef = doc(db, 'games', docId);
          await updateDoc(gameRef, gameData);

          // Sync to teams only for non-completed games
          await syncGameToTeams(gameData, docId);

          editGameModal.classList.remove('active');
          currentEditRow = null; // Reset current edit row
        } else {
          // Add new game to Firestore
          const docRef = await addDoc(collection(db, 'games'), gameData);

          // Sync to teams
          await syncGameToTeams(gameData, docRef.id);

          editGameModal.classList.remove('active');
        }
      } catch (error) {
        console.error('Error saving game:', error);
        alert('Error saving game. Please try again.');
      }
    });

    // Edit and delete functions (global scope)
    window.editGame = function(btn) {
      if (!isAdminMode) return;
      currentEditRow = btn.closest('tr');
      const cells = currentEditRow.cells;

      editGameTitle.textContent = 'Edit Game';
      document.getElementById('gameDate').value = cells[0].textContent;
      document.getElementById('gameDay').value = cells[1].textContent;
      document.getElementById('gameTime').value = cells[2].textContent;
      document.getElementById('gameMatchup').value = cells[3].textContent;
      document.getElementById('gameCourt').value = cells[4].textContent;
      document.getElementById('gameRound').value = cells[5].textContent;
      document.getElementById('gameStatus').value = cells[6].querySelector('.badge').textContent.trim();

      editGameModal.classList.add('active');
    };

    window.deleteGame = async function(btn) {
      if (!isAdminMode) return;
      if (confirm('Are you sure you want to delete this game?')) {
        console.log('üóëÔ∏è Deleting game...');
        const { deleteDoc, doc } = window.firestoreImports;
        const db = window.db;

        const row = btn.closest('tr');
        const docId = row.dataset.docId;
        const matchup = row.cells[3].textContent;
        const day = row.cells[1].textContent;

        try {
          // Remove from teams first
          await removeGameFromTeams(matchup, day);

          // Then delete the game
          console.log('Deleting document ID:', docId);
          const gameRef = doc(db, 'games', docId);
          await deleteDoc(gameRef);
          console.log('‚úÖ Game deleted successfully');
        } catch (error) {
          console.error('‚ùå Error deleting game:', error);
          alert('Error deleting game: ' + error.message);
        }
      }
    };

    // Schedule filters
    const search = document.getElementById('search');
    const dayFilter = document.getElementById('dayFilter');
    const courtFilter = document.getElementById('courtFilter');
    const searchBtn = document.getElementById('searchBtn');
    const rows = document.querySelectorAll('#scheduleTable tbody tr');

    function applyFilters() {
      const q = (search.value || '').toLowerCase();
      const day = dayFilter.value;
      const court = courtFilter.value;
      const allRows = Array.from(document.querySelectorAll('#scheduleTable tbody tr'));
      allRows.forEach(tr => {
        const cells = tr.children;
        const matchesQuery = !q || tr.textContent.toLowerCase().includes(q);
        const matchesDay = !day || cells[1].textContent === day;
        const matchesCourt = !court || cells[4].textContent === court;
        tr.style.display = (matchesQuery && matchesDay && matchesCourt) ? '' : 'none';
      });
    }
    
    searchBtn.addEventListener('click', applyFilters);
    search.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
    [dayFilter, courtFilter].forEach(el => el.addEventListener('change', applyFilters));

    // Contact form submission
    const contactForm = document.getElementById('contactForm');
    const contactStatus = document.getElementById('contactStatus');

    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const contactInfo = document.getElementById('contactInfo').value;
      const message = document.getElementById('contactMessage').value;
      const submitBtn = document.getElementById('contactSubmit');

      // Disable button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      const messageData = {
        contactInfo: contactInfo,
        message: message,
        timestamp: new Date().toISOString(),
        read: false
      };

      try {
        const { collection, addDoc } = window.firestoreImports;
        await addDoc(collection(db, 'messages'), messageData);

        // Show success message
        contactStatus.style.display = 'block';
        contactStatus.style.background = '#22c55e';
        contactStatus.style.color = 'white';
        contactStatus.textContent = '‚úì Message sent successfully! We\'ll get back to you soon.';

        // Clear form
        contactForm.reset();

        // Hide success message after 5 seconds
        setTimeout(() => {
          contactStatus.style.display = 'none';
        }, 5000);
      } catch (error) {
        console.error('Error sending message:', error);

        // Show error message
        contactStatus.style.display = 'block';
        contactStatus.style.background = '#ef4444';
        contactStatus.style.color = 'white';
        contactStatus.textContent = '‚úó Error sending message. Please try again or contact us directly.';
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
      }
    });

    // ==================== TEAM MANAGEMENT FUNCTIONS ====================

    // Load team notifications for captain
    async function loadTeamNotifications(uid) {
      // Destructure Firestore functions
      const { collection, query, where, getDocs } = window.firestoreImports;

      try {
        const requestsRef = collection(db, 'team_join_requests');
        const q = query(requestsRef, where('captainUid', '==', uid), where('status', '==', 'pending'));
        const querySnapshot = await getDocs(q);

        const count = querySnapshot.size;
        const badge = document.getElementById('notificationBadge');

        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }

    // Create new team - scroll to tournament registration form
    document.getElementById('createTeamBtn')?.addEventListener('click', () => {
      // Scroll to the tournament registration form
      const tournamentSection = document.getElementById('panel-tournament');
      if (tournamentSection) {
        // First switch to the tournament tab
        const tournamentTab = document.getElementById('tab-tournament');
        if (tournamentTab) {
          tournamentTab.click();
        }

        // Then scroll to it after a brief delay
        setTimeout(() => {
          tournamentSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

          // Focus on the team name field
          const teamNameField = document.getElementById('teamName');
          if (teamNameField) {
            setTimeout(() => teamNameField.focus(), 500);
          }
        }, 200);
      }
    });

    // Load user's team
    async function loadMyTeam() {
      if (!window.currentUserData) return;

      try {
        const teamsRef = collection(db, 'player_teams');
        const q = query(teamsRef);
        const querySnapshot = await getDocs(q);

        let userTeam = null;
        querySnapshot.forEach((doc) => {
          const team = doc.data();
          const isMember = team.members.some(m => m.uid === window.currentUserData.uid);
          if (isMember) {
            userTeam = { id: doc.id, ...team };
          }
        });

        if (userTeam) {
          document.getElementById('noTeamDisplay').style.display = 'none';
          document.getElementById('myTeamDisplay').style.display = 'block';
          displayMyTeam(userTeam);
        } else {
          document.getElementById('noTeamDisplay').style.display = 'block';
          document.getElementById('myTeamDisplay').style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading my team:', error);
      }
    }

    // Display user's team
    function displayMyTeam(team) {
      const card = document.getElementById('myTeamCard');
      const isCaptain = team.captainUid === window.currentUserData.uid;

      let html = `
        <h4 style="color: var(--brand); margin-bottom: 0.5rem;">${team.name}</h4>
        <p style="color: var(--muted); margin-bottom: 1rem;">${team.description || 'No description'}</p>
        <p style="margin-bottom: 0.5rem;"><strong>Captain:</strong> ${team.captainName}</p>
        <p style="margin-bottom: 1rem;"><strong>Members (${team.members.length}):</strong></p>
        <ul style="list-style: none; padding: 0;">
      `;

      team.members.forEach(member => {
        html += `
          <li style="padding: 0.5rem; background: white; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <span>${member.name} ${member.role === 'captain' ? 'üëë' : ''}</span>
            ${isCaptain && member.uid !== window.currentUserData.uid ? `
              <button onclick="kickPlayer('${team.id}', '${member.uid}')" style="background: var(--danger); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 5px; cursor: pointer;">Kick</button>
            ` : ''}
          </li>
        `;
      });

      html += `</ul>`;

      if (isCaptain) {
        html += `
          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button onclick="viewJoinRequests('${team.id}')" style="background: var(--brand); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600;">View Join Requests</button>
            <button onclick="deleteTeam('${team.id}', '${team.name}')" style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600;">Delete Team</button>
          </div>
        `;
      }

      card.innerHTML = html;
    }

    // Make these functions global
    window.kickPlayer = async function(teamId, memberUid) {
      if (!confirm('Are you sure you want to kick this player?')) return;

      try {
        const teamRef = doc(db, 'player_teams', teamId);
        const teamDoc = await getDoc(teamRef);
        const team = teamDoc.data();

        const updatedMembers = team.members.filter(m => m.uid !== memberUid);

        await updateDoc(teamRef, { members: updatedMembers });
        alert('‚úÖ Player kicked from team');
        loadMyTeam();
      } catch (error) {
        console.error('Error kicking player:', error);
        alert('Failed to kick player');
      }
    };

    // Delete team (captain only)
    window.deleteTeam = async function(teamId, teamName) {
      const confirmed = confirm(`Are you sure you want to delete "${teamName}"?\n\nThis action cannot be undone. All team data will be permanently deleted.\n\nNon-captain players will be moved to free agency.`);
      if (!confirmed) return;

      let deletionSucceeded = false;

      try {
        const { doc, deleteDoc, getDoc, collection, query, where, getDocs, updateDoc, addDoc } = window.firestoreImports;

        // Get team data to find captain
        const teamDocRef = doc(window.db, 'teams', teamId);
        const teamDoc = await getDoc(teamDocRef);

        if (!teamDoc.exists()) {
          throw new Error('Team not found');
        }

        const teamData = teamDoc.data();
        const captainUid = teamData.captainUid;

        // Find all users on this team
        const usersQuery = query(
          collection(window.db, 'users'),
          where('teamId', '==', teamId)
        );
        const usersSnapshot = await getDocs(usersQuery);

        // Process all users: clear team info and create free agent profiles for non-captains
        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const isUserCaptain = userDoc.id === captainUid || userData.isCaptain === true;

          // Clear team info from user
          await updateDoc(doc(window.db, 'users', userDoc.id), {
            teamId: null,
            teamName: null,
            isCaptain: null
          });

          // If not captain, create free agent profile (check if one doesn't exist already)
          if (!isUserCaptain) {
            try {
              // Check if free agent profile already exists
              const freeAgentQuery = query(
                collection(window.db, 'freeAgents'),
                where('uid', '==', userDoc.id),
                where('status', '==', 'active')
              );
              const existingFreeAgent = await getDocs(freeAgentQuery);

              // Only create if doesn't exist
              if (existingFreeAgent.empty) {
                await addDoc(collection(window.db, 'freeAgents'), {
                  uid: userDoc.id,
                  email: userData.email,
                  displayName: userData.displayName || userData.email?.split('@')[0],
                  createdAt: new Date().toISOString(),
                  status: 'active'
                });
              }
            } catch (freeAgentError) {
              // Log but don't fail the whole operation if free agent creation fails
              console.warn('Could not create free agent for user:', userDoc.id, freeAgentError);
            }
          }
        }

        // Delete the team document
        await deleteDoc(teamDocRef);

        // Verify deletion succeeded
        const verifyDoc = await getDoc(teamDocRef);
        if (!verifyDoc.exists()) {
          deletionSucceeded = true;
        }

      } catch (error) {
        console.error('Error deleting team:', error);
        deletionSucceeded = false;
      }

      // Always reload and show result after operations complete
      if (deletionSucceeded) {
        alert(`‚úÖ Team "${teamName}" has been deleted successfully.\nNon-captain players have been moved to free agency.`);
      } else {
        alert('‚ùå Failed to delete team. Please try again or contact support if the issue persists.');
      }

      window.location.reload();
    };

    window.viewJoinRequests = function(teamId) {
      // Show notifications modal with join requests
      showJoinRequests(teamId);
    };

    // Show join requests in notifications modal
    async function showJoinRequests(teamId) {
      const modal = document.getElementById('notificationsModal');
      const content = document.getElementById('notificationsContent');

      try {
        const requestsRef = collection(db, 'team_join_requests');
        const q = query(requestsRef, where('teamId', '==', teamId), where('status', '==', 'pending'));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          content.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--muted);">No pending join requests</p>';
        } else {
          let html = '';
          querySnapshot.forEach((doc) => {
            const request = doc.data();
            html += `
              <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <p><strong>${request.playerName}</strong> wants to join your team</p>
                <p style="color: var(--muted); font-size: 0.9rem;">${request.playerEmail}</p>
                <p style="color: var(--muted); font-size: 0.85rem;">Requested: ${new Date(request.requestedAt).toLocaleDateString()}</p>
                <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                  <button onclick="acceptJoinRequest('${doc.id}', '${teamId}')" style="flex: 1; background: var(--success); color: white; border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer;">‚úÖ Accept</button>
                  <button onclick="rejectJoinRequest('${doc.id}')" style="flex: 1; background: var(--danger); color: white; border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer;">‚ùå Reject</button>
                </div>
              </div>
            `;
          });
          content.innerHTML = html;
        }

        modal.style.display = 'flex';
      } catch (error) {
        console.error('Error loading join requests:', error);
      }
    }

    // Accept join request
    window.acceptJoinRequest = async function(requestId, teamId) {
      try {
        const requestRef = doc(db, 'team_join_requests', requestId);
        const requestDoc = await getDoc(requestRef);
        const request = requestDoc.data();

        const teamRef = doc(db, 'player_teams', teamId);
        const teamDoc = await getDoc(teamRef);
        const team = teamDoc.data();

        // Add player to team
        const updatedMembers = [...team.members, {
          uid: request.playerUid,
          name: request.playerName,
          email: request.playerEmail,
          joinedAt: new Date().toISOString(),
          role: 'member'
        }];

        await updateDoc(teamRef, { members: updatedMembers });
        await updateDoc(requestRef, { status: 'accepted' });

        alert('‚úÖ Player added to team!');
        showJoinRequests(teamId);
        loadMyTeam();
        loadTeamNotifications(window.currentUserData.uid);
      } catch (error) {
        console.error('Error accepting request:', error);
        alert('Failed to accept request');
      }
    };

    // Reject join request
    window.rejectJoinRequest = async function(requestId) {
      try {
        const requestRef = doc(db, 'team_join_requests', requestId);
        await updateDoc(requestRef, { status: 'rejected' });

        alert('Request rejected');
        document.getElementById('notificationsModal').style.display = 'none';
        loadTeamNotifications(window.currentUserData.uid);
      } catch (error) {
        console.error('Error rejecting request:', error);
        alert('Failed to reject request');
      }
    };

    // Close notifications modal
    document.getElementById('closeNotifications')?.addEventListener('click', () => {
      document.getElementById('notificationsModal').style.display = 'none';
    });

    // Open notifications when bell icon clicked
    document.getElementById('notificationsIcon')?.addEventListener('click', async () => {
      if (!window.currentUserData) return;

      const modal = document.getElementById('notificationsModal');
      const content = document.getElementById('notificationsContent');

      try {
        // Find user's team
        const teamsRef = collection(db, 'player_teams');
        const teamsSnapshot = await getDocs(teamsRef);

        let userTeamId = null;
        teamsSnapshot.forEach((doc) => {
          const team = doc.data();
          if (team.captainUid === window.currentUserData.uid) {
            userTeamId = doc.id;
          }
        });

        if (userTeamId) {
          showJoinRequests(userTeamId);
        } else {
          content.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--muted);">You are not a team captain</p>';
          modal.style.display = 'flex';
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    });

    // Load all teams
    async function loadAllTeams() {
      try {
        const teamsRef = collection(db, 'player_teams');
        const querySnapshot = await getDocs(teamsRef);

        const grid = document.getElementById('allTeamsGrid');
        grid.innerHTML = '';

        if (querySnapshot.empty) {
          grid.innerHTML = '<p style="color: var(--muted);">No teams yet. Be the first to create one!</p>';
          return;
        }

        querySnapshot.forEach((doc) => {
          const team = doc.data();
          const isMember = team.members.some(m => m.uid === window.currentUserData?.uid);

          const card = document.createElement('div');
          card.style.cssText = 'background: #f8f9fa; padding: 1.5rem; border-radius: 15px;';

          card.innerHTML = `
            <h4 style="color: var(--brand); margin-bottom: 0.5rem;">${team.name}</h4>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.9rem;">${team.description || 'No description'}</p>
            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Captain:</strong> ${team.captainName}</p>
            <p style="font-size: 0.9rem; margin-bottom: 1rem;"><strong>Members:</strong> ${team.members.length}</p>
            ${!isMember && window.currentUserData ? `
              <button onclick="requestToJoinTeam('${doc.id}', '${team.name}', '${team.captainUid}')" style="width: 100%; background: var(--brand); color: white; border: none; padding: 0.75rem; border-radius: 10px; cursor: pointer; font-weight: 600;">Request to Join</button>
            ` : isMember ? `
              <p style="color: var(--success); font-weight: 600; text-align: center;">‚úÖ You're in this team</p>
            ` : ''}
          `;

          grid.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading teams:', error);
      }
    }

    // Request to join team
    window.requestToJoinTeam = async function(teamId, teamName, captainUid) {
      if (!window.currentUserData) return;

      try {
        const requestsRef = collection(db, 'team_join_requests');
        await addDoc(requestsRef, {
          teamId: teamId,
          teamName: teamName,
          captainUid: captainUid,
          playerUid: window.currentUserData.uid,
          playerName: window.currentUserData.displayName,
          playerEmail: window.currentUserData.email,
          status: 'pending',
          requestedAt: new Date().toISOString()
        });

        alert('‚úÖ Join request sent!');
      } catch (error) {
        console.error('Error sending join request:', error);
        alert('Failed to send join request');
      }
    };

    // Listen for tab changes to load teams
    document.getElementById('tab-myteams')?.addEventListener('click', () => {
      loadMyTeam();
      loadAllTeams();
    });

    // ============================================================================
    // ADMIN REQUESTS MANAGEMENT
    // ============================================================================

    let currentFilter = 'all';

    /**
     * Load and display admin requests
     */
    async function loadAdminRequests(filterStatus = 'all') {
      try {
        const { collection, getDocs, query, where, orderBy } = window.firestoreImports;
        const container = document.getElementById('adminRequestsContainer');
        const noRequestsMessage = document.getElementById('noRequestsMessage');

        if (!container) return;

        container.innerHTML = '<p style="color: var(--muted);">Loading requests...</p>';

        // Build query
        let requestsQuery;
        if (filterStatus === 'all') {
          requestsQuery = query(
            collection(db, 'admin_requests'),
            orderBy('requestedAt', 'desc')
          );
        } else {
          requestsQuery = query(
            collection(db, 'admin_requests'),
            where('status', '==', filterStatus),
            orderBy('requestedAt', 'desc')
          );
        }

        const snapshot = await getDocs(requestsQuery);

        if (snapshot.empty) {
          container.innerHTML = '';
          noRequestsMessage.style.display = 'block';
          return;
        }

        noRequestsMessage.style.display = 'none';
        container.innerHTML = '';

        snapshot.forEach((doc) => {
          const request = doc.data();
          const requestId = doc.id;

          const card = document.createElement('div');
          card.style.cssText = 'background: #0a1122; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative;';

          // Status color
          let statusColor = '#f39c12';
          if (request.status === 'approved') statusColor = 'var(--success)';
          if (request.status === 'rejected') statusColor = '#e74c3c';

          // Status badge
          const statusBadge = `<div style="position: absolute; top: 1rem; right: 1rem; background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; text-transform: uppercase; font-weight: 600;">${request.status}</div>`;

          // Avatar
          const avatarUrl = request.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(request.displayName || request.email.split('@')[0])}&background=CFB991&color=fff&size=128`;

          card.innerHTML = `
            ${statusBadge}
            <div style="text-align: center; margin-bottom: 1rem;">
              <img src="${avatarUrl}" alt="${request.displayName}" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--brand); object-fit: cover; margin-bottom: 0.5rem;">
              <h3 style="color: var(--text); margin: 0.5rem 0; font-size: 1.1rem;">${request.displayName || 'Unknown'}</h3>
              <p style="color: var(--muted); font-size: 0.9rem; word-break: break-all;">${request.email}</p>
            </div>

            <div style="margin: 1rem 0; padding-top: 1rem; border-top: 1px solid var(--border);">
              <p style="color: var(--muted); font-size: 0.85rem; margin: 0.25rem 0;">
                <strong>Requested:</strong> ${new Date(request.requestedAt).toLocaleString()}
              </p>
              ${request.lastUpdated && request.lastUpdated !== request.requestedAt ? `
                <p style="color: var(--muted); font-size: 0.85rem; margin: 0.25rem 0;">
                  <strong>Last Updated:</strong> ${new Date(request.lastUpdated).toLocaleString()}
                </p>
              ` : ''}
            </div>

            ${request.status === 'pending' ? `
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button onclick="approveAdminRequest('${requestId}')" class="admin-submit" style="flex: 1; background: var(--success); padding: 0.5rem;">
                  Approve
                </button>
                <button onclick="rejectAdminRequest('${requestId}')" class="admin-submit" style="flex: 1; background: #e74c3c; padding: 0.5rem;">
                  Reject
                </button>
              </div>
            ` : ''}
          `;

          container.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading admin requests:', error);
        const container = document.getElementById('adminRequestsContainer');
        if (container) {
          container.innerHTML = '<p style="color: #e74c3c;">Error loading admin requests. Please try again.</p>';
        }
      }
    }

    /**
     * Approve an admin request
     */
    window.approveAdminRequest = async function(requestId) {
      if (!confirm('Are you sure you want to approve this admin request?')) return;

      try {
        const { doc, updateDoc } = window.firestoreImports;
        await updateDoc(doc(db, 'admin_requests', requestId), {
          status: 'approved',
          lastUpdated: new Date().toISOString(),
          approvedBy: auth.currentUser.uid
        });

        console.log('‚úÖ Admin request approved');
        loadAdminRequests(currentFilter);
      } catch (error) {
        console.error('Error approving admin request:', error);
        alert('Failed to approve request. Please try again.');
      }
    };

    /**
     * Reject an admin request
     */
    window.rejectAdminRequest = async function(requestId) {
      if (!confirm('Are you sure you want to reject this admin request?')) return;

      try {
        const { doc, updateDoc } = window.firestoreImports;
        await updateDoc(doc(db, 'admin_requests', requestId), {
          status: 'rejected',
          lastUpdated: new Date().toISOString(),
          rejectedBy: auth.currentUser.uid
        });

        console.log('‚ùå Admin request rejected');
        loadAdminRequests(currentFilter);
      } catch (error) {
        console.error('Error rejecting admin request:', error);
        alert('Failed to reject request. Please try again.');
      }
    };

    // Filter button handlers
    document.getElementById('filterAll')?.addEventListener('click', () => {
      currentFilter = 'all';
      loadAdminRequests('all');
    });

    document.getElementById('filterPending')?.addEventListener('click', () => {
      currentFilter = 'pending';
      loadAdminRequests('pending');
    });

    document.getElementById('filterApproved')?.addEventListener('click', () => {
      currentFilter = 'approved';
      loadAdminRequests('approved');
    });

    document.getElementById('filterRejected')?.addEventListener('click', () => {
      currentFilter = 'rejected';
      loadAdminRequests('rejected');
    });

    // Load admin requests when tab is clicked
    document.getElementById('tab-adminrequests')?.addEventListener('click', () => {
      loadAdminRequests(currentFilter);
    });

    // Auth state listener for user profile display
    const { onAuthStateChanged, signOut } = window.authImports;
    onAuthStateChanged(auth, async (user) => {
      // Destructure Firestore functions for use in this callback
      const { doc, getDoc, query, where, collection, getDocs } = window.firestoreImports;

      const loginLink = document.getElementById('loginLink');
      const userProfileChip = document.getElementById('userProfileChip');
      const userDisplayName = document.getElementById('userDisplayName');
      const notificationsIcon = document.getElementById('notificationsIcon');
      const myTeamsTab = document.getElementById('tab-myteams');

      // Card navigation elements
      const navUserProfile = document.getElementById('navUserProfile');
      const navUserAvatar = document.getElementById('navUserAvatar');
      const navUserButton = document.getElementById('navUserButton');

      console.log('üîê Auth state changed. User:', user ? user.email : 'Not signed in');
      console.log('Nav elements found:', { navUserProfile: !!navUserProfile, navUserAvatar: !!navUserAvatar });
      console.log('Other elements found:', { loginLink: !!loginLink, userProfileChip: !!userProfileChip, userDisplayName: !!userDisplayName });

      if (user) {
        // User is signed in
        console.log('‚úÖ User is signed in:', user.email);
        if (loginLink) loginLink.style.display = 'none';
        if (userProfileChip) userProfileChip.style.display = 'block';
        if (userDisplayName) userDisplayName.textContent = user.displayName || user.email.split('@')[0];

        // Update hero button for authenticated users
        const heroBtn = document.getElementById('heroSignupBtn');
        const signupTab = document.getElementById('tab-signup');
        if (heroBtn) {
          heroBtn.textContent = 'Spring 2026 Tournament';
          // Set click handler to navigate to Teams -> All Teams
          heroBtn.onclick = (e) => {
            e.preventDefault();
            switchToTeamsTab('all');
          };
        }
        if (signupTab) {
          signupTab.innerHTML = 'üå∏ Spring 2026 Tournament';
        }

        // Auto-fill captain email in Create Team form
        const captainEmailInput = document.getElementById('captainEmail');
        if (captainEmailInput) {
          captainEmailInput.value = user.email;
          console.log('‚úÖ Auto-filled captain email:', user.email);
        }

        // Auto-fill free agency form fields
        const freeAgencyNameInput = document.getElementById('freeAgencyName');
        const freeAgencyEmailInput = document.getElementById('freeAgencyEmail');
        if (freeAgencyNameInput && freeAgencyEmailInput) {
          freeAgencyNameInput.value = user.displayName || user.email.split('@')[0];
          freeAgencyEmailInput.value = user.email;
          console.log('‚úÖ Auto-filled free agency form');
        }

        // Show user profile in card navigation
        if (navUserProfile) {
          navUserProfile.style.display = 'flex';
          console.log('Showing user profile');
        }
        if (navUserAvatar) {
          // Use Google profile photo if available, otherwise use a default avatar
          const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email.split('@')[0])}&background=CFB991&color=fff&size=128`;
          navUserAvatar.src = avatarUrl;
          navUserAvatar.alt = user.displayName || user.email;
          console.log('Set avatar URL:', avatarUrl);
        }

        // Navigate to profile page when user button is clicked
        if (navUserButton) {
          navUserButton.onclick = () => {
            window.location.href = 'profile.html';
          };
        }

        // Click to go to profile page
        if (userProfileChip) {
          userProfileChip.onclick = () => {
            window.location.href = 'profile.html';
          };
        }

        // Check if user has player role
        try {
          const userDocRef = doc(db, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();
            const roles = userData.roles || [];

            // Show player-only elements if user has player role
            if (roles.includes('player')) {
              if (myTeamsTab) myTeamsTab.style.display = 'block';
              if (notificationsIcon) notificationsIcon.style.display = 'block';

              // Store current user data globally for team management
              window.currentUserData = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                roles: roles
              };

              // Load team notifications
              loadTeamNotifications(user.uid);
            }
          }

          // Check if user is approved admin (from Firestore)
          const isAdmin = await isApprovedAdmin(user.email);
          console.log('Is admin check:', { email: user.email, isAdmin });

          // Show/hide admin button based on admin status
          const adminBtn = document.getElementById('adminBtn');
          if (adminBtn) {
            if (isAdmin) {
              adminBtn.style.display = 'flex';
              adminBtn.textContent = 'Admin';
              console.log('‚úÖ User is admin - showing admin button');
            } else {
              adminBtn.style.display = 'none';
              console.log('‚ùå User is not admin - hiding admin button');
            }
          }
        } catch (error) {
          console.error('Error checking user roles:', error);
        }

        // Load user's team to show "My Team" if they have one
        waitForFirebase(() => {
          loadUserTeam(user);
          updateUnreadBadge();
        });
      } else {
        // User is signed out
        console.log('‚ùå User is signed out');
        if (loginLink) loginLink.style.display = 'block';
        if (userProfileChip) userProfileChip.style.display = 'none';
        if (myTeamsTab) myTeamsTab.style.display = 'none';
        if (notificationsIcon) notificationsIcon.style.display = 'none';
        window.currentUserData = null;

        // Update hero button for non-authenticated users
        const heroBtn = document.getElementById('heroSignupBtn');
        const signupTab = document.getElementById('tab-signup');
        if (heroBtn) {
          heroBtn.textContent = 'Sign In with Google';
          heroBtn.onclick = () => signInWithGoogle();
        }
        if (signupTab) {
          signupTab.innerHTML = 'üîê Sign In / Account';
        }

        // Hide admin button when signed out
        const adminBtn = document.getElementById('adminBtn');
        if (adminBtn) {
          adminBtn.style.display = 'none';
        }

        // Hide user profile in card navigation
        if (navUserProfile) {
          navUserProfile.style.display = 'none';
          console.log('Hiding user profile');
        }
      }
    });

    // ============================================
    // Previous Tournaments Functionality - Hidden for future use
    // ============================================
    /*
    const tournamentSelect = document.getElementById('tournamentSelect');
    const previousTournamentData = document.getElementById('previousTournamentData');
    const prevViewBtns = document.querySelectorAll('.prev-view-btn');

    // Tournament selection handler
    if (tournamentSelect) {
      console.log('‚úÖ Tournament select dropdown found');
      tournamentSelect.addEventListener('change', async (e) => {
        const selectedTournament = e.target.value;
        console.log('üìÖ Tournament selected:', selectedTournament);

        if (selectedTournament === 'fall-2025') {
          console.log('üèÄ Loading Fall 2025 data...');

          // Show the data container
          if (previousTournamentData) {
            previousTournamentData.style.display = 'block';
            console.log('‚úÖ Data container shown');
          }

          // Update title
          const titleEl = document.getElementById('selectedTournamentTitle');
          if (titleEl) {
            titleEl.textContent = 'Fall 2025 Tournament';
          }

          // Load tournament data (using current data as Fall 2025)
          await loadPreviousTournamentData();
        } else {
          // Hide data if no selection
          if (previousTournamentData) {
            previousTournamentData.style.display = 'none';
          }
        }
      });
    } else {
      console.log('‚ùå Tournament select dropdown NOT found');
    }

    // View switching for Previous Tournaments
    prevViewBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;

        // Update active button
        prevViewBtns.forEach(b => {
          b.classList.remove('active');
          b.style.background = '#f5f1e8';
        });
        btn.classList.add('active');
        btn.style.background = 'var(--brand)';

        // Show corresponding view
        document.getElementById('prevStandingsView').style.display = view === 'standings' ? 'block' : 'none';
        document.getElementById('prevBracketView').style.display = view === 'bracket' ? 'block' : 'none';
        document.getElementById('prevScheduleView').style.display = view === 'schedule' ? 'block' : 'none';
      });
    });

    // Load previous tournament data
    async function loadPreviousTournamentData() {
      try {
        const { collection, getDocs, doc, getDoc } = window.firestoreImports;
        const db = window.db;

        console.log('üìä Loading previous tournament data...');

        // Load teams for standings
        const teamsSnapshot = await getDocs(collection(db, 'teams'));
        const teams = [];
        teamsSnapshot.forEach(teamDoc => {
          teams.push({ id: teamDoc.id, ...teamDoc.data() });
        });

        console.log('‚úÖ Loaded teams:', teams.length);

        // Sort teams by wins, then point differential
        teams.sort((a, b) => {
          if (b.wins !== a.wins) return b.wins - a.wins;
          return b.pointDiff - a.pointDiff;
        });

        // Calculate stats
        const totalTeams = teams.length;
        const totalPlayers = teams.reduce((sum, team) => sum + (team.roster?.length || 0), 0);
        const champion = teams.length > 0 ? teams[0].name : 'TBD';

        // Update stats display
        document.getElementById('prevChampion').textContent = champion;
        document.getElementById('prevTotalTeams').textContent = totalTeams;
        document.getElementById('prevTotalGames').textContent = '63';
        document.getElementById('prevTotalPlayers').textContent = totalPlayers;

        // Load standings
        const prevTeamsGrid = document.getElementById('prevTeamsGrid');
        if (prevTeamsGrid) {
          prevTeamsGrid.innerHTML = teams.map(team => `
            <div class="team-card">
              <div class="team-header">
                <div class="avatar" aria-hidden="true">${team.icon || 'üèÄ'}</div>
                <div>
                  <div class="team-name">${team.name}</div>
                  <div class="team-seed">Seed: ${team.seed || 'N/A'}</div>
                </div>
              </div>
              <div class="team-stats">
                <div class="stat">
                  <div class="label">Record</div>
                  <div class="value">${team.wins}-${team.losses}</div>
                </div>
                <div class="stat">
                  <div class="label">Point Diff</div>
                  <div class="value ${team.pointDiff >= 0 ? 'positive' : 'negative'}">
                    ${team.pointDiff >= 0 ? '+' : ''}${team.pointDiff}
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }

        // Load bracket
        const bracketDoc = await getDoc(doc(db, 'tournament', 'bracket'));
        if (bracketDoc.exists()) {
          const bracketData = bracketDoc.data();
          const prevBracketContainer = document.getElementById('prevBracketContainer');
          if (prevBracketContainer && bracketData.rounds) {
            renderPreviousBracket(bracketData.rounds, prevBracketContainer);
          }
        }

        // Load schedule
        const gamesSnapshot = await getDocs(collection(db, 'games'));
        const games = [];
        gamesSnapshot.forEach(gameDoc => {
          games.push({ id: gameDoc.id, ...gameDoc.data() });
        });

        console.log('‚úÖ Loaded games:', games.length);

        // Sort by date
        games.sort((a, b) => {
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          return (a.time || '').localeCompare(b.time || '');
        });

        const prevScheduleTable = document.getElementById('prevScheduleTable');
        if (prevScheduleTable) {
          prevScheduleTable.innerHTML = games.map(game => `
            <tr>
              <td>${game.date || 'TBD'}</td>
              <td>${game.team1} vs ${game.team2}</td>
              <td>${game.time || 'TBD'}</td>
              <td>${game.court || 'TBD'}</td>
              <td>${game.round || 'Regular Season'}</td>
              <td>${game.completed ? `${game.winner} (${game.score})` : 'Pending'}</td>
            </tr>
          `).join('');
        }

        console.log('‚úÖ Previous tournament data loaded successfully!');

      } catch (error) {
        console.error('‚ùå Error loading previous tournament data:', error);
      }
    }

    // Render bracket for previous tournaments
    function renderPreviousBracket(rounds, container) {
      container.innerHTML = rounds.map((round, roundIndex) => `
        <div class="bracket-round">
          <div class="bracket-round-title">${round.name}</div>
          ${round.games.map(game => `
            <div class="bracket-game">
              <div class="bracket-team ${game.winner === game.team1 ? 'winner' : ''}">
                ${game.team1 || 'TBD'}
              </div>
              <div class="bracket-team ${game.winner === game.team2 ? 'winner' : ''}">
                ${game.team2 || 'TBD'}
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }
    */

    // ============================================
    // Hero Button Click Handler
    // ============================================
    // Note: Click handler is set dynamically in the auth state listener
    // based on whether user is signed in or not

    // ============================================
    // Winter Tournament Entry System
    // ============================================
    let currentSubmissionId = null;
    let isEditMode = false;

    // Load user's existing submission
    async function loadUserTournamentSubmission() {
      if (!auth.currentUser) return;

      // Destructure Firestore functions
      const { query, collection, where, getDocs, doc, updateDoc } = window.firestoreImports;

      try {
        const submissionsQuery = query(
          collection(db, 'tournament_entries'),
          where('userId', '==', auth.currentUser.uid),
          where('status', '==', 'active')
        );
        const snapshot = await getDocs(submissionsQuery);

        if (!snapshot.empty) {
          const submission = snapshot.docs[0];
          currentSubmissionId = submission.id;
          const data = submission.data();

          // Show submission status
          document.getElementById('userSubmissionStatus').style.display = 'block';
          document.getElementById('tournamentEntryForm').style.display = 'none';

          // Display submission details
          document.getElementById('submissionDetails').innerHTML = `
            <div style="display: grid; gap: 1rem;">
              <div><strong>Team Name:</strong> ${data.teamName}</div>
              <div><strong>Captain:</strong> ${data.captainName}</div>
              <div><strong>Email:</strong> ${data.captainEmail}</div>
              <div><strong>Instagram:</strong> ${data.captainPhone}</div>
              <div><strong>Players:</strong><br/><pre style="margin: 0.5rem 0; padding: 0.5rem; background: #0a1122; border-radius: 4px;">${data.playerNames}</pre></div>
              ${data.notes ? `<div><strong>Notes:</strong> ${data.notes}</div>` : ''}
              <div style="color: var(--muted); font-size: 0.85rem;">Submitted: ${new Date(data.createdAt).toLocaleDateString()}</div>
            </div>
          `;
        } else {
          // No submission, show form
          document.getElementById('userSubmissionStatus').style.display = 'none';
          document.getElementById('tournamentEntryForm').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading submission:', error);
      }
    }

    // Submit tournament entry
    const tournamentForm = document.getElementById('springTournamentForm');
    if (tournamentForm) {
      tournamentForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Destructure Firestore functions
        const { addDoc, collection } = window.firestoreImports;

        const teamName = document.getElementById('tournamentTeamName').value.trim();
        const captainName = document.getElementById('tournamentCaptainName').value.trim();
        const captainEmail = document.getElementById('tournamentCaptainEmail').value.trim();
        const captainPhone = document.getElementById('tournamentCaptainPhone').value.trim();
        const player1 = document.getElementById('tournamentPlayer1').value.trim();
        const player2 = document.getElementById('tournamentPlayer2').value.trim();
        const player3 = document.getElementById('tournamentPlayer3').value.trim();
        const notes = document.getElementById('tournamentNotes').value.trim();

        // Build player names string
        const playerNamesArray = [player1, player2];
        if (player3) {
          playerNamesArray.push(player3);
        }
        const playerNames = playerNamesArray.join('\n');

        try {
          const submitBtn = document.getElementById('submitTournamentBtn');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting...';

          const entryData = {
            teamName,
            captainName,
            captainEmail,
            captainPhone,
            playerNames,
            notes,
            status: 'active',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };

          // Create new submission
          await addDoc(collection(db, 'tournament_entries'), entryData);
          alert('‚úÖ Your tournament entry has been submitted!');

          // Reset form
          tournamentForm.reset();
          submitBtn.textContent = 'Submit Tournament Entry';

        } catch (error) {
          console.error('Error submitting tournament entry:', error);
          alert('Error submitting entry. Please try again.');
        } finally {
          const submitBtn = document.getElementById('submitTournamentBtn');
          submitBtn.disabled = false;
        }
      });
    }

    // Edit submission
    const editBtn = document.getElementById('editSubmissionBtn');
    if (editBtn) {
      editBtn.addEventListener('click', async () => {
        if (!currentSubmissionId) return;

        // Destructure Firestore functions
        const { getDoc, doc } = window.firestoreImports;

        try {
          const submissionDoc = await getDoc(doc(db, 'tournament_entries', currentSubmissionId));
          if (submissionDoc.exists()) {
            const data = submissionDoc.data();

            // Fill form with existing data
            document.getElementById('tournamentTeamName').value = data.teamName;
            document.getElementById('tournamentCaptainName').value = data.captainName;
            document.getElementById('tournamentCaptainEmail').value = data.captainEmail;
            document.getElementById('tournamentCaptainPhone').value = data.captainPhone;

            // Split player names into individual fields
            const players = (data.playerNames || '').split('\n').filter(p => p.trim());
            document.getElementById('tournamentPlayer1').value = players[0] || '';
            document.getElementById('tournamentPlayer2').value = players[1] || '';
            document.getElementById('tournamentPlayer3').value = players[2] || '';

            document.getElementById('tournamentNotes').value = data.notes || '';

            // Show form, hide status
            document.getElementById('userSubmissionStatus').style.display = 'none';
            document.getElementById('tournamentEntryForm').style.display = 'block';

            // Update button text
            document.getElementById('submitTournamentBtn').textContent = 'Update Tournament Entry';
            isEditMode = true;
          }
        } catch (error) {
          console.error('Error loading submission for edit:', error);
          alert('Error loading submission. Please try again.');
        }
      });
    }

    // Withdraw submission
    const withdrawBtn = document.getElementById('withdrawSubmissionBtn');
    if (withdrawBtn) {
      withdrawBtn.addEventListener('click', async () => {
        if (!currentSubmissionId) return;

        if (!confirm('Are you sure you want to withdraw your tournament entry?')) {
          return;
        }

        // Destructure Firestore functions
        const { updateDoc, doc } = window.firestoreImports;

        try {
          await updateDoc(doc(db, 'tournament_entries', currentSubmissionId), {
            status: 'withdrawn',
            withdrawnAt: new Date().toISOString()
          });

          alert('‚úÖ Your tournament entry has been withdrawn.');
          currentSubmissionId = null;
          await loadUserTournamentSubmission();
        } catch (error) {
          console.error('Error withdrawing submission:', error);
          alert('Error withdrawing submission. Please try again.');
        }
      });
    }

    // Show all submissions (admin only)
    window.showAllSubmissions = async function() {
      // Destructure Firestore functions
      const { query, collection, where, getDocs } = window.firestoreImports;

      try {
        const submissionsQuery = query(
          collection(db, 'tournament_entries'),
          where('status', '==', 'active')
        );
        const snapshot = await getDocs(submissionsQuery);

        const submissions = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // Create modal to display submissions
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';

        const content = document.createElement('div');
        content.style.cssText = 'background: var(--card); border: 2px solid var(--brand); border-radius: 12px; padding: 2rem; max-width: 1200px; max-height: 90vh; overflow-y: auto; width: 100%;';

        content.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; color: var(--brand);">Tournament Submissions (${submissions.length})</h2>
            <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; color: var(--text); font-size: 2rem; cursor: pointer; line-height: 1;">&times;</button>
          </div>

          ${submissions.length === 0 ? '<p style="color: var(--muted); text-align: center;">No submissions yet.</p>' : `
            <div style="display: grid; gap: 1.5rem;">
              ${submissions.map(sub => `
                <div style="background: #0a1122; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                      <strong style="color: var(--brand);">Team Name:</strong> ${sub.teamName}
                    </div>
                    <div>
                      <strong style="color: var(--brand);">Captain:</strong> ${sub.captainName}
                    </div>
                    <div>
                      <strong style="color: var(--brand);">Email:</strong> ${sub.captainEmail}
                    </div>
                    <div>
                      <strong style="color: var(--brand);">Instagram:</strong> ${sub.captainPhone}
                    </div>
                    <div>
                      <strong style="color: var(--brand);">Submitted:</strong> ${new Date(sub.createdAt).toLocaleDateString()}
                    </div>
                  </div>
                  <div style="margin-top: 1rem;">
                    <strong style="color: var(--brand);">Players:</strong>
                    <pre style="margin: 0.5rem 0; padding: 0.5rem; background: var(--card); border-radius: 4px; white-space: pre-wrap;">${sub.playerNames}</pre>
                  </div>
                  ${sub.notes ? `
                    <div style="margin-top: 1rem;">
                      <strong style="color: var(--brand);">Notes:</strong>
                      <p style="margin: 0.5rem 0; color: var(--muted);">${sub.notes}</p>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          `}
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);

      } catch (error) {
        console.error('Error loading all submissions:', error);
        alert('Error loading submissions. Please try again.');
      }
    };

    // Check if user is admin and show admin button
    onAuthStateChanged(auth, async (user) => {
      const captainEmailField = document.getElementById('tournamentCaptainEmail');

      if (user) {
        // Destructure Firestore functions
        const { query, collection, where, getDocs } = window.firestoreImports;

        // Autofill captain email with logged-in user's email
        if (captainEmailField && user.email) {
          captainEmailField.value = user.email;
          captainEmailField.setAttribute('readonly', 'true');
          captainEmailField.style.backgroundColor = 'rgba(207, 185, 145, 0.1)';
        }

        // Check if admin
        try {
          const approvedAdminsQuery = query(
            collection(db, 'approved_admins'),
            where('email', '==', user.email)
          );
          const snapshot = await getDocs(approvedAdminsQuery);

          if (!snapshot.empty || user.uid === ADMIN_UID) {
            document.getElementById('adminSubmissionsBtn').style.display = 'block';
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
        }
      } else {
        // User is not signed in - make email field editable
        if (captainEmailField) {
          captainEmailField.removeAttribute('readonly');
          captainEmailField.style.backgroundColor = '#ffffff';
          captainEmailField.value = '';
        }
      }
    });

    }); // End of waitForFirebase
  </script>

  <!-- Stats Carousel JavaScript -->
  <script>
    // Simple carousel navigation
    const track = document.getElementById('statsCarouselTrack');
    const leftBtn = document.getElementById('carouselBtnLeft');
    const rightBtn = document.getElementById('carouselBtnRight');

    if (track && leftBtn && rightBtn) {
      const cardWidth = 400 + 32; // card width + gap
      
      leftBtn.addEventListener('click', () => {
        track.scrollBy({
          left: -cardWidth,
          behavior: 'smooth'
        });
      });

      rightBtn.addEventListener('click', () => {
        track.scrollBy({
          left: cardWidth,
          behavior: 'smooth'
        });
      });

      // Optional: Auto-hide buttons at scroll edges
      track.addEventListener('scroll', () => {
        const maxScroll = track.scrollWidth - track.clientWidth;
        leftBtn.style.opacity = track.scrollLeft <= 0 ? '0.3' : '1';
        rightBtn.style.opacity = track.scrollLeft >= maxScroll ? '0.3' : '1';
      });

      // Initial button state
      leftBtn.style.opacity = '0.3';

      console.log('‚úÖ Stats carousel initialized');
    }
  </script>
</body>
</html>
