<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>IBA Basketball Tournament</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBN0rfpzjredziJbPny-YfEgq4uE2l1hzE",
      authDomain: "iba-website-63cb3.firebaseapp.com",
      projectId: "iba-website-63cb3",
      storageBucket: "iba-website-63cb3.firebasestorage.app",
      messagingSenderId: "267064036667",
      appId: "1:267064036667:web:4f9d28aac0d5ae4ca97b1e",
      measurementId: "G-GGH99DCY07"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    // Admin UID - only this user can access admin functions
    const ADMIN_UID = 'seZ01FolJbSajEKTIsljwGtYHGD3';

    // Make Firebase available globally
    window.db = db;
    window.auth = auth;
    window.functions = functions;
    window.ADMIN_UID = ADMIN_UID;
    window.firestoreImports = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDoc, setDoc };
    window.authImports = { signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken };
    window.functionsImports = { httpsCallable };
  </script>
  
</head>
<body>
  <div class="wrap">
    <header class="site" role="banner">
      <div class="logo">
        <img src="images/iba-logo.png" alt="IBA Logo" style="width: 100%; height: 100%; object-fit: contain;" />
        <!-- Edit icon modal -->
    <div id="editIconModal" class="edit-icon-modal">
      <div class="edit-icon-content">
        <h3>Change Team Icon</h3>
        <p id="editIconTeamName" style="color: var(--muted); margin-bottom: 1rem;"></p>
        <div class="icon-picker" id="iconPicker">
          <!-- Icons will be populated by JavaScript -->
        </div>
        <div class="admin-buttons">
          <button type="button" class="admin-cancel" id="cancelIconEdit">Cancel</button>
          <button type="button" class="admin-submit" id="saveIcon">Save Icon</button>
        </div>
      </div>
    </div>

    <!-- Complete game modal -->
    <div id="completeGameModal" class="edit-game-modal">
      <div class="edit-game-content" style="max-width: 500px;">
        <h3>Complete Game</h3>
        <p id="completeGameMatchup" style="color: var(--text); text-align: center; font-size: 1.1rem; margin-bottom: 1.5rem;"></p>

        <div class="form-group">
          <label>Final Score</label>
          <div style="display: flex; gap: 1rem; align-items: center; justify-content: center;">
            <input type="number" id="team1Score" min="0" placeholder="0" required style="width: 80px; text-align: center; font-size: 1.2rem; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 8px;" />
            <span style="color: var(--muted); font-weight: 700;">-</span>
            <input type="number" id="team2Score" min="0" placeholder="0" required style="width: 80px; text-align: center; font-size: 1.2rem; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 8px;" />
          </div>
        </div>

        <div class="form-group">
          <label>Winner</label>
          <div style="display: flex; gap: 0.75rem;">
            <button type="button" id="team1WinBtn" class="winner-btn" style="flex: 1; padding: 0.75rem; background: var(--card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text); transition: all 0.2s;">
              <span id="team1WinName"></span>
            </button>
            <button type="button" id="team2WinBtn" class="winner-btn" style="flex: 1; padding: 0.75rem; background: var(--card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text); transition: all 0.2s;">
              <span id="team2WinName"></span>
            </button>
          </div>
        </div>

        <div class="admin-buttons" style="margin-top: 2rem;">
          <button type="button" class="admin-cancel" id="cancelCompleteGame">Cancel</button>
          <button type="button" class="admin-submit" id="submitCompleteGame">Complete Game</button>
        </div>
      </div>
    </div>

    <!-- Edit team modal -->
    <div id="editTeamModal" class="edit-game-modal">
      <div class="edit-game-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; padding: 2rem;">
        <h3 style="margin-top: 0;">Edit Team</h3>
        <form id="teamForm">
          <div class="form-group">
            <label>Team Name</label>
            <input type="text" id="teamName" required />
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label>Seed</label>
              <input type="number" id="teamSeed" min="1" max="32" required />
            </div>
            <div class="form-group">
              <label>Point Differential</label>
              <input type="number" id="teamPointDiff" required />
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label>Wins</label>
              <input type="number" id="teamWins" min="0" required />
            </div>
            <div class="form-group">
              <label>Losses</label>
              <input type="number" id="teamLosses" min="0" required />
            </div>
          </div>

          <div style="border-top: 2px solid var(--brand); margin: 2rem 0; padding-top: 1.5rem;">
            <h4 style="color: var(--brand); margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem;">‚ö° Roster Management</h4>

            <div id="rosterManager" style="margin-bottom: 1rem; min-height: 50px;">
              <!-- Roster items will be populated here -->
            </div>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" id="newPlayerName" class="input" placeholder="Player name" style="flex: 1; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.65rem; border-radius: 8px; font-size: 0.95rem;" />
              <button type="button" id="addPlayerBtn" style="padding: 0.65rem 1.2rem; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">+ Add Player</button>
            </div>
          </div>

          <div class="admin-buttons" style="margin-top: 2rem;">
            <button type="button" class="admin-cancel" id="cancelTeamEdit">Cancel</button>
            <button type="submit" class="admin-submit">Save Team</button>
          </div>
        </form>
      </div>
    </div>
  </div>
      <div class="title">
        <h1>IBA Tournament</h1>
        <p>Indian Basketball Association ‚Ä¢ Fall 2025</p>
      </div>
      <div class="meta">
        <a href="https://www.instagram.com/iba_purdue/" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
          <span class="chip flashy-glow" title="Follow us on Instagram">INSTAGRAM</span>
        </a>
        <a href="https://www.youtube.com/@IBAPurdue" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
          <span class="chip" title="Watch us on YouTube">YOUTUBE</span>
        </a>
        <a href="https://groupme.com/join_group/103612585/ARKLYj6v?fbclid=PAZXh0bgNhZW0CMTEAAaeIjRa3CC7_aPN3OBin6Vwxb_526BpUeVZ17QKolQ1m9w-F70UaiJFOTz3s4Q_aem_2m9NaxxWRVEaJBnCeDxOxQ" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
          <span class="chip" title="Join our GroupMe">GROUPME</span>
        </a>
        <span class="visitor-count" title="Total site visitors">
          üëÅÔ∏è <span class="count" id="visitorCount">0</span>
        </span>
      </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-bg">
        <img src="images/basketball-court.jpeg" alt="Basketball Court" onerror="this.style.display='none'">
        <div class="hero-overlay"></div>
      </div>
      <div class="hero-content">
        <h2>The Court. The Teams. The Glory</h2>
        <p>IBA Fall 2025 ‚Ä¢ Regular Season & Playoffs</p>
        <a href="#" class="hero-btn" onclick="document.getElementById('tab-signup').click(); return false;">Spring Season Entry Form</a>
      </div>
    </section>

    <!-- Stats Bar -->
    <section class="stats-bar">
      <div class="stat-card">
        <h3 id="teamsCount">0</h3>
        <p>Teams</p>
      </div>
      <div class="stat-card">
        <h3>63</h3>
        <p>Total Games</p>
      </div>
      <div class="stat-card">
        <h3 id="playersCount">0</h3>
        <p>Players</p>
      </div>
      <div class="stat-card">
        <h3 id="championName" style="font-size: 1.5rem;">TBD</h3>
        <p>Champion</p>
      </div>
    </section>

    <main class="tabs" role="main">
      <div class="tablist" role="tablist" aria-label="Tournament sections">
        <button role="tab" id="tab-schedule" aria-selected="true" aria-controls="panel-schedule">Schedule</button>
        <button role="tab" id="tab-teams" aria-selected="false" aria-controls="panel-teams">Teams</button>
        <button role="tab" id="tab-bracket" aria-selected="false" aria-controls="panel-bracket">Bracket</button>
        <button role="tab" id="tab-faq" aria-selected="false" aria-controls="panel-faq">FAQ</button>
        <button role="tab" id="tab-contact" aria-selected="false" aria-controls="panel-contact">Contact Us</button>
        <button role="tab" id="tab-signup" aria-selected="false" aria-controls="panel-signup">‚úçÔ∏è Spring Season</button>
      </div>

      <section id="panel-schedule" class="tabpanel active" role="tabpanel" aria-labelledby="tab-schedule">
        <button class="add-game-btn" id="addGameBtn">+ Add New Game</button>
        <div class="quick-add-section" style="display: none; margin-bottom: 1rem;">
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="quickAddInput" class="input" style="flex: 1;" placeholder="Team1 vs Team2,Date,Day,Time,Court,Round,Status (e.g. KOS vs BBB,2025-01-10,Friday,800pm,Court A,Round of 16,Scheduled)" />
            <button class="admin-submit" id="quickAddBtn" style="padding: 0.55rem 1rem; border-radius: 10px;">Quick Add</button>
          </div>
          <div style="color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem;">
            Format: Team1 vs Team2,Date,Day,Time,Court,Round,Status (Date: YYYY-MM-DD, Time: 800pm, 1000pm, etc.)
          </div>
        </div>
        <div class="controls">
          <input id="search" class="input" type="search" placeholder="Search team..." aria-label="Search schedule" />
          <select id="dayFilter" class="select" aria-label="Filter by day">
            <option value="">All days</option>
          </select>
          <select id="courtFilter" class="select" aria-label="Filter by court">
            <option value="">All courts</option>
          </select>
          <button id="searchBtn" class="admin-submit" style="padding: 0.55rem 1rem; border-radius: 10px;">Search</button>
        </div>
        <div class="table-wrap">
          <table id="scheduleTable" aria-describedby="scheduleCaption">
            <caption id="scheduleCaption" class="sr-only">Tournament game schedule</caption>
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Day</th>
                <th scope="col">Time</th>
                <th scope="col">Matchup</th>
                <th scope="col">Court</th>
                <th scope="col">Round</th>
                <th scope="col">Status</th>
                <th scope="col" class="admin-mode" style="display: none;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Games will be loaded from Firestore -->
            </tbody>
          </table>
        </div>
      </section>

      <section id="panel-teams" class="tabpanel" role="tabpanel" aria-labelledby="tab-teams">
        <div class="grid" id="teamsGrid">
          <article class="team-card" data-team="mutts">
            <button class="edit-icon-btn" onclick="editTeamIcon('mutts')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üèÄ</div>
            <div>
              <h4>Mutts and Fulls <span class="pill" title="Seed">#1</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="bbb">
            <button class="edit-icon-btn" onclick="editTeamIcon('bbb')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üî•</div>
            <div>
              <h4>BBB <span class="pill" title="Seed">#2</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="rajesh">
            <button class="edit-icon-btn" onclick="editTeamIcon('rajesh')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üõ°Ô∏è</div>
            <div>
              <h4>Rajesh's Last Dance <span class="pill" title="Seed">#3</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="club">
            <button class="edit-icon-btn" onclick="editTeamIcon('club')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">‚ö°</div>
            <div>
              <h4>Club ballers <span class="pill" title="Seed">#4</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="navsandeep">
            <button class="edit-icon-btn" onclick="editTeamIcon('navsandeep')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">‚≠ê</div>
            <div>
              <h4>Nav/Sandeep <span class="pill" title="Seed">#5</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="kos">
            <button class="edit-icon-btn" onclick="editTeamIcon('kos')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üëë</div>
            <div>
              <h4>KOS <span class="pill" title="Seed">#6</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="lemickey">
            <button class="edit-icon-btn" onclick="editTeamIcon('lemickey')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üèÜ</div>
            <div>
              <h4>LeMickey <span class="pill" title="Seed">#7</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="bbs">
            <button class="edit-icon-btn" onclick="editTeamIcon('bbs')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üí™</div>
            <div>
              <h4>BBS <span class="pill" title="Seed">#8</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="gutti">
            <button class="edit-icon-btn" onclick="editTeamIcon('gutti')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üåü</div>
            <div>
              <h4>gutti boys <span class="pill" title="Seed">#9</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="sap">
            <button class="edit-icon-btn" onclick="editTeamIcon('sap')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üèüÔ∏è</div>
            <div>
              <h4>SAP Center <span class="pill" title="Seed">#10</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="are">
            <button class="edit-icon-btn" onclick="editTeamIcon('are')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üöÄ</div>
            <div>
              <h4>ARE 3.0 <span class="pill" title="Seed">#11</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="naujawan">
            <button class="edit-icon-btn" onclick="editTeamIcon('naujawan')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üíé</div>
            <div>
              <h4>Naujawan <span class="pill" title="Seed">#12</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="buckit">
            <button class="edit-icon-btn" onclick="editTeamIcon('buckit')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">ü™£</div>
            <div>
              <h4>Buckit <span class="pill" title="Seed">#13</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="swish">
            <button class="edit-icon-btn" onclick="editTeamIcon('swish')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üå∂Ô∏è</div>
            <div>
              <h4>Swish Kebabs <span class="pill" title="Seed">#14</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="diko">
            <button class="edit-icon-btn" onclick="editTeamIcon('diko')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">üéØ</div>
            <div>
              <h4>Diko & Co. <span class="pill" title="Seed">#15</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
          <article class="team-card" data-team="fuse">
            <button class="edit-icon-btn" onclick="editTeamIcon('fuse')">Edit Icon</button>
            <div class="avatar" aria-hidden="true">‚ö°</div>
            <div>
              <h4>Fuse <span class="pill" title="Seed">#16</span></h4>
              <p>Click to view roster and stats</p>
            </div>
          </article>
        </div>
      </section>

      <section id="panel-bracket" class="tabpanel" role="tabpanel" aria-labelledby="tab-bracket">
        <button class="add-game-btn" id="bulkImportBracketBtn" style="display: none;">üì• Bulk Import Bracket</button>
        <div style="overflow-x: auto;">
          <div class="bracket-container">
            <!-- Round of 16 -->
            <div class="bracket-round">
              <div class="bracket-round-title">Round of 16</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-1-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-1-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-1-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-1-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-2-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-2-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-2-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-2-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-3-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-3-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-3-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-3-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-4-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-4-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-4-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-4-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-5-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-5-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-5-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-5-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-6-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-6-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-6-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-6-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-7-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-7-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-7-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-7-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="r16-8-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-8-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="r16-8-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('r16-8-2')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Quarterfinals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Quarterfinals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="qf-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="qf-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="qf-3">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-3')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="qf-4">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-4')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="qf-5">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-5')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="qf-6">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-6')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="qf-7">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-7')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="qf-8">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('qf-8')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Semifinals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Semifinals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="sf-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('sf-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="sf-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('sf-2')">Edit</button>
                </div>
              </div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="sf-3">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('sf-3')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="sf-4">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('sf-4')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Finals -->
            <div class="bracket-round">
              <div class="bracket-round-title">Finals</div>
              <div class="bracket-match">
                <div class="bracket-team" data-slot="f-1">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('f-1')">Edit</button>
                </div>
                <div class="bracket-team" data-slot="f-2">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('f-2')">Edit</button>
                </div>
              </div>
            </div>

            <!-- Champion -->
            <div class="bracket-round">
              <div class="bracket-round-title">Champion</div>
              <div class="bracket-match">
                <div class="bracket-team champion" data-slot="champion">
                  <span class="team-name">TBD</span>
                  <button class="edit-bracket-btn" onclick="editBracketSlot('champion')">Edit</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-faq" class="tabpanel" role="tabpanel" aria-labelledby="tab-faq">
        <div class="faq">
          <details>
            <summary>How many players are allowed per team?</summary>
            <p>Each team may have up to 4 players on the roster.</p>
          </details>
          <details>
            <summary>Who is eligible to participate?</summary>
            <p>All currently enrolled Purdue University students are eligible to play. Valid student ID may be required.</p>
          </details>
          <details>
            <summary>What is the registration fee?</summary>
            <p>The registration fee is $5 per person, paid at the time of team registration.</p>
          </details>
          <details>
            <summary>How long are games?</summary>
            <p>Each game is 30 minutes in length.</p>
          </details>
          <details>
            <summary>How do I know what jersey colors to wear?</summary>
            <p>Teams listed on the right side of the schedule wear white jerseys, while teams on the left wear black. We will also send reminders before each game.</p>
          </details>
          <details>
            <summary>Will there be referees and scorekeepers?</summary>
            <p>Yes, all games will have referees officiating and a dedicated scorekeeper tracking the game.</p>
          </details>
          <details>
            <summary>Is there a penalty for arriving late?</summary>
            <p>Yes. Teams arriving late will be penalized one point per minute for the opposing team. Please arrive at least 10 minutes before your scheduled game time.</p>
          </details>
          <details>
            <summary>What happens if my team wears incorrect jersey colors?</summary>
            <p>Teams wearing incorrect jersey colors will be assessed a penalty of one free throw per violation for the opposing team.</p>
          </details>
          <details>
            <summary>What if we cannot make it to our scheduled game?</summary>
            <p>If your team cannot attend, you may forfeit the game or contact the opposing team directly to request a reschedule. Please provide as much advance notice as possible.</p>
          </details>
          <details>
            <summary>Where are games played?</summary>
            <p>All games are held at the France A. C√≥rdova Recreational Sports Center. The specific court assignment for each game is listed in the schedule.</p>
          </details>
        </div>
      </section>

      <section id="panel-contact" class="tabpanel" role="tabpanel" aria-labelledby="tab-contact">
        <div class="faq" style="max-width: 700px;">
          <h2 style="color: var(--brand); margin-top: 0;">Get in Touch</h2>
          <p style="color: var(--muted); margin-bottom: 2rem;">Have a question or need assistance? Send us a message and we'll get back to you as soon as possible.</p>

          <form id="contactForm" style="display: flex; flex-direction: column; gap: 1.25rem;">
            <div class="form-group">
              <label style="display: block; color: var(--text); font-weight: 600; margin-bottom: 0.5rem;">Your Contact Info</label>
              <input
                type="text"
                id="contactInfo"
                class="input"
                placeholder="Instagram username, GroupMe name, phone number, or email"
                required
                style="width: 100%; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 10px; font-size: 1rem;"
              />
              <p style="color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem;">We'll use this to respond to your message</p>
            </div>

            <div class="form-group">
              <label style="display: block; color: var(--text); font-weight: 600; margin-bottom: 0.5rem;">Message</label>
              <textarea
                id="contactMessage"
                class="input"
                placeholder="Type your message here..."
                required
                rows="6"
                style="width: 100%; background: #0a1122; color: var(--text); border: 1px solid var(--border); padding: 0.75rem; border-radius: 10px; font-size: 1rem; resize: vertical; font-family: inherit;"
              ></textarea>
            </div>

            <div id="contactStatus" style="display: none; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;"></div>

            <button
              type="submit"
              id="contactSubmit"
              style="background: var(--brand); color: #0b0f1a; border: none; padding: 0.85rem 1.5rem; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s ease;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 157, 0, 0.4)';"
              onmouseout="this.style.transform=''; this.style.boxShadow='';"
            >
              Send Message
            </button>
          </form>
        </div>
      </section>

      <section id="panel-signup" class="tabpanel" role="tabpanel" aria-labelledby="tab-signup">
        <div style="max-width: 900px; margin: 0 auto;">
          <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; background: linear-gradient(90deg, var(--brand), var(--brand-2)); background-clip: text; -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">
            IBA Spring 2026 Sign Up
          </h2>
          <p style="color: var(--muted); margin-bottom: 1.5rem;">
            Fill out the form below to register your team for the upcoming Spring season.
          </p>

          <!-- Embedded Google Form -->
          <iframe
            src="https://docs.google.com/forms/d/e/1FAIpQLSdSgQEZ-64_6u9oL6Cmm6F9K_VmmXX15xB09HqUCZJyYd70Nw/viewform?embedded=true"
            width="100%" height="900" frameborder="0" marginheight="0" marginwidth="0"
            style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
            Loading‚Ä¶
          </iframe>

          <!-- Backup Button -->
          <div style="text-align: center; margin-top: 1.5rem;">
            <a href="https://forms.gle/WEoHNYVmDbJYJgua6" target="_blank" rel="noopener noreferrer"
               style="display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: white; font-weight: 600; border-radius: 12px; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s ease;"
               onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'">
              Open Form in New Tab
            </a>
          </div>
        </div>
      </section>
    </main>

    <!-- Team Detail Modal -->
    <div id="teamModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTeamName">Team Name</h2>
          <button class="close-btn" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="stats-grid">
            <div class="stat-box">
              <div class="label">Record</div>
              <div class="value" id="teamRecord">0-0</div>
            </div>
            <div class="stat-box">
              <div class="label">Point Differential</div>
              <div class="value" id="teamDiff">+0</div>
            </div>
            <div class="stat-box">
              <div class="label">Seed</div>
              <div class="value" id="teamSeedDisplay">-</div>
            </div>
          </div>

          <h3 class="section-title">Roster</h3>
          <ul class="roster-list" id="rosterList">
            <!-- Roster items populated by JS -->
          </ul>

          <h3 class="section-title">Completed Games</h3>
          <div id="completedGames">
            <!-- Game items populated by JS -->
          </div>

          <h3 class="section-title">Upcoming Games</h3>
          <div id="upcomingGames">
            <!-- Game items populated by JS -->
          </div>
        </div>
      </div>
    </div>

    <footer>
      ¬© <span id="y"></span> IBA ‚Äî Questions? DM us on Instagram <a href="https://www.instagram.com/iba_purdue/" target="_blank" rel="noopener noreferrer" style="color: var(--text); text-decoration: underline;">@iba_purdue</a> or email <a href="mailto:ibapurdue@gmail.com" style="color: var(--text); text-decoration: underline;">ibapurdue@gmail.com</a>
    </footer>

    <!-- Admin button -->
    <button class="admin-btn" id="adminBtn">Admin</button>

    <!-- Admin login modal -->
    <div id="adminModal" class="admin-modal">
      <div class="admin-modal-content">
        <h3>Admin Login</h3>
        <p style="color: var(--muted); text-align: center; margin-bottom: 1.5rem;">Authenticate using Touch ID or Face ID</p>
        <div class="admin-error" id="adminError" style="display: none;">Authentication failed</div>
        <div class="admin-buttons">
          <button class="admin-cancel" id="adminCancel">Cancel</button>
          <button class="admin-submit" id="adminBiometricBtn">üîê Use Touch ID / Face ID</button>
        </div>
        <p id="adminSetupText" style="display: none; color: var(--muted); font-size: 0.85rem; text-align: center; margin-top: 1rem;">First time? Click above to register your biometric credentials.</p>
      </div>
    </div>

    <!-- Edit/Add game modal -->
    <div id="editGameModal" class="edit-game-modal">
      <div class="edit-game-content">
        <h3 id="editGameTitle">Edit Game</h3>
        <form id="gameForm">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="gameDate" required />
          </div>
          <div class="form-group">
            <label>Day</label>
            <select id="gameDay" required>
              <option value="">Select day...</option>
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </select>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" id="gameTime" placeholder="e.g. 6:00 PM" required />
          </div>
          <div class="form-group">
            <label>Matchup</label>
            <input type="text" id="gameMatchup" placeholder="e.g. Team A vs Team B" required />
          </div>
          <div class="form-group">
            <label>Court</label>
            <select id="gameCourt" required>
              <option value="">Select court...</option>
              <option value="Black and Gold Court 1">Black and Gold Court 1</option>
              <option value="Black and Gold Court 2">Black and Gold Court 2</option>
              <option value="Black and Gold Court 3">Black and Gold Court 3</option>
              <option value="Black and Gold Court 4">Black and Gold Court 4</option>
              <option value="Black and Gold Court 5">Black and Gold Court 5</option>
              <option value="Black and Gold Court 6">Black and Gold Court 6</option>
              <option value="Upper Court 1">Upper Court 1</option>
              <option value="Upper Court 2">Upper Court 2</option>
              <option value="Upper Court 3">Upper Court 3</option>
            </select>
          </div>
          <div class="form-group">
            <label>Round</label>
            <input type="text" id="gameRound" placeholder="e.g. Round of 16" required />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="gameStatus" required>
              <option value="Scheduled">Scheduled</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="TBD">TBD</option>
            </select>
          </div>
          <div class="admin-buttons">
            <button type="button" class="admin-cancel" id="cancelEdit">Cancel</button>
            <button type="submit" class="admin-submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bulk Import Bracket Modal -->
    <div id="bulkImportModal" class="edit-game-modal">
      <div class="edit-game-content" style="max-width: 700px;">
        <h3>Bulk Import Bracket</h3>
        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
          Paste your bracket data in JSON format. This will replace all existing bracket data.
        </p>
        <textarea id="bulkBracketData" style="width: 100%; min-height: 400px; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.85rem; background: var(--card); color: var(--text);" placeholder='Example format:
{
  "r16-1-1": "Slam Squad",
  "r16-1-2": "Phoenix",
  "r16-2-1": "Panthers",
  "r16-2-2": "KOS",
  ...
}'></textarea>
        <div class="admin-buttons" style="margin-top: 1rem;">
          <button type="button" class="admin-cancel" id="cancelBulkImport">Cancel</button>
          <button type="button" class="admin-submit" id="submitBulkImport">Import Bracket</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Wait for Firebase to be available
    function waitForFirebase(callback) {
      if (window.db && window.firestoreImports) {
        callback();
      } else {
        setTimeout(() => waitForFirebase(callback), 100);
      }
    }

    // Admin functionality - must be outside Firebase callback so button works immediately
    const adminBtn = document.getElementById('adminBtn');
    const adminModal = document.getElementById('adminModal');
    const adminPassword = document.getElementById('adminPassword');
    const adminSubmit = document.getElementById('adminSubmit');
    const adminCancel = document.getElementById('adminCancel');
    const adminError = document.getElementById('adminError');

    let isAdminMode = false;
    let currentEditRow = null;

    // Admin button click handler - show login modal
    adminBtn.addEventListener('click', () => {
      if (!isAdminMode) {
        // Show login
        adminModal.classList.add('active');
        adminError.style.display = 'none';
        // Always hide setup text - server will determine if registration is needed
        document.getElementById('adminSetupText').style.display = 'none';
      }
    });

    adminCancel.addEventListener('click', () => {
      adminModal.classList.remove('active');
    });

    adminModal.addEventListener('click', (e) => {
      if (e.target === adminModal) {
        adminModal.classList.remove('active');
      }
    });

    // WebAuthn helper functions for server-side verification
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function base64urlToBase64(base64url) {
      let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
      while (base64.length % 4 !== 0) {
        base64 += '=';
      }
      return base64;
    }

    function arrayBufferToBase64url(buffer) {
      const base64 = arrayBufferToBase64(buffer);
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Server-verified WebAuthn registration
    async function registerWebAuthn() {
      try {
        // Check if WebAuthn is supported
        if (!window.PublicKeyCredential) {
          throw new Error('WebAuthn is not supported on this device');
        }

        // Wait for Firebase to be ready
        if (!window.auth || !window.authImports || !window.functions) {
          throw new Error('Firebase not initialized. Please refresh and try again.');
        }

        const { signInWithEmailAndPassword } = window.authImports;

        // First authenticate with Firebase to prove identity
        // NOTE: For initial setup, you'll need to use the old email/password once
        const email = prompt('Enter your admin email for initial registration:');
        const password = prompt('Enter your admin password for initial registration:');

        if (!email || !password) {
          throw new Error('Email and password required for initial setup');
        }

        const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
        const user = userCredential.user;

        if (user.uid !== window.ADMIN_UID) {
          await window.auth.signOut();
          throw new Error('You do not have admin privileges');
        }

        // Get registration options from server
        const { httpsCallable } = window.functionsImports;
        const generateRegOptions = httpsCallable(window.functions, 'generateRegistrationOptions');
        const optionsResponse = await generateRegOptions();
        const options = optionsResponse.data;

        // Convert challenge from base64url to Uint8Array
        const challengeArray = base64ToArrayBuffer(base64urlToBase64(options.challenge));

        // Create credential options for browser
        const publicKeyCredentialCreationOptions = {
          challenge: challengeArray,
          rp: {
            name: options.rpName,
            id: options.rpID,
          },
          user: {
            id: Uint8Array.from(options.userID, c => c.charCodeAt(0)),
            name: options.userName,
            displayName: 'IBA Admin',
          },
          pubKeyCredParams: [
            { alg: -7, type: 'public-key' },  // ES256
            { alg: -257, type: 'public-key' } // RS256
          ],
          authenticatorSelection: options.authenticatorSelection,
          timeout: options.timeout,
          attestation: options.attestationType || 'none',
        };

        // Create credential with Touch ID/Face ID
        console.log('Creating WebAuthn credential...');
        const credential = await navigator.credentials.create({
          publicKey: publicKeyCredentialCreationOptions
        });

        // Prepare credential for server verification (use base64url format)
        const rawIdBase64url = arrayBufferToBase64url(credential.rawId);
        const credentialData = {
          id: rawIdBase64url, // Use the base64url encoding of rawId
          rawId: rawIdBase64url,
          type: credential.type,
          response: {
            clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
            attestationObject: arrayBufferToBase64url(credential.response.attestationObject),
            transports: credential.response.getTransports ? credential.response.getTransports() : ['internal'],
          },
        };

        console.log('Sending credential data:', { id: credentialData.id, type: credentialData.type });

        // Send to server for verification and storage
        const verifyReg = httpsCallable(window.functions, 'verifyRegistration');
        const verificationResponse = await verifyReg({ credential: credentialData });

        if (verificationResponse.data.verified) {
          console.log('‚úÖ Biometric credential registered successfully on server');
          // Sign out from Firebase email/password auth
          await window.auth.signOut();
          return true;
        } else {
          throw new Error('Server verification failed');
        }
      } catch (error) {
        console.error('WebAuthn registration error:', error);
        throw error;
      }
    }

    // Server-verified WebAuthn authentication
    async function authenticateWebAuthn() {
      try {
        // Check if WebAuthn is supported
        if (!window.PublicKeyCredential) {
          throw new Error('WebAuthn is not supported on this device');
        }

        // Wait for Firebase to be ready
        if (!window.functions) {
          throw new Error('Firebase not initialized. Please refresh and try again.');
        }

        // Get authentication options from server
        const { httpsCallable } = window.functionsImports;
        const generateAuthOptions = httpsCallable(window.functions, 'generateAuthenticationOptions');
        const optionsResponse = await generateAuthOptions();
        const options = optionsResponse.data;

        // Convert challenge from base64url to Uint8Array
        const challengeArray = base64ToArrayBuffer(base64urlToBase64(options.challenge));

        // Convert allowCredentials IDs from base64 to ArrayBuffer
        const allowCredentials = options.allowCredentials.map(cred => ({
          id: base64ToArrayBuffer(cred.id),
          type: cred.type,
          transports: cred.transports,
        }));

        // Create authentication options for browser
        const publicKeyCredentialRequestOptions = {
          challenge: challengeArray,
          allowCredentials: allowCredentials,
          timeout: options.timeout,
          userVerification: options.userVerification,
          rpId: options.rpID,
        };

        // Get credential with Touch ID/Face ID
        console.log('Authenticating with biometrics...');
        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions
        });

        // Prepare assertion for server verification
        const assertionData = {
          id: assertion.id,
          rawId: arrayBufferToBase64(assertion.rawId),
          type: assertion.type,
          response: {
            clientDataJSON: arrayBufferToBase64(assertion.response.clientDataJSON),
            authenticatorData: arrayBufferToBase64(assertion.response.authenticatorData),
            signature: arrayBufferToBase64(assertion.response.signature),
            userHandle: assertion.response.userHandle ? arrayBufferToBase64(assertion.response.userHandle) : null,
          },
        };

        // Send to server for verification
        const verifyAuth = httpsCallable(window.functions, 'verifyAuthentication');
        const verificationResponse = await verifyAuth({ credential: assertionData });

        if (verificationResponse.data.verified) {
          console.log('‚úÖ Biometric authentication verified by server');

          // Sign in with the custom token from server
          const { signInWithCustomToken } = window.authImports;
          await signInWithCustomToken(window.auth, verificationResponse.data.customToken);

          return true;
        } else {
          throw new Error('Server verification failed');
        }
      } catch (error) {
        console.error('WebAuthn authentication error:', error);
        throw error;
      }
    }

    // Admin logout function
    window.adminLogout = function() {
      isAdminMode = false;
      document.body.classList.remove('admin-mode');
      adminBtn.textContent = 'Admin';
      adminBtn.style.background = 'var(--brand)';
      document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = 'none');
      const quickAddSection = document.querySelector('.quick-add-section');
      if (quickAddSection) quickAddSection.style.display = 'none';
      const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
      if (bulkImportBtn) bulkImportBtn.style.display = 'none';
      console.log('Admin logged out');
    };

    // Biometric authentication button handler with server verification
    document.getElementById('adminBiometricBtn').addEventListener('click', async () => {
      const adminError = document.getElementById('adminError');
      const adminBiometricBtn = document.getElementById('adminBiometricBtn');
      adminError.style.display = 'none';

      try {
        // Disable button during processing
        adminBiometricBtn.disabled = true;
        adminBiometricBtn.textContent = 'Processing...';

        // Try to authenticate first
        try {
          console.log('Attempting biometric authentication...');
          await authenticateWebAuthn();

          // Success - user is authenticated with biometrics
          adminModal.classList.remove('active');
          isAdminMode = true;
          document.body.classList.add('admin-mode');
          adminBtn.textContent = 'Logout';
          adminBtn.style.background = 'var(--success)';
          document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = '');
          const quickAddSection = document.querySelector('.quick-add-section');
          if (quickAddSection) quickAddSection.style.display = 'block';
          const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
          if (bulkImportBtn) bulkImportBtn.style.display = 'block';

          console.log('‚úÖ Admin logged in successfully with server-verified biometrics');
        } catch (authError) {
          // If authentication fails because no credentials exist, offer registration
          if (authError.message?.includes('No biometric credentials registered') ||
              authError.code === 'functions/failed-precondition') {
            console.log('No credentials found. Starting registration...');

            // Show registration prompt
            const shouldRegister = confirm(
              'No biometric credentials found.\n\n' +
              'This is your first time setting up Touch ID/Face ID.\n' +
              'You will need to enter your admin email and password once for verification.\n\n' +
              'Continue?'
            );

            if (!shouldRegister) {
              throw new Error('Registration cancelled');
            }

            // Register new credentials
            await registerWebAuthn();

            adminError.textContent = '‚úÖ Successfully registered! Click the button again to login with Touch ID.';
            adminError.style.color = 'var(--success)';
            adminError.style.display = 'block';
            document.getElementById('adminSetupText').style.display = 'none';

            setTimeout(() => {
              adminError.style.display = 'none';
              adminError.style.color = '';
            }, 5000);
          } else {
            // Re-throw other authentication errors
            throw authError;
          }
        }
      } catch (error) {
        console.error('Biometric authentication error:', error);

        // Handle specific error types
        if (error.name === 'NotAllowedError') {
          adminError.textContent = 'Authentication cancelled or not allowed';
        } else if (error.name === 'NotSupportedError') {
          adminError.textContent = 'Touch ID / Face ID not available on this device';
        } else if (error.message?.includes('not supported')) {
          adminError.textContent = 'Biometric authentication not supported on this browser';
        } else if (error.message?.includes('Firebase not initialized')) {
          adminError.textContent = 'Loading... Please wait and try again';
        } else if (error.message?.includes('cancelled')) {
          adminError.textContent = 'Registration cancelled';
        } else {
          adminError.textContent = error.message || 'Authentication failed. Please try again.';
        }
        adminError.style.display = 'block';
      } finally {
        // Re-enable button
        adminBiometricBtn.disabled = false;
        adminBiometricBtn.textContent = 'üîê Use Touch ID / Face ID';
      }
    });

    waitForFirebase(() => {
      const { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot } = window.firestoreImports;
      const db = window.db;

      // Load games from Firestore in real-time
      function loadGames() {
        console.log('üì• Loading games from Firestore...');
        const gamesCollection = collection(db, 'games');

        onSnapshot(gamesCollection, (snapshot) => {
          console.log(`üìä Loaded ${snapshot.size} games from database`);
          const tbody = document.querySelector('#scheduleTable tbody');
          tbody.innerHTML = ''; // Clear existing rows

          if (snapshot.empty) {
            console.log('‚ÑπÔ∏è No games in database yet');
          }

          // Convert snapshot to array and sort by date and time
          const games = [];
          snapshot.forEach((docSnapshot) => {
            games.push({
              id: docSnapshot.id,
              data: docSnapshot.data()
            });
          });

          // Sort games chronologically by date, then by time
          games.sort((a, b) => {
            const dateA = a.data.date || '9999-12-31'; // Put games without dates at the end
            const dateB = b.data.date || '9999-12-31';

            if (dateA !== dateB) {
              return dateA.localeCompare(dateB);
            }

            // If dates are the same, sort by time
            const timeA = convertTo24Hour(a.data.time || '');
            const timeB = convertTo24Hour(b.data.time || '');
            return timeA.localeCompare(timeB);
          });

          // Render sorted games
          games.forEach(({ id, data: game }) => {
            const row = tbody.insertRow();
            row.dataset.docId = id;
            row.innerHTML = `
              <td>${game.date || ''}</td>
              <td>${game.day}</td>
              <td>${game.time}</td>
              <td>${game.matchup}</td>
              <td>${game.court}</td>
              <td>${game.round}</td>
              <td><span class="badge">${game.status}</span></td>
              <td>
                <button class="edit-btn" onclick="editGame(this)">Edit</button>
                <button class="delete-btn" onclick="deleteGame(this)">Delete</button>
              </td>
            `;
          });
        }, (error) => {
          console.error('‚ùå Error loading games:', error);
          alert('Error loading games from database: ' + error.message);
        });
      }

      // Helper function to convert 12-hour time to 24-hour for sorting
      function convertTo24Hour(timeStr) {
        if (!timeStr) return '00:00';

        const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
        if (!match) return timeStr;

        let [_, hours, minutes, period] = match;
        hours = parseInt(hours);

        if (period.toUpperCase() === 'PM' && hours !== 12) {
          hours += 12;
        } else if (period.toUpperCase() === 'AM' && hours === 12) {
          hours = 0;
        }

        return `${hours.toString().padStart(2, '0')}:${minutes}`;
      }

      // Start loading games
      loadGames();

      // Auto-delete completed games older than 1 day
      async function cleanupOldGames() {
        try {
          const { collection, query, where, getDocs, deleteDoc, doc } = window.firestoreImports;
          const gamesRef = collection(db, 'games');

          const snapshot = await getDocs(gamesRef);
          const oneDayAgo = new Date();
          oneDayAgo.setDate(oneDayAgo.getDate() - 1);

          let deletedCount = 0;
          for (const docSnap of snapshot.docs) {
            const game = docSnap.data();

            if (game.status === 'Completed' && game.completedAt) {
              const completedDate = new Date(game.completedAt);

              if (completedDate < oneDayAgo) {
                await deleteDoc(doc(db, 'games', docSnap.id));
                console.log(`üóëÔ∏è Deleted old game: ${game.matchup}`);
                deletedCount++;
              }
            }
          }

          if (deletedCount > 0) {
            console.log(`‚úÖ Cleaned up ${deletedCount} old completed game(s)`);
          }
        } catch (error) {
          console.error('‚ùå Error cleaning up old games:', error);
        }
      }

      // Run cleanup on page load
      cleanupOldGames();

      // Run cleanup every hour
      setInterval(cleanupOldGames, 60 * 60 * 1000);

      // Teams data - will be loaded from Firestore
      let teamsData = {};
      let bracketData = {};

      // Load teams from Firestore in real-time
      function loadTeams() {
        console.log('üì• Loading teams from Firestore...');
        const teamsCollection = collection(db, 'teams');

        onSnapshot(teamsCollection, (snapshot) => {
          console.log(`üìä Loaded ${snapshot.size} teams from database`);
          teamsData = {}; // Reset teams data

          snapshot.forEach((docSnapshot) => {
            const teamId = docSnapshot.id;
            const teamDataFromDb = docSnapshot.data();
            teamsData[teamId] = teamDataFromDb;
          });

          // Render teams grid
          renderTeamsGrid();

          // Update stats bar with new team/player counts
          if (typeof updateStatsBar === 'function') {
            updateStatsBar();
          }
        }, (error) => {
          console.error('‚ùå Error loading teams:', error);
          alert('Error loading teams from database: ' + error.message);
        });
      }

      // Render teams grid
      function renderTeamsGrid() {
        const grid = document.getElementById('teamsGrid');
        grid.innerHTML = '';

        // Sort teams by seed
        const sortedTeams = Object.entries(teamsData).sort((a, b) => {
          const seedA = a[1].seed || 999;
          const seedB = b[1].seed || 999;
          return seedA - seedB;
        });

        sortedTeams.forEach(([teamId, team]) => {
          const card = document.createElement('article');
          card.className = 'team-card';
          card.dataset.team = teamId;

          const seedDisplay = team.seed ? `<span class="pill" title="Seed">#${team.seed}</span>` : '';

          card.innerHTML = `
            <button class="edit-icon-btn" onclick="editTeamIcon('${teamId}')">Edit Icon</button>
            <button class="edit-btn edit-team-btn" onclick="editTeamData('${teamId}')">Edit Team</button>
            <div class="avatar" aria-hidden="true">${team.icon || 'üèÄ'}</div>
            <div>
              <h4>${team.name} ${seedDisplay}</h4>
              <p>Seed #${team.seed || 'N/A'} ‚Ä¢ Click to view roster and stats</p>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // Start loading teams
      loadTeams();

      // Load bracket from Firestore in real-time
      function loadBracket() {
        console.log('üì• Loading bracket from Firestore...');
        const { doc, onSnapshot } = window.firestoreImports;
        const bracketRef = doc(db, 'tournament', 'bracket');

        onSnapshot(bracketRef, (docSnap) => {
          if (docSnap.exists()) {
            bracketData = docSnap.data();
            console.log('üìä Loaded bracket data from database');

            // Update all bracket slots
            Object.entries(bracketData).forEach(([slotId, teamName]) => {
              const slotElement = document.querySelector(`[data-slot="${slotId}"] .team-name`);
              if (slotElement) {
                slotElement.textContent = teamName || 'TBD';
              }
            });

            // Update stats bar with champion name
            if (typeof updateStatsBar === 'function') {
              updateStatsBar();
            }
          } else {
            console.log('‚ÑπÔ∏è No bracket data in database yet');
          }
        }, (error) => {
          console.error('‚ùå Error loading bracket:', error);
        });
      }

      // Start loading bracket
      loadBracket();

      // Track visitor count
      async function trackVisitor() {
        try {
          const { doc, getDoc, setDoc, increment } = window.firestoreImports;
          const visitorRef = doc(db, 'system', 'visitors');

          // Check if visitor has already been counted in this session
          if (sessionStorage.getItem('visitorCounted')) {
            console.log('Visitor already counted in this session');
            return;
          }

          // Increment visitor count
          const visitorDoc = await getDoc(visitorRef);
          if (visitorDoc.exists()) {
            const currentCount = visitorDoc.data().count || 0;
            await setDoc(visitorRef, {
              count: currentCount + 1,
              lastVisit: new Date().toISOString()
            });
          } else {
            // Initialize visitor count
            await setDoc(visitorRef, {
              count: 1,
              lastVisit: new Date().toISOString()
            });
          }

          // Mark this session as counted
          sessionStorage.setItem('visitorCounted', 'true');
          console.log('‚úÖ Visitor tracked');
        } catch (error) {
          console.error('‚ùå Error tracking visitor:', error);
        }
      }

      // Track visitor on page load
      trackVisitor();

      // Load visitor count for admin
      function loadVisitorCount() {
        const { doc, onSnapshot } = window.firestoreImports;
        const visitorRef = doc(db, 'system', 'visitors');

        onSnapshot(visitorRef, (docSnap) => {
          if (docSnap.exists()) {
            const visitorCount = docSnap.data().count || 0;
            const visitorDisplay = document.getElementById('visitorCount');
            if (visitorDisplay) {
              visitorDisplay.textContent = visitorCount.toLocaleString();
            }
          }
        });
      }

      // Start loading visitor count
      loadVisitorCount();

      // Helper function to find team ID by name
      function findTeamIdByName(teamName) {
        return Object.keys(teamsData).find(id =>
          teamsData[id].name.toLowerCase() === teamName.toLowerCase().trim()
        );
      }

      // Helper function to update team games in Firestore
      async function syncGameToTeams(gameData, gameId) {
        const { doc, updateDoc, getDoc } = window.firestoreImports;

        // Parse matchup to get team names
        const matchupParts = gameData.matchup.split(' vs ');
        if (matchupParts.length !== 2) {
          console.error('Invalid matchup format:', gameData.matchup);
          return;
        }

        const team1Name = matchupParts[0].trim();
        const team2Name = matchupParts[1].trim();

        const team1Id = findTeamIdByName(team1Name);
        const team2Id = findTeamIdByName(team2Name);

        if (!team1Id || !team2Id) {
          console.warn('Could not find team IDs for:', team1Name, 'vs', team2Name);
          return;
        }

        // Only sync to upcoming games - completed games are handled by the complete game modal
        const isCompleted = gameData.status === 'Completed';

        if (isCompleted) {
          // Don't do anything here - completed games are handled by the complete game modal
          return;
        }

        try {
          // Update team 1 - add to upcoming games
          const team1Ref = doc(db, 'teams', team1Id);
          const team1Doc = await getDoc(team1Ref);
          if (team1Doc.exists()) {
            const team1Data = team1Doc.data();
            const upcomingGames = team1Data.upcomingGames || [];

            // Remove any existing entry for this game
            const filteredGames = upcomingGames.filter(
              g => !(g.opponent === team2Name && g.date === gameData.day)
            );

            // Add the new/updated game
            filteredGames.push({
              opponent: team2Name,
              date: gameData.day,
              time: gameData.time,
              court: gameData.court,
              round: gameData.round
            });

            await updateDoc(team1Ref, {
              upcomingGames: filteredGames
            });
          }

          // Update team 2 - add to upcoming games
          const team2Ref = doc(db, 'teams', team2Id);
          const team2Doc = await getDoc(team2Ref);
          if (team2Doc.exists()) {
            const team2Data = team2Doc.data();
            const upcomingGames = team2Data.upcomingGames || [];

            // Remove any existing entry for this game
            const filteredGames = upcomingGames.filter(
              g => !(g.opponent === team1Name && g.date === gameData.day)
            );

            // Add the new/updated game
            filteredGames.push({
              opponent: team1Name,
              date: gameData.day,
              time: gameData.time,
              court: gameData.court,
              round: gameData.round
            });

            await updateDoc(team2Ref, {
              upcomingGames: filteredGames
            });
          }

          console.log('‚úÖ Synced game to teams:', team1Name, 'vs', team2Name);
        } catch (error) {
          console.error('‚ùå Error syncing game to teams:', error);
        }
      }

      // Helper function to remove game from teams
      async function removeGameFromTeams(matchup, day) {
        const { doc, updateDoc, getDoc } = window.firestoreImports;

        const matchupParts = matchup.split(' vs ');
        if (matchupParts.length !== 2) return;

        const team1Name = matchupParts[0].trim();
        const team2Name = matchupParts[1].trim();

        const team1Id = findTeamIdByName(team1Name);
        const team2Id = findTeamIdByName(team2Name);

        if (!team1Id || !team2Id) return;

        try {
          // Update team 1
          const team1Ref = doc(db, 'teams', team1Id);
          const team1Doc = await getDoc(team1Ref);
          if (team1Doc.exists()) {
            const team1Data = team1Doc.data();
            const upcomingGames = (team1Data.upcomingGames || []).filter(
              g => !(g.opponent === team2Name && g.date === day)
            );
            const completedGames = (team1Data.completedGames || []).filter(
              g => !(g.opponent === team2Name && g.date === day)
            );

            await updateDoc(team1Ref, {
              upcomingGames: upcomingGames,
              completedGames: completedGames
            });
          }

          // Update team 2
          const team2Ref = doc(db, 'teams', team2Id);
          const team2Doc = await getDoc(team2Ref);
          if (team2Doc.exists()) {
            const team2Data = team2Doc.data();
            const upcomingGames = (team2Data.upcomingGames || []).filter(
              g => !(g.opponent === team1Name && g.date === day)
            );
            const completedGames = (team2Data.completedGames || []).filter(
              g => !(g.opponent === team1Name && g.date === day)
            );

            await updateDoc(team2Ref, {
              upcomingGames: upcomingGames,
              completedGames: completedGames
            });
          }

          console.log('‚úÖ Removed game from teams:', team1Name, 'vs', team2Name);
        } catch (error) {
          console.error('‚ùå Error removing game from teams:', error);
        }
      }

    // Tabs functionality
    const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
    const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

    function activateTab(tab) {
      tabs.forEach(t => t.setAttribute('aria-selected', String(t === tab)));
      panels.forEach(p => p.classList.toggle('active', p.id === tab.getAttribute('aria-controls')));
      tab.focus();
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => activateTab(tab));
      tab.addEventListener('keydown', (e) => {
        const i = tabs.indexOf(tab);
        if (e.key === 'ArrowRight') {
          e.preventDefault(); activateTab(tabs[(i + 1) % tabs.length]);
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault(); activateTab(tabs[(i - 1 + tabs.length) % tabs.length]);
        }
      });
    });

    // Modal functionality
    const modal = document.getElementById('teamModal');
    const closeBtn = document.getElementById('closeModal');

    function openTeamModal(teamId) {
      const team = teamsData[teamId];
      if (!team) return;

      document.getElementById('modalTeamName').textContent = team.name;
      document.getElementById('teamRecord').textContent = `${team.record?.wins || 0}-${team.record?.losses || 0}`;
      document.getElementById('teamDiff').textContent = team.pointDiff > 0 ? `+${team.pointDiff}` : (team.pointDiff || 0);
      document.getElementById('teamSeedDisplay').textContent = team.seed ? `#${team.seed}` : 'N/A';

      // Populate roster
      const rosterList = document.getElementById('rosterList');
      if (team.roster && team.roster.length > 0) {
        rosterList.innerHTML = team.roster.map(player =>
          `<li>
            <span>
              ${player.name}
              ${player.isCaptain ? '<span class="captain-badge">CAPTAIN</span>' : ''}
            </span>
          </li>`
        ).join('');
      } else {
        rosterList.innerHTML = '<li style="color: var(--muted); text-align: center;">No roster available</li>';
      }

      // Populate completed games
      const completedDiv = document.getElementById('completedGames');
      completedDiv.innerHTML = team.completedGames.length ? team.completedGames.map(game =>
        `<div class="game-item">
          <div class="game-header">
            <span class="matchup">${game.result === 'W' ? '‚úì' : '‚úó'} vs ${game.opponent}</span>
            <span class="badge">${game.score}</span>
          </div>
          <div class="game-info">${game.date}</div>
        </div>`
      ).join('') : '<p style="color: var(--muted);">No completed games yet</p>';

      // Populate upcoming games
      const upcomingDiv = document.getElementById('upcomingGames');
      upcomingDiv.innerHTML = team.upcomingGames.length ? team.upcomingGames.map(game =>
        `<div class="game-item">
          <div class="game-header">
            <span class="matchup">vs ${game.opponent}</span>
            <span class="badge">${game.court}</span>
          </div>
          <div class="game-info">${game.date} at ${game.time}</div>
        </div>`
      ).join('') : '<p style="color: var(--muted);">No upcoming games scheduled</p>';

      modal.classList.add('active');
    }

    closeBtn.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });

    // Team card click handlers
    document.getElementById('teamsGrid').addEventListener('click', (e) => {
      // Don't open modal if clicking edit icon button or edit button
      if (e.target.classList.contains('edit-icon-btn') || e.target.classList.contains('edit-btn')) {
        return;
      }

      const card = e.target.closest('.team-card');
      if (card) {
        const teamId = card.dataset.team;
        openTeamModal(teamId);
      }
    });

    // Edit team data functionality
    const editTeamModal = document.getElementById('editTeamModal');
    const teamForm = document.getElementById('teamForm');
    const cancelTeamEdit = document.getElementById('cancelTeamEdit');
    const rosterManager = document.getElementById('rosterManager');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    let currentEditTeamId = null;
    let currentRoster = [];

    // Render roster in edit modal
    function renderRosterManager() {
      rosterManager.innerHTML = '';

      if (currentRoster.length === 0) {
        rosterManager.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No players added yet</p>';
        return;
      }

      currentRoster.forEach((player, index) => {
        const rosterItem = document.createElement('div');
        rosterItem.className = 'roster-item';
        rosterItem.innerHTML = `
          <div class="roster-item-info">
            <div class="roster-item-name">
              ${player.name}
              ${player.isCaptain ? '<span class="captain-badge">CAPTAIN</span>' : ''}
            </div>
          </div>
          <div class="roster-item-actions">
            ${!player.isCaptain ? `<button type="button" class="make-captain-btn" onclick="makeCaptain(${index})">Make Captain</button>` : ''}
            <button type="button" class="remove-player-btn" onclick="removePlayer(${index})">Remove</button>
          </div>
        `;
        rosterManager.appendChild(rosterItem);
      });
    }

    // Add player to roster
    addPlayerBtn.addEventListener('click', () => {
      const nameInput = document.getElementById('newPlayerName');
      const name = nameInput.value.trim();

      if (!name) {
        alert('Please enter a player name');
        return;
      }

      // Check if player already exists
      if (currentRoster.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        alert('This player is already on the roster');
        return;
      }

      currentRoster.push({
        name: name,
        isCaptain: false
      });

      nameInput.value = '';
      renderRosterManager();
    });

    // Make player captain
    window.makeCaptain = function(index) {
      // Remove captain status from all players
      currentRoster.forEach(p => p.isCaptain = false);
      // Set this player as captain
      currentRoster[index].isCaptain = true;
      renderRosterManager();
    };

    // Remove player from roster
    window.removePlayer = function(index) {
      if (confirm('Remove this player from the roster?')) {
        currentRoster.splice(index, 1);
        renderRosterManager();
      }
    };

    window.editTeamData = function(teamId) {
      if (!isAdminMode) return;

      currentEditTeamId = teamId;
      const team = teamsData[teamId];

      if (!team) return;

      document.getElementById('teamName').value = team.name;
      document.getElementById('teamSeed').value = team.seed;
      document.getElementById('teamWins').value = team.record?.wins || 0;
      document.getElementById('teamLosses').value = team.record?.losses || 0;
      document.getElementById('teamPointDiff').value = team.pointDiff || 0;

      // Load roster
      currentRoster = team.roster ? JSON.parse(JSON.stringify(team.roster)) : [];
      renderRosterManager();

      editTeamModal.classList.add('active');
    };

    cancelTeamEdit.addEventListener('click', () => {
      editTeamModal.classList.remove('active');
    });

    editTeamModal.addEventListener('click', (e) => {
      if (e.target === editTeamModal) {
        editTeamModal.classList.remove('active');
      }
    });

    teamForm.addEventListener('submit', (e) => {
      e.preventDefault();

      if (!currentEditTeamId) return;

      const { doc, updateDoc } = window.firestoreImports;
      const teamRef = doc(db, 'teams', currentEditTeamId);

      const updatedData = {
        name: document.getElementById('teamName').value,
        seed: parseInt(document.getElementById('teamSeed').value),
        record: {
          wins: parseInt(document.getElementById('teamWins').value),
          losses: parseInt(document.getElementById('teamLosses').value)
        },
        pointDiff: parseInt(document.getElementById('teamPointDiff').value),
        roster: currentRoster
      };

      updateDoc(teamRef, updatedData).then(() => {
        console.log('Team updated in database');
        editTeamModal.classList.remove('active');
      }).catch(error => {
        console.error('Error updating team:', error);
        alert('Error updating team: ' + error.message);
      });
    });

    // Copy link
    const chip = document.getElementById('copyLink');
    chip?.addEventListener('click', async () => {
      try { 
        await navigator.clipboard.writeText(location.href); 
        chip.textContent = 'Link copied!'; 
        setTimeout(() => chip.textContent = 'iba.tourney/2025', 1200); 
      } catch {}
    });

    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // Update stats bar counts
    function updateStatsBar() {
      // Update teams count
      const teamsCountEl = document.getElementById('teamsCount');
      if (teamsCountEl) {
        teamsCountEl.textContent = Object.keys(teamsData).length;
      }

      // Update players count (sum of all roster sizes)
      const playersCountEl = document.getElementById('playersCount');
      if (playersCountEl) {
        let totalPlayers = 0;
        Object.values(teamsData).forEach(team => {
          if (team.roster && Array.isArray(team.roster)) {
            totalPlayers += team.roster.length;
          }
        });
        playersCountEl.textContent = totalPlayers > 0 ? totalPlayers : '64+';
      }

      // Update champion name from bracket
      const championNameEl = document.getElementById('championName');
      if (championNameEl && bracketData) {
        const champion = bracketData['champion'];
        if (champion && champion !== 'TBD') {
          championNameEl.textContent = champion;
          championNameEl.style.fontSize = '1.5rem';
        } else {
          championNameEl.textContent = 'TBD';
          championNameEl.style.fontSize = '1.5rem';
        }
      }
    }

    // Initial update
    updateStatsBar();
    // Update whenever games change (use MutationObserver)
    const scheduleTable = document.querySelector('#scheduleTable tbody');
    if (scheduleTable) {
      const observer = new MutationObserver(updateStatsBar);
      observer.observe(scheduleTable, { childList: true });
    }

    // Admin lock monitoring function
    function startAdminLockMonitor() {
      const { doc, onSnapshot } = window.firestoreImports;
      const adminLockRef = doc(db, 'system', 'adminLock');

      // Listen for changes to admin lock
      window.adminLockUnsubscribe = onSnapshot(adminLockRef, (docSnap) => {
        if (isAdminMode && docSnap.exists()) {
          const lockData = docSnap.data();

          // If lock is released, log out this admin
          if (!lockData.isLocked) {
            console.log('Admin lock released - logging out');
            isAdminMode = false;
            document.body.classList.remove('admin-mode');
            adminBtn.textContent = 'Admin';
            adminBtn.style.background = 'var(--brand)';
            document.querySelectorAll('thead th:last-child').forEach(th => th.style.display = 'none');
            quickAddSection.style.display = 'none';
            const bulkImportBtn = document.getElementById('bulkImportBracketBtn');
            if (bulkImportBtn) bulkImportBtn.style.display = 'none';

            // Stop monitoring
            if (window.adminLockUnsubscribe) {
              window.adminLockUnsubscribe();
              window.adminLockUnsubscribe = null;
            }

            // Show notification
            alert('Admin session ended.');
          }
        }
      });
    }



    // Update button click handler to support logout
    adminBtn.addEventListener('click', () => {
      if (isAdminMode) {
        window.adminLogout();
      }
    });

    // Add game functionality
    const addGameBtn = document.getElementById('addGameBtn');
    const editGameModal = document.getElementById('editGameModal');
    const gameForm = document.getElementById('gameForm');
    const cancelEdit = document.getElementById('cancelEdit');
    const editGameTitle = document.getElementById('editGameTitle');
    const quickAddSection = document.querySelector('.quick-add-section');
    const quickAddInput = document.getElementById('quickAddInput');
    const quickAddBtn = document.getElementById('quickAddBtn');

    addGameBtn.addEventListener('click', () => {
      currentEditRow = null;
      editGameTitle.textContent = 'Add New Game';
      gameForm.reset();
      editGameModal.classList.add('active');
    });

    // Quick add functionality
    quickAddBtn.addEventListener('click', async () => {
      const input = quickAddInput.value.trim();
      if (!input) {
        alert('Please enter game details');
        return;
      }

      const parts = input.split(',').map(p => p.trim());
      if (parts.length !== 7) {
        alert('Invalid format. Use: Team1 vs Team2,Date,Day,Time,Court,Round,Status');
        return;
      }

      const [matchup, date, day, timeRaw, court, round, status] = parts;

      // Check if matchup contains " vs " (with spaces)
      if (!matchup.includes(' vs ')) {
        alert('Matchup must use " vs " format (e.g., "Team A vs Team B")');
        return;
      }

      // Convert time format (800pm -> 8:00 PM, 1000pm -> 10:00 PM)
      let time = timeRaw.toLowerCase().replace('pm', ' PM').replace('am', ' AM');
      time = time.replace(/(\d{1,2})(\d{2})\s/, '$1:$2 ');

      const gameData = {
        date,
        day,
        time,
        matchup, // Already has " vs " in it
        court,
        round,
        status
      };

      const { collection, addDoc } = window.firestoreImports;
      const db = window.db;

      try {
        const docRef = await addDoc(collection(db, 'games'), gameData);

        // Sync to teams
        await syncGameToTeams(gameData, docRef.id);

        quickAddInput.value = '';
        alert('Game added successfully!');
      } catch (error) {
        console.error('Error adding game:', error);
        alert('Error adding game: ' + error.message);
      }
    });

    // Allow Enter key for quick add
    quickAddInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        quickAddBtn.click();
      }
    });

    // Team icon editing functionality
    const editIconModal = document.getElementById('editIconModal');
    const editIconTeamName = document.getElementById('editIconTeamName');
    const iconPicker = document.getElementById('iconPicker');
    const cancelIconEdit = document.getElementById('cancelIconEdit');
    const saveIconBtn = document.getElementById('saveIcon');
    let currentEditTeam = null;
    let selectedIcon = null;

    const availableIcons = ['üèÄ', 'üî•', '‚ö°', 'üí™', 'üèÜ', 'üëë', '‚≠ê', 'üåü', 'üíé', 'üöÄ', 'üõ°Ô∏è', 'üéØ', 'ü™£', 'üå∂Ô∏è', 'üèüÔ∏è', '‚öΩ', 'üéÆ', 'üé®', 'ü¶Å', 'üêØ', 'ü¶Ö', 'üêâ', 'ü¶à', 'üê∫', 'ü¶ä', 'üêª', 'ü¶Ñ', 'üî±', '‚öîÔ∏è', 'üé™'];

    window.editTeamIcon = function(teamId) {
      if (!isAdminMode) return;
      
      currentEditTeam = teamId;
      const team = teamsData[teamId];
      editIconTeamName.textContent = team.name;
      
      // Get current icon
      const teamCard = document.querySelector(`[data-team="${teamId}"]`);
      const currentIcon = teamCard.querySelector('.avatar').textContent;
      selectedIcon = currentIcon;
      
      // Populate icon picker
      iconPicker.innerHTML = availableIcons.map(icon => 
        `<div class="icon-option ${icon === currentIcon ? 'selected' : ''}" data-icon="${icon}">${icon}</div>`
      ).join('');
      
      // Add click handlers
      iconPicker.querySelectorAll('.icon-option').forEach(option => {
        option.addEventListener('click', () => {
          iconPicker.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedIcon = option.dataset.icon;
        });
      });
      
      editIconModal.classList.add('active');
    };

    cancelIconEdit.addEventListener('click', () => {
      editIconModal.classList.remove('active');
    });

    editIconModal.addEventListener('click', (e) => {
      if (e.target === editIconModal) {
        editIconModal.classList.remove('active');
      }
    });

    saveIconBtn.addEventListener('click', () => {
      if (!currentEditTeam || !selectedIcon) return;

      // Save to Firestore
      const { doc, updateDoc } = window.firestoreImports;
      const teamRef = doc(db, 'teams', currentEditTeam);

      updateDoc(teamRef, { icon: selectedIcon }).then(() => {
        console.log('Team icon updated in database');
        editIconModal.classList.remove('active');
      }).catch(error => {
        console.error('Error updating team icon:', error);
        alert('Error updating team icon: ' + error.message);
      });
    });

    // Bracket editing functionality
    window.editBracketSlot = function(slotId) {
      if (!isAdminMode) return;

      const currentName = document.querySelector(`[data-slot="${slotId}"] .team-name`).textContent;
      const teamName = prompt('Enter team name for this slot:', currentName);

      if (teamName !== null) {
        const newName = teamName.trim() || 'TBD';
        document.querySelector(`[data-slot="${slotId}"] .team-name`).textContent = newName;

        // Save to Firebase
        const { doc, setDoc, getDoc } = window.firestoreImports;
        const bracketRef = doc(db, 'tournament', 'bracket');

        getDoc(bracketRef).then((docSnap) => {
          const currentBracket = docSnap.exists() ? docSnap.data() : {};
          currentBracket[slotId] = newName;

          setDoc(bracketRef, currentBracket).then(() => {
            console.log('Bracket updated in database');
          }).catch(error => {
            console.error('Error saving bracket:', error);
            alert('Error saving bracket: ' + error.message);
          });
        });
      }
    };

    // Bulk import bracket functionality
    const bulkImportBracketBtn = document.getElementById('bulkImportBracketBtn');
    const bulkImportModal = document.getElementById('bulkImportModal');
    const bulkBracketData = document.getElementById('bulkBracketData');
    const cancelBulkImport = document.getElementById('cancelBulkImport');
    const submitBulkImport = document.getElementById('submitBulkImport');

    bulkImportBracketBtn.addEventListener('click', () => {
      if (!isAdminMode) return;
      bulkImportModal.classList.add('active');
    });

    cancelBulkImport.addEventListener('click', () => {
      bulkImportModal.classList.remove('active');
    });

    bulkImportModal.addEventListener('click', (e) => {
      if (e.target === bulkImportModal) {
        bulkImportModal.classList.remove('active');
      }
    });

    submitBulkImport.addEventListener('click', () => {
      if (!isAdminMode) return;

      try {
        const bracketDataInput = bulkBracketData.value.trim();
        if (!bracketDataInput) {
          alert('Please enter bracket data');
          return;
        }

        const bracketObj = JSON.parse(bracketDataInput);

        // Validate the data structure
        if (typeof bracketObj !== 'object' || Array.isArray(bracketObj)) {
          alert('Invalid bracket data format. Must be a JSON object.');
          return;
        }

        // Save to Firestore
        const { doc, setDoc } = window.firestoreImports;
        const bracketRef = doc(db, 'tournament', 'bracket');

        setDoc(bracketRef, bracketObj).then(() => {
          console.log('‚úÖ Bracket imported successfully');
          alert('Bracket data imported successfully!');
          bulkImportModal.classList.remove('active');
          bulkBracketData.value = '';

          // Update UI immediately
          Object.entries(bracketObj).forEach(([slotId, teamName]) => {
            const slotElement = document.querySelector(`[data-slot="${slotId}"] .team-name`);
            if (slotElement) {
              slotElement.textContent = teamName || 'TBD';
            }
          });
        }).catch(error => {
          console.error('‚ùå Error importing bracket:', error);
          alert('Error importing bracket: ' + error.message);
        });
      } catch (error) {
        console.error('‚ùå Error parsing JSON:', error);
        alert('Invalid JSON format. Please check your data and try again.');
      }
    });

    cancelEdit.addEventListener('click', () => {
      editGameModal.classList.remove('active');
    });

    editGameModal.addEventListener('click', (e) => {
      if (e.target === editGameModal) {
        editGameModal.classList.remove('active');
      }
    });

    // Complete game modal logic
    const completeGameModal = document.getElementById('completeGameModal');
    const completeGameMatchup = document.getElementById('completeGameMatchup');
    const team1Score = document.getElementById('team1Score');
    const team2Score = document.getElementById('team2Score');
    const team1WinBtn = document.getElementById('team1WinBtn');
    const team2WinBtn = document.getElementById('team2WinBtn');
    const team1WinName = document.getElementById('team1WinName');
    const team2WinName = document.getElementById('team2WinName');
    const submitCompleteGame = document.getElementById('submitCompleteGame');
    const cancelCompleteGame = document.getElementById('cancelCompleteGame');
    let selectedWinner = null;
    let currentCompleteGameData = null;

    // Winner button selection
    team1WinBtn.addEventListener('click', () => {
      selectedWinner = 1;
      team1WinBtn.classList.add('selected');
      team2WinBtn.classList.remove('selected');
    });

    team2WinBtn.addEventListener('click', () => {
      selectedWinner = 2;
      team2WinBtn.classList.add('selected');
      team1WinBtn.classList.remove('selected');
    });

    cancelCompleteGame.addEventListener('click', () => {
      completeGameModal.classList.remove('active');
    });

    completeGameModal.addEventListener('click', (e) => {
      if (e.target === completeGameModal) {
        completeGameModal.classList.remove('active');
      }
    });

    submitCompleteGame.addEventListener('click', async () => {
      const score1 = parseInt(team1Score.value);
      const score2 = parseInt(team2Score.value);

      if (isNaN(score1) || isNaN(score2)) {
        alert('Please enter valid scores for both teams');
        return;
      }

      if (!selectedWinner) {
        alert('Please select a winner');
        return;
      }

      try {
        const { doc, updateDoc, getDoc } = window.firestoreImports;
        const gameRef = doc(db, 'games', currentCompleteGameData.docId);

        // Update game status to completed and add completion timestamp
        await updateDoc(gameRef, {
          status: 'Completed',
          completedAt: new Date().toISOString()
        });

        console.log('üéØ Completing game:', currentCompleteGameData.matchup);

        // Update team records with win/loss and score
        const teams = currentCompleteGameData.matchup.split(' vs ');
        const team1Name = teams[0].trim();
        const team2Name = teams[1].trim();

        console.log('üë• Team 1:', team1Name);
        console.log('üë• Team 2:', team2Name);
        console.log('üìã Available teams:', Object.keys(teamsData).map(id => teamsData[id].name));
        console.log('üìä Full teamsData:', teamsData);

        const team1Id = findTeamIdByName(team1Name);
        const team2Id = findTeamIdByName(team2Name);

        console.log('üîë Team 1 ID:', team1Id);
        console.log('üîë Team 2 ID:', team2Id);

        if (!team1Id || !team2Id) {
          console.error('‚ùå Could not find team IDs!');
          console.log('üîç Searching for:', team1Name, 'and', team2Name);
          console.log('üìù Team names in database:');
          Object.keys(teamsData).forEach(id => {
            console.log(`  - "${teamsData[id].name}" (ID: ${id})`);
          });
          alert('Error: Could not find teams. Please check console for details.');
          return;
        }

        if (team1Id && team2Id) {
          const team1Ref = doc(db, 'teams', team1Id);
          const team2Ref = doc(db, 'teams', team2Id);

          const team1Doc = await getDoc(team1Ref);
          const team2Doc = await getDoc(team2Ref);

          console.log('üìÑ Team 1 exists:', team1Doc.exists());
          console.log('üìÑ Team 2 exists:', team2Doc.exists());

          if (team1Doc.exists() && team2Doc.exists()) {
            const team1Data = team1Doc.data();
            const team2Data = team2Doc.data();

            // Determine winner and loser
            const team1Won = selectedWinner === 1;
            const team2Won = selectedWinner === 2;

            // Remove from upcoming games
            const team1UpcomingGames = (team1Data.upcomingGames || []).filter(
              g => !(g.opponent === team2Name && g.date === currentCompleteGameData.day)
            );
            const team2UpcomingGames = (team2Data.upcomingGames || []).filter(
              g => !(g.opponent === team1Name && g.date === currentCompleteGameData.day)
            );

            // Remove from completed games if already exists (to avoid duplicates), then add new one
            let team1CompletedGames = (team1Data.completedGames || []).filter(
              g => !(g.opponent === team2Name && g.date === currentCompleteGameData.day)
            );
            let team2CompletedGames = (team2Data.completedGames || []).filter(
              g => !(g.opponent === team1Name && g.date === currentCompleteGameData.day)
            );

            // Add the completed game with actual results
            team1CompletedGames.push({
              opponent: team2Name,
              result: team1Won ? 'W' : 'L',
              score: `${score1}-${score2}`,
              date: currentCompleteGameData.day
            });

            team2CompletedGames.push({
              opponent: team1Name,
              result: team2Won ? 'W' : 'L',
              score: `${score2}-${score1}`,
              date: currentCompleteGameData.day
            });

            console.log('üìù About to update teams:');
            console.log(`  Team 1 (${team1Name}) completed games:`, team1CompletedGames);
            console.log(`  Team 2 (${team2Name}) completed games:`, team2CompletedGames);

            // Update both teams (do not change win/loss records)
            await updateDoc(team1Ref, {
              upcomingGames: team1UpcomingGames,
              completedGames: team1CompletedGames
            });
            console.log('‚úÖ Team 1 updated successfully');

            await updateDoc(team2Ref, {
              upcomingGames: team2UpcomingGames,
              completedGames: team2CompletedGames
            });
            console.log('‚úÖ Team 2 updated successfully');

            console.log('‚úÖ Game completed and teams updated');
          }
        }

        // Close both modals
        completeGameModal.classList.remove('active');
        editGameModal.classList.remove('active');

        // Reset state
        currentEditRow = null;
        selectedWinner = null;
      } catch (error) {
        console.error('Error completing game:', error);
        alert('Error completing game: ' + error.message);
      }
    });

    gameForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const { collection, addDoc, updateDoc, doc } = window.firestoreImports;
      const db = window.db;

      const date = document.getElementById('gameDate').value;
      const day = document.getElementById('gameDay').value;
      const time = document.getElementById('gameTime').value;
      const matchup = document.getElementById('gameMatchup').value;
      const court = document.getElementById('gameCourt').value;
      const round = document.getElementById('gameRound').value;
      const status = document.getElementById('gameStatus').value;

      // Check if status is being changed to Completed
      if (status === 'Completed' && currentEditRow) {
        const docId = currentEditRow.dataset.docId;
        currentCompleteGameData = { docId, matchup, day, date, time, court, round };

        // Parse team names
        const teams = matchup.split(' vs ');
        if (teams.length !== 2) {
          alert('Invalid matchup format. Must be "Team A vs Team B"');
          return;
        }

        team1WinName.textContent = teams[0].trim();
        team2WinName.textContent = teams[1].trim();

        // Reset form
        team1Score.value = '';
        team2Score.value = '';
        selectedWinner = null;
        team1WinBtn.classList.remove('selected');
        team2WinBtn.classList.remove('selected');

        // Show complete game modal (don't close edit game modal yet)
        completeGameMatchup.textContent = matchup;
        completeGameModal.classList.add('active');
        return; // Stop here - don't save the game yet
      }

      const gameData = { date, day, time, matchup, court, round, status };

      try {
        if (currentEditRow) {
          // Update existing game in Firestore
          const docId = currentEditRow.dataset.docId;
          const gameRef = doc(db, 'games', docId);
          await updateDoc(gameRef, gameData);

          // Sync to teams only for non-completed games
          await syncGameToTeams(gameData, docId);

          editGameModal.classList.remove('active');
          currentEditRow = null; // Reset current edit row
        } else {
          // Add new game to Firestore
          const docRef = await addDoc(collection(db, 'games'), gameData);

          // Sync to teams
          await syncGameToTeams(gameData, docRef.id);

          editGameModal.classList.remove('active');
        }
      } catch (error) {
        console.error('Error saving game:', error);
        alert('Error saving game. Please try again.');
      }
    });

    // Edit and delete functions (global scope)
    window.editGame = function(btn) {
      if (!isAdminMode) return;
      currentEditRow = btn.closest('tr');
      const cells = currentEditRow.cells;

      editGameTitle.textContent = 'Edit Game';
      document.getElementById('gameDate').value = cells[0].textContent;
      document.getElementById('gameDay').value = cells[1].textContent;
      document.getElementById('gameTime').value = cells[2].textContent;
      document.getElementById('gameMatchup').value = cells[3].textContent;
      document.getElementById('gameCourt').value = cells[4].textContent;
      document.getElementById('gameRound').value = cells[5].textContent;
      document.getElementById('gameStatus').value = cells[6].querySelector('.badge').textContent.trim();

      editGameModal.classList.add('active');
    };

    window.deleteGame = async function(btn) {
      if (!isAdminMode) return;
      if (confirm('Are you sure you want to delete this game?')) {
        console.log('üóëÔ∏è Deleting game...');
        const { deleteDoc, doc } = window.firestoreImports;
        const db = window.db;

        const row = btn.closest('tr');
        const docId = row.dataset.docId;
        const matchup = row.cells[3].textContent;
        const day = row.cells[1].textContent;

        try {
          // Remove from teams first
          await removeGameFromTeams(matchup, day);

          // Then delete the game
          console.log('Deleting document ID:', docId);
          const gameRef = doc(db, 'games', docId);
          await deleteDoc(gameRef);
          console.log('‚úÖ Game deleted successfully');
        } catch (error) {
          console.error('‚ùå Error deleting game:', error);
          alert('Error deleting game: ' + error.message);
        }
      }
    };

    // Schedule filters
    const search = document.getElementById('search');
    const dayFilter = document.getElementById('dayFilter');
    const courtFilter = document.getElementById('courtFilter');
    const searchBtn = document.getElementById('searchBtn');
    const rows = document.querySelectorAll('#scheduleTable tbody tr');

    function applyFilters() {
      const q = (search.value || '').toLowerCase();
      const day = dayFilter.value;
      const court = courtFilter.value;
      const allRows = Array.from(document.querySelectorAll('#scheduleTable tbody tr'));
      allRows.forEach(tr => {
        const cells = tr.children;
        const matchesQuery = !q || tr.textContent.toLowerCase().includes(q);
        const matchesDay = !day || cells[1].textContent === day;
        const matchesCourt = !court || cells[4].textContent === court;
        tr.style.display = (matchesQuery && matchesDay && matchesCourt) ? '' : 'none';
      });
    }
    
    searchBtn.addEventListener('click', applyFilters);
    search.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
    [dayFilter, courtFilter].forEach(el => el.addEventListener('change', applyFilters));

    // Contact form submission
    const contactForm = document.getElementById('contactForm');
    const contactStatus = document.getElementById('contactStatus');

    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const contactInfo = document.getElementById('contactInfo').value;
      const message = document.getElementById('contactMessage').value;
      const submitBtn = document.getElementById('contactSubmit');

      // Disable button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      const messageData = {
        contactInfo: contactInfo,
        message: message,
        timestamp: new Date().toISOString(),
        read: false
      };

      try {
        const { collection, addDoc } = window.firestoreImports;
        await addDoc(collection(db, 'messages'), messageData);

        // Show success message
        contactStatus.style.display = 'block';
        contactStatus.style.background = '#22c55e';
        contactStatus.style.color = 'white';
        contactStatus.textContent = '‚úì Message sent successfully! We\'ll get back to you soon.';

        // Clear form
        contactForm.reset();

        // Hide success message after 5 seconds
        setTimeout(() => {
          contactStatus.style.display = 'none';
        }, 5000);
      } catch (error) {
        console.error('Error sending message:', error);

        // Show error message
        contactStatus.style.display = 'block';
        contactStatus.style.background = '#ef4444';
        contactStatus.style.color = 'white';
        contactStatus.textContent = '‚úó Error sending message. Please try again or contact us directly.';
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
      }
    });

    }); // End of waitForFirebase
  </script>
</body>
</html>
