rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is main admin
    function isMainAdmin() {
      return request.auth != null && request.auth.uid == 'seZ01FolJbSajEKTIsljwGtYHGD3';
    }

    // Helper function to check if user is an approved admin
    function isApprovedAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/approved_admins/$(request.auth.uid));
    }

    // Helper function to check if user is any admin (main or approved)
    function isAdmin() {
      return isMainAdmin() || isApprovedAdmin();
    }

    // Admin biometric credentials - only accessible by server-side functions
    match /admin/{document=**} {
      allow read, write: if false; // Only Cloud Functions can access
    }

    // Auth challenges - only accessible by server-side functions
    match /auth_challenges/{document=**} {
      allow read, write: if false; // Only Cloud Functions can access
    }

    // Admin sessions - only accessible by server-side functions
    match /admin_sessions/{document=**} {
      allow read, write: if false; // Only Cloud Functions can access
    }

    // Admin requests - authenticated users can create, only main admin can read/update
    match /admin_requests/{requestId} {
      allow create: if request.auth != null; // Authenticated users can request admin access
      allow read, update, delete: if isMainAdmin(); // Only main admin can manage requests
    }

    // Approved admins - authenticated users can check if they're approved
    match /approved_admins/{adminId} {
      allow read: if request.auth != null; // Any authenticated user can check if they're approved
      allow write: if isMainAdmin(); // Only main admin can approve/remove admins
    }

    // Games collection - read by anyone, write only by admins
    match /games/{gameId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Teams collection - read by anyone, write only by admins
    match /teams/{teamId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Bracket collection - read by anyone, write only by admins
    match /bracket/{bracketId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tournament collection - read by anyone, write only by admins
    match /tournament/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Contact messages - anyone can create (rate limited recommended), only admins can read
    match /contact_messages/{messageId} {
      // Allow creation with size limits to prevent abuse
      allow create: if request.resource.data.size() < 10000; // Limit message size
      allow read, update, delete: if isAdmin();
    }

    // System collection - read by anyone, write restricted to prevent abuse
    match /system/{document} {
      allow read: if true;
      // Only allow specific document updates (e.g., visitor_count)
      // Prevent spam by restricting to authenticated users
      allow write: if request.auth != null && document == 'visitor_count';
    }

    // Users collection - users can read all profiles but only edit their own
    match /users/{userId} {
      allow read: if true; // Anyone can read user profiles
      allow create: if request.auth != null && request.auth.uid == userId; // Users can create their own profile
      // Users can update their own profile but CANNOT modify roles
      // Admins can update any user including roles
      allow update: if (request.auth != null && request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles'])) || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Player teams - authenticated users can create, read all, captains can update their own
    match /player_teams/{teamId} {
      allow read: if true; // Anyone can read teams
      allow create: if request.auth != null; // Authenticated users can create teams
      allow update: if request.auth != null && request.auth.uid == resource.data.captainUid; // Only captain can update
      allow delete: if request.auth != null && request.auth.uid == resource.data.captainUid; // Only captain can delete
    }

    // Team join requests - players can create, captains can read/update requests for their teams
    match /team_join_requests/{requestId} {
      allow create: if request.auth != null; // Authenticated users can create join requests
      allow read: if request.auth != null; // Authenticated users can read join requests
      allow update: if request.auth != null && request.auth.uid == resource.data.captainUid; // Only captain can update
      allow delete: if request.auth != null && (request.auth.uid == resource.data.captainUid || request.auth.uid == resource.data.playerUid); // Captain or requester can delete
    }
  }
}
