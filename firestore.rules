rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user is the document owner
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function to check if user is main admin
    function isMainAdmin() {
      return request.auth != null && request.auth.uid == 'seZ01FolJbSajEKTIsljwGtYHGD3';
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isSignedIn() && (
        isMainAdmin() ||
        exists(/databases/$(database)/documents/approved_admins/$(request.auth.uid)) ||
        (exists(/databases/$(database)/documents/admin_requests/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/admin_requests/$(request.auth.uid)).data.status == 'approved')
      );
    }

    // Helper function to check if user is team captain
    function isTeamCaptain(teamId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/player_teams/$(teamId)) &&
             get(/databases/$(database)/documents/player_teams/$(teamId)).data.captain == request.auth.uid;
    }

    // Admin biometric credentials - only accessible by server-side functions
    match /admin/{document=**} {
      allow read, write: if false; // Only Cloud Functions can access
    }

    // Auth challenges - only accessible by server-side functions
    match /auth_challenges/{document=**} {
      allow read, write: if false; // Only Cloud Functions can access
    }

    // Admin sessions - only accessible by server-side functions
    match /admin_sessions/{document=**} {
      allow read, write: if false; // Only Cloud Functions can access
    }

    // Users collection - only user can read/write their own document
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      // Users can update their own profile but CANNOT modify roles
      // Admins can update any user including roles
      allow update: if (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles'])) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    // Admin requests collection
    match /admin_requests/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Approved admins collection - read-only for all authenticated users
    match /approved_admins/{adminId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Player teams collection
    match /player_teams/{teamId} {
      // Anyone can read teams
      allow read: if true;

      // Only authenticated users can create teams
      allow create: if isSignedIn() &&
                      request.resource.data.captain == request.auth.uid &&
                      request.resource.data.members[0] == request.auth.uid;

      // Only team captain or admin can update/delete team
      allow update: if isTeamCaptain(teamId) || isAdmin();
      allow delete: if isTeamCaptain(teamId) || isAdmin();
    }

    // Team join requests
    match /team_requests/{requestId} {
      // Users can read their own requests
      // Team captains can read requests for their teams
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isTeamCaptain(resource.data.teamId) ||
        isAdmin()
      );

      // Only authenticated users can create requests
      allow create: if isSignedIn() &&
                      request.resource.data.userId == request.auth.uid;

      // Only team captain can update request status
      allow update: if isTeamCaptain(resource.data.teamId) || isAdmin();

      // Users can delete their own pending requests
      allow delete: if isOwner(resource.data.userId) ||
                      isTeamCaptain(resource.data.teamId) ||
                      isAdmin();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isOwner(resource.data.userId);

      // Anyone authenticated can create notifications (for team requests, etc.)
      allow create: if isSignedIn();

      // Users can update (mark as read) their own notifications
      allow update: if isOwner(resource.data.userId);

      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // Message templates - read by all, write by admins only
    match /message_templates/{templateId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Games collection
    match /games/{gameId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Teams collection (for team stats/standings)
    match /teams/{teamId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tournament bracket
    match /tournament/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tournament entries (Winter Mini Tournament)
    match /tournament_entries/{entryId} {
      // Anyone can read active entries
      allow read: if resource.data.status == 'active';

      // Anyone can create entries (no authentication required)
      // Add size limit to prevent abuse
      allow create: if request.resource.data.size() < 10000;

      // Only admins can update entries
      allow update: if isAdmin();

      // Only admins can delete entries
      allow delete: if isAdmin();
    }

    // Free agents collection (players looking for teams)
    match /freeAgents/{agentId} {
      // Anyone can read active free agent profiles
      allow read: if true;

      // Only authenticated users can create their own profile
      allow create: if isSignedIn() &&
                      request.resource.data.uid == request.auth.uid;

      // Users can update/delete their own profile, admins can update/delete any
      allow update: if isSignedIn() && (
        resource.data.uid == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        resource.data.uid == request.auth.uid ||
        isAdmin()
      );
    }

    // Team invites collection (teams inviting free agents)
    match /teamInvites/{inviteId} {
      // Team captains can read invites they sent
      // Free agents can read invites sent to them
      // Admins can read all invites
      allow read: if isSignedIn() && (
        resource.data.captainUid == request.auth.uid ||
        resource.data.playerEmail == request.auth.token.email ||
        isAdmin()
      );

      // Only authenticated team captains can create invites
      allow create: if isSignedIn() &&
                      request.resource.data.captainUid == request.auth.uid;

      // Only the free agent receiving the invite or admin can update (accept/decline)
      allow update: if isSignedIn() && (
        resource.data.playerEmail == request.auth.token.email ||
        isAdmin()
      );

      // Captains and admins can delete invites
      allow delete: if isSignedIn() && (
        resource.data.captainUid == request.auth.uid ||
        isAdmin()
      );
    }

    // Contact messages - anyone can create (rate limited recommended), only admins can read
    match /contact_messages/{messageId} {
      // Allow creation with size limits to prevent abuse
      allow create: if request.resource.data.size() < 10000; // Limit message size
      allow read, update, delete: if isAdmin();
    }

    // System collection - read by anyone, write restricted to prevent abuse
    match /system/{document} {
      allow read: if true;
      // Only allow specific document updates (e.g., visitor_count)
      // Prevent spam by restricting to authenticated users
      allow write: if request.auth != null && document == 'visitor_count';
    }
  }
}
