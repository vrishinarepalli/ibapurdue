<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Initialize Firestore Database</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #0b0f1a;
      color: #e7ecf6;
    }
    .container {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 2rem;
    }
    .login-container {
      max-width: 400px;
      margin: 2rem auto;
    }
    .error-msg {
      color: #ef4444;
      margin-top: 0.5rem;
      display: none;
    }
    #mainContent {
      display: none;
    }
    h1 {
      color: #ff9d00;
      margin-top: 0;
    }
    button {
      background: #ff9d00;
      color: #0b0f1a;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .success {
      background: #22c55e;
      color: white;
    }
    .warning {
      background: #f59e0b;
    }
    #log {
      background: #0a1122;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .log-entry {
      margin: 0.25rem 0;
    }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-info { color: #60a5fa; }
    .log-warning { color: #f59e0b; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="container login-container">
    <h1>üîê Admin Access Required</h1>
    <p>Sign in with your admin Google account to access Firestore tools.</p>
    <button onclick="signInWithGoogle()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
      <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
        <path fill="none" d="M0 0h48v48H0z"/>
      </svg>
      Sign in with Google
    </button>
    <div id="errorMsg" class="error-msg">Authentication failed</div>
  </div>

  <!-- Main Content (hidden until authenticated) -->
  <div id="mainContent" class="container">
    <h1>üî• Initialize Firestore Database</h1>
    <p>This tool will populate your Firestore database with initial team and bracket data.</p>

    <div>
      <button id="initTeamsBtn" onclick="initializeTeams()">Initialize Teams</button>
      <button id="initBracketBtn" onclick="initializeBracket()">Initialize Bracket</button>
      <button id="initPasswordBtn" onclick="initializeAdminPassword()">Set Admin Password</button>
      <button id="initInitPasswordBtn" onclick="initializeInitPassword()">Set Init Password</button>
      <button class="success" onclick="initializeAll()">Initialize All Data</button>
      <button class="warning" onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <hr style="margin: 2rem 0; border: 1px solid #1f2937;">

    <h2 style="color: #ff9d00;">üèÄ Spring 2026 Tournament Applications</h2>
    <p>View all tournament applications submitted by teams.</p>
    <button onclick="loadTournamentApplications()" style="margin-bottom: 1rem;">üîÑ Load Applications</button>

    <div id="tournamentApplicationsContainer" style="margin-top: 1rem;">
      <p style="color: #94a3b8;">Click "Load Applications" to view all submissions.</p>
    </div>

    <hr style="margin: 2rem 0; border: 1px solid #1f2937;">

    <h2 style="color: #ff9d00;">üìã Pending Admin Requests</h2>
    <p>Review and approve/decline admin access requests from users.</p>
    <button onclick="loadAdminRequests()" style="margin-bottom: 1rem;">üîÑ Refresh Requests</button>

    <div id="adminRequestsContainer" style="margin-top: 1rem;">
      <p style="color: var(--muted);">Click "Refresh Requests" to load pending requests.</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, getDocs, getDoc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBN0rfpzjredziJbPny-YfEgq4uE2l1hzE",
      authDomain: "iba-website-63cb3.firebaseapp.com",
      projectId: "iba-website-63cb3",
      storageBucket: "iba-website-63cb3.firebasestorage.app",
      messagingSenderId: "267064036667",
      appId: "1:267064036667:web:4f9d28aac0d5ae4ca97b1e",
      measurementId: "G-GGH99DCY07"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Admin UID
    const ADMIN_UID = 'seZ01FolJbSajEKTIsljwGtYHGD3';

    // Make available globally
    window.db = db;
    window.auth = auth;
    window.ADMIN_UID = ADMIN_UID;
    window.firestoreImports = { collection, doc, setDoc, getDocs, getDoc, query, where, orderBy };
    window.authImports = { signInWithEmailAndPassword, signOut };

    // Check if user is already signed in
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Check if user is admin or approved admin
        const isMainAdmin = user.uid === ADMIN_UID;
        let isApprovedAdmin = false;

        if (!isMainAdmin) {
          const approvedAdminDoc = await getDoc(doc(db, 'approved_admins', user.uid));
          isApprovedAdmin = approvedAdminDoc.exists();
        }

        if (isMainAdmin || isApprovedAdmin) {
          // User is admin - show main content
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          log(`‚úÖ Signed in as: ${user.email}`, 'success');
        } else {
          // User is signed in but not admin
          document.getElementById('errorMsg').textContent = 'You do not have admin privileges';
          document.getElementById('errorMsg').style.display = 'block';
          await auth.signOut();
        }
      }
    });

    // Google Sign-In
    window.signInWithGoogle = async function() {
      const errorMsg = document.getElementById('errorMsg');
      const loginBtn = document.querySelector('#loginScreen button');

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';
      errorMsg.style.display = 'none';

      try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Check if the logged-in user is the admin or approved admin
        const isMainAdmin = user.uid === ADMIN_UID;
        let isApprovedAdmin = false;

        if (!isMainAdmin) {
          const approvedAdminDoc = await getDoc(doc(db, 'approved_admins', user.uid));
          isApprovedAdmin = approvedAdminDoc.exists();
        }

        if (!isMainAdmin && !isApprovedAdmin) {
          errorMsg.textContent = 'You do not have admin privileges';
          errorMsg.style.display = 'block';
          await auth.signOut();
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign in with Google';
          return;
        }

        // Success - show main content
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        errorMsg.style.display = 'none';
        log(`‚úÖ Signed in successfully as ${user.email}`, 'success');
      } catch (error) {
        console.error('Error signing in:', error);
        if (error.code === 'auth/popup-closed-by-user') {
          errorMsg.textContent = 'Sign-in cancelled';
        } else if (error.code === 'auth/unauthorized-domain') {
          errorMsg.textContent = 'Unauthorized domain. Please contact admin to add this domain to Firebase Auth.';
        } else {
          errorMsg.textContent = 'Error signing in. Please try again.';
        }
        errorMsg.style.display = 'block';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign in with Google';
      }
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };

    window.initializeTeams = async function() {
      const btn = document.getElementById('initTeamsBtn');
      btn.disabled = true;
      log('Starting teams initialization...', 'info');

      const teamsData = {
        'mutts': {
          name: 'Mutts and Fulls',
          seed: 1,
          icon: 'üèÄ',
          record: { wins: 3, losses: 0 },
          pointDiff: 42,
          roster: [],
          completedGames: [
            { opponent: 'Buckit', result: 'W', score: '21-8', date: 'Sep 22' },
            { opponent: 'Certified Bucket Getters', result: 'W', score: '19-0', date: 'Sep 29' },
            { opponent: 'The Blue Ballers', result: 'W', score: '22-12', date: 'Oct 1' }
          ],
          upcomingGames: []
        },
        'bbb': {
          name: 'BBB',
          seed: 2,
          icon: 'üî•',
          record: { wins: 3, losses: 0 },
          pointDiff: 38,
          roster: [],
          completedGames: [
            { opponent: 'ARE 3.0', result: 'W', score: '21-18', date: 'Sep 22' },
            { opponent: 'Lafayette Lakers', result: 'W', score: '21-2', date: 'Oct 1' },
            { opponent: 'Rasthuggers', result: 'W', score: '21-5', date: 'Oct 2' }
          ],
          upcomingGames: []
        },
        'rajesh': {
          name: "Rajesh's Last Dance",
          seed: 3,
          icon: 'üõ°Ô∏è',
          record: { wins: 3, losses: 0 },
          pointDiff: 27,
          roster: [],
          completedGames: [
            { opponent: 'Buzz Ballers', result: 'W', score: '9-0', date: 'Sep 25' },
            { opponent: 'SAP Center', result: 'W', score: '21-14', date: 'Sep 30' },
            { opponent: 'LeBronda', result: 'W', score: '11-0', date: 'Oct 2' }
          ],
          upcomingGames: []
        },
        'club': {
          name: 'Club ballers',
          seed: 4,
          icon: '‚ö°',
          record: { wins: 3, losses: 0 },
          pointDiff: 20,
          roster: [],
          completedGames: [
            { opponent: 'Ja Wick', result: 'W', score: '22-11', date: 'Sep 22' },
            { opponent: 'RRN', result: 'W', score: '21-16', date: 'Sep 24' },
            { opponent: 'gutti boys', result: 'W', score: '21-17', date: 'Sep 30' }
          ],
          upcomingGames: []
        },
        'navsandeep': {
          name: 'Nav/Sandeep',
          seed: 5,
          icon: '‚≠ê',
          record: { wins: 3, losses: 0 },
          pointDiff: 18,
          roster: [],
          completedGames: [
            { opponent: 'Diko & Co.', result: 'W', score: '22-18', date: 'Sep 22' },
            { opponent: 'Kareem Puffs', result: 'W', score: '21-14', date: 'Sep 29' },
            { opponent: 'Tech Support', result: 'W', score: '21-14', date: 'Oct 2' }
          ],
          upcomingGames: []
        },
        'kos': {
          name: 'KOS',
          seed: 6,
          icon: 'üëë',
          record: { wins: 3, losses: 0 },
          pointDiff: 17,
          roster: [],
          completedGames: [
            { opponent: 'Swish Kebabs', result: 'W', score: '21-18', date: 'Sep 25' },
            { opponent: 'Tandoori Towers', result: 'W', score: '21-11', date: 'Sep 29' },
            { opponent: '67 Elite Freaks', result: 'W', score: '21-17', date: 'Sep 30' }
          ],
          upcomingGames: []
        },
        'lemickey': {
          name: 'LeMickey',
          seed: 7,
          icon: 'üèÜ',
          record: { wins: 3, losses: 0 },
          pointDiff: 13,
          roster: [],
          completedGames: [
            { opponent: 'Squirt Sisters', result: 'W', score: '21-18', date: 'Sep 25' },
            { opponent: 'Fuse', result: 'W', score: '21-13', date: 'Sep 30' },
            { opponent: 'Hoop', result: 'W', score: '21-19', date: 'Oct 1' }
          ],
          upcomingGames: []
        },
        'bbs': {
          name: 'BBS',
          seed: 8,
          icon: 'üí™',
          record: { wins: 3, losses: 0 },
          pointDiff: 11,
          roster: [],
          completedGames: [
            { opponent: 'Walmart Oreos', result: 'W', score: '21-15', date: 'Sep 22' },
            { opponent: 'The Baboons', result: 'W', score: '21-19', date: 'Sep 29' },
            { opponent: 'Naujawan', result: 'W', score: '21-18', date: 'Oct 1' }
          ],
          upcomingGames: []
        },
        'gutti': {
          name: 'gutti boys',
          seed: 9,
          icon: 'üåü',
          record: { wins: 2, losses: 1 },
          pointDiff: 20,
          roster: [],
          completedGames: [
            { opponent: 'Ja Wick', result: 'W', score: '21-7', date: 'Sep 25' },
            { opponent: 'Club ballers', result: 'L', score: '17-21', date: 'Sep 30' },
            { opponent: 'RRN', result: 'W', score: '21-11', date: 'Oct 2' }
          ],
          upcomingGames: []
        },
        'sap': {
          name: 'SAP Center',
          seed: 10,
          icon: 'üèüÔ∏è',
          record: { wins: 2, losses: 1 },
          pointDiff: 15,
          roster: [],
          completedGames: [
            { opponent: 'LeBronda', result: 'W', score: '11-0', date: 'Sep 25' },
            { opponent: "Rajesh's Last Dance", result: 'L', score: '14-21', date: 'Sep 30' },
            { opponent: 'Buzz Ballers', result: 'W', score: '11-0', date: 'Oct 1' }
          ],
          upcomingGames: []
        },
        'are': {
          name: 'ARE 3.0',
          seed: 11,
          icon: 'üöÄ',
          record: { wins: 2, losses: 1 },
          pointDiff: 12,
          roster: [],
          completedGames: [
            { opponent: 'BBB', result: 'L', score: '18-21', date: 'Sep 22' },
            { opponent: 'Lafayette Lakers', result: 'W', score: '21-16', date: 'Sep 29' },
            { opponent: 'Rasthuggers', result: 'W', score: '21-11', date: 'Sep 30' }
          ],
          upcomingGames: []
        },
        'naujawan': {
          name: 'Naujawan',
          seed: 12,
          icon: 'üíé',
          record: { wins: 2, losses: 1 },
          pointDiff: 11,
          roster: [],
          completedGames: [
            { opponent: 'The Baboons', result: 'W', score: '21-17', date: 'Sep 22' },
            { opponent: 'Walmart Oreos', result: 'W', score: '22-12', date: 'Sep 29' },
            { opponent: 'BBS', result: 'L', score: '18-21', date: 'Oct 1' }
          ],
          upcomingGames: []
        },
        'buckit': {
          name: 'Buckit',
          seed: 13,
          icon: 'ü™£',
          record: { wins: 2, losses: 1 },
          pointDiff: 10,
          roster: [],
          completedGames: [
            { opponent: 'Mutts and Fulls', result: 'L', score: '8-21', date: 'Sep 22' },
            { opponent: 'Certified Bucket Getters', result: 'W', score: '22-4', date: 'Sep 25' },
            { opponent: 'The Blue Ballers', result: 'W', score: '21-16', date: 'Oct 2' }
          ],
          upcomingGames: []
        },
        'swish': {
          name: 'Swish Kebabs',
          seed: 14,
          icon: 'üå∂Ô∏è',
          record: { wins: 1, losses: 2 },
          pointDiff: 18,
          roster: [],
          completedGames: [
            { opponent: 'KOS', result: 'L', score: '18-21', date: 'Sep 25' },
            { opponent: 'Tandoori Towers', result: 'L', score: '17-21', date: 'Sep 30' },
            { opponent: '67 Elite Freaks', result: 'W', score: '21-4', date: 'Oct 1' }
          ],
          upcomingGames: []
        },
        'diko': {
          name: 'Diko & Co.',
          seed: 15,
          icon: 'üéØ',
          record: { wins: 1, losses: 2 },
          pointDiff: 5,
          roster: [],
          completedGames: [
            { opponent: 'Nav/Sandeep', result: 'L', score: '18-22', date: 'Sep 22' },
            { opponent: 'Tech Support', result: 'L', score: '19-21', date: 'Sep 29' },
            { opponent: 'Kareem Puffs', result: 'W', score: '11-0', date: 'Oct 2' }
          ],
          upcomingGames: []
        },
        'fuse': {
          name: 'Fuse',
          seed: 16,
          icon: '‚ö°',
          record: { wins: 1, losses: 2 },
          pointDiff: 2,
          roster: [],
          completedGames: [
            { opponent: 'Hoop', result: 'L', score: '15-21', date: 'Sep 25' },
            { opponent: 'LeMickey', result: 'L', score: '13-21', date: 'Sep 30' },
            { opponent: 'Squirt Sisters', result: 'W', score: '22-6', date: 'Oct 2' }
          ],
          upcomingGames: []
        }
      };

      try {
        let successCount = 0;
        for (const [teamId, teamData] of Object.entries(teamsData)) {
          const { doc, setDoc } = window.firestoreImports;
          await setDoc(doc(db, 'teams', teamId), teamData);
          log(`‚úì Added team: ${teamData.name}`, 'success');
          successCount++;
        }
        log(`‚úÖ Successfully initialized ${successCount} teams!`, 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    };

    window.initializeBracket = async function() {
      const btn = document.getElementById('initBracketBtn');
      btn.disabled = true;
      log('Starting bracket initialization...', 'info');

      // Initialize with all TBD slots for both Black and Gold brackets
      const bracketData = {};

      // Black Bracket
      // Round of 16 slots
      for (let match = 1; match <= 8; match++) {
        bracketData[`black-r16-${match}-1`] = 'TBD';
        bracketData[`black-r16-${match}-2`] = 'TBD';
      }

      // Quarterfinals
      for (let i = 1; i <= 8; i++) {
        bracketData[`black-qf-${i}`] = 'TBD';
      }

      // Semifinals
      for (let i = 1; i <= 4; i++) {
        bracketData[`black-sf-${i}`] = 'TBD';
      }

      // Finals
      bracketData['black-f-1'] = 'TBD';
      bracketData['black-f-2'] = 'TBD';

      // Champion
      bracketData['black-champion'] = 'TBD';

      // Gold Bracket
      // Round of 16 slots
      for (let match = 1; match <= 8; match++) {
        bracketData[`gold-r16-${match}-1`] = 'TBD';
        bracketData[`gold-r16-${match}-2`] = 'TBD';
      }

      // Quarterfinals
      for (let i = 1; i <= 8; i++) {
        bracketData[`gold-qf-${i}`] = 'TBD';
      }

      // Semifinals
      for (let i = 1; i <= 4; i++) {
        bracketData[`gold-sf-${i}`] = 'TBD';
      }

      // Finals
      bracketData['gold-f-1'] = 'TBD';
      bracketData['gold-f-2'] = 'TBD';

      // Champion
      bracketData['gold-champion'] = 'TBD';

      try {
        const { doc, setDoc } = window.firestoreImports;
        await setDoc(doc(db, 'tournament', 'bracket'), bracketData);
        log('‚úÖ Successfully initialized Black and Gold brackets with all TBD slots!', 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    };

    window.initializeAdminPassword = async function() {
      const btn = document.getElementById('initPasswordBtn');
      btn.disabled = true;

      const password = prompt('Enter the admin password you want to set:');

      if (!password) {
        log('‚ö†Ô∏è Password setup cancelled', 'warning');
        btn.disabled = false;
        return;
      }

      if (password.length < 6) {
        log('‚ùå Password must be at least 6 characters long', 'error');
        btn.disabled = false;
        return;
      }

      log('Setting admin password...', 'info');

      try {
        const { doc, setDoc } = window.firestoreImports;
        await setDoc(doc(db, 'system', 'adminConfig'), {
          password: password,
          lastUpdated: new Date().toISOString()
        });
        log('‚úÖ Admin password set successfully!', 'success');
        log(`‚ö†Ô∏è IMPORTANT: Remember your password: ${password}`, 'warning');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    };

    window.initializeInitPassword = async function() {
      const btn = document.getElementById('initInitPasswordBtn');
      btn.disabled = true;

      const password = prompt('Enter the init-firestore.html password you want to set:');

      if (!password) {
        log('‚ö†Ô∏è Init password setup cancelled', 'warning');
        btn.disabled = false;
        return;
      }

      if (password.length < 6) {
        log('‚ùå Password must be at least 6 characters long', 'error');
        btn.disabled = false;
        return;
      }

      log('Setting init password...', 'info');

      try {
        const { doc, setDoc } = window.firestoreImports;
        await setDoc(doc(db, 'system', 'initConfig'), {
          password: password,
          lastUpdated: new Date().toISOString()
        });
        log('‚úÖ Init password set successfully!', 'success');
        log(`‚ö†Ô∏è IMPORTANT: Remember your init password: ${password}`, 'warning');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    };

    window.initializeAll = async function() {
      log('=== Starting full initialization ===', 'warning');
      await window.initializeTeams();
      await window.initializeBracket();
      await window.initializeAdminPassword();
      log('=== Initialization complete! ===', 'success');
    };

    // Load and display admin requests
    window.loadAdminRequests = async function() {
      const container = document.getElementById('adminRequestsContainer');
      container.innerHTML = '<p style="color: #60a5fa;">Loading requests...</p>';

      try {
        const requestsSnapshot = await getDocs(collection(db, 'admin_requests'));

        if (requestsSnapshot.empty) {
          container.innerHTML = '<p style="color: var(--muted);">No pending admin requests.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 1rem;">';

        requestsSnapshot.forEach((docSnapshot) => {
          const request = docSnapshot.data();
          const requestId = docSnapshot.id;
          const status = request.status || 'pending';

          // Only show pending requests
          if (status !== 'pending') return;

          const requestDate = request.requestedAt?.toDate ? request.requestedAt.toDate().toLocaleString() : 'Unknown date';

          const hasUid = request.uid && request.uid !== 'undefined';
          const statusColor = hasUid ? '#f59e0b' : '#ef4444';
          const statusText = hasUid ? 'PENDING' : 'NO UID';
          const uidDisplay = hasUid ? `<p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.75rem; font-family: monospace;">UID: ${request.uid}</p>` : `<p style="margin: 0.5rem 0 0 0; color: #ef4444; font-size: 0.85rem;">‚ö†Ô∏è User hasn't signed in yet</p>`;

          html += `
            <div style="background: #0a1122; border: 1px solid #1f2937; border-radius: 8px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                  <h3 style="margin: 0 0 0.5rem 0; color: #e7ecf6;">${request.name || 'Unknown'}</h3>
                  <p style="margin: 0; color: #60a5fa; font-size: 0.9rem;">${request.email}</p>
                  <p style="margin: 0.5rem 0 0 0; color: var(--muted); font-size: 0.85rem;">Requested: ${requestDate}</p>
                  ${uidDisplay}
                </div>
                <span style="background: ${statusColor}; color: #0b0f1a; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">${statusText}</span>
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button onclick="approveAdminRequest('${requestId}', '${request.email}', '${request.uid}')" style="flex: 1; background: #22c55e;">
                  ‚úÖ Approve
                </button>
                <button onclick="declineAdminRequest('${requestId}')" style="flex: 1; background: #ef4444;">
                  ‚ùå Decline
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';
        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading admin requests:', error);
        container.innerHTML = '<p style="color: #ef4444;">Error loading requests. Check console.</p>';
      }
    };

    // Approve admin request
    window.approveAdminRequest = async function(requestId, email, uid) {
      if (!confirm(`Approve admin access for ${email}?`)) {
        return;
      }

      log(`Approving admin request for ${email}...`, 'info');

      try {
        // Get the request document to verify it has a UID
        const requestDoc = await getDoc(doc(db, 'admin_requests', requestId));
        const requestData = requestDoc.data();

        if (!requestData.uid) {
          log(`‚ùå Error: Request missing UID. User must sign in with Google first.`, 'error');
          return;
        }

        const userUid = requestData.uid;
        log(`‚úì Found user UID: ${userUid}`, 'info');

        // Add to approved admins list
        await setDoc(doc(db, 'approved_admins', userUid), {
          email: email,
          approvedAt: new Date(),
          approvedBy: window.ADMIN_UID,
          name: requestData.name || 'Unknown'
        });

        log(`‚úì Added ${email} to approved admins list`, 'success');

        // Also update user's roles in users collection
        const userDocRef = doc(db, 'users', userUid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          const userData = userDoc.data();
          const currentRoles = userData.roles || ['player'];

          if (!currentRoles.includes('admin')) {
            await updateDoc(userDocRef, {
              roles: [...currentRoles, 'admin']
            });
            log(`‚úì Added 'admin' role to user profile`, 'success');
          }
        }

        // DELETE the request
        await deleteDoc(doc(db, 'admin_requests', requestId));
        log(`‚úì Deleted request from database`, 'success');

        log(`‚úÖ Successfully approved ${email} as admin!`, 'success');
        log(`‚úÖ User can now access admin features immediately`, 'success');

        // Reload the requests list
        await loadAdminRequests();

      } catch (error) {
        console.error('Error approving admin:', error);
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    };

    // Decline admin request
    window.declineAdminRequest = async function(requestId) {
      if (!confirm('Decline this admin request? The request will be permanently deleted.')) {
        return;
      }

      log(`Declining admin request...`, 'info');

      try {
        // DELETE the request completely (removes password from database)
        await deleteDoc(doc(db, 'admin_requests', requestId));

        log(`‚úÖ Request declined and deleted from database`, 'success');

        // Reload the requests list
        await loadAdminRequests();

      } catch (error) {
        console.error('Error declining admin:', error);
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    };

    // Load tournament applications
    window.loadTournamentApplications = async function() {
      const container = document.getElementById('tournamentApplicationsContainer');
      container.innerHTML = '<p style="color: #60a5fa;">Loading applications...</p>';

      try {
        const applicationsQuery = query(
          collection(db, 'tournament_entries'),
          where('status', '==', 'active'),
          orderBy('createdAt', 'desc')
        );
        const snapshot = await getDocs(applicationsQuery);

        if (snapshot.empty) {
          container.innerHTML = '<p style="color: #94a3b8;">No tournament applications yet.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 1rem;">';
        let count = 0;

        snapshot.forEach((docSnapshot) => {
          const app = docSnapshot.data();
          const appId = docSnapshot.id;
          count++;

          const submittedDate = app.createdAt ? new Date(app.createdAt).toLocaleString() : 'Unknown date';
          const updatedDate = app.updatedAt ? new Date(app.updatedAt).toLocaleString() : 'N/A';

          html += `
            <div style="background: #0a1122; border: 1px solid #1f2937; border-radius: 8px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                  <h3 style="margin: 0 0 0.5rem 0; color: #ff9d00;">${app.teamName || 'Unnamed Team'}</h3>
                  <p style="margin: 0; color: #60a5fa; font-size: 0.9rem;">Captain: ${app.captainName || 'N/A'}</p>
                </div>
                <span style="background: #22c55e; color: #0b0f1a; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">ACTIVE</span>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                <div>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.85rem;">Email</p>
                  <p style="margin: 0.25rem 0 0 0; color: #e7ecf6;">${app.captainEmail || 'N/A'}</p>
                </div>
                <div>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.85rem;">Instagram</p>
                  <p style="margin: 0.25rem 0 0 0; color: #e7ecf6;">${app.captainPhone || 'N/A'}</p>
                </div>
                <div>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.85rem;">Submitted</p>
                  <p style="margin: 0.25rem 0 0 0; color: #e7ecf6; font-size: 0.85rem;">${submittedDate}</p>
                </div>
                <div>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.85rem;">Last Updated</p>
                  <p style="margin: 0.25rem 0 0 0; color: #e7ecf6; font-size: 0.85rem;">${updatedDate}</p>
                </div>
              </div>

              <div style="margin-bottom: 1rem;">
                <p style="margin: 0 0 0.5rem 0; color: #94a3b8; font-size: 0.85rem;">Players</p>
                <pre style="margin: 0; padding: 0.75rem; background: #111827; border: 1px solid #1f2937; border-radius: 4px; color: #e7ecf6; font-size: 0.9rem; white-space: pre-wrap;">${app.playerNames || 'No players listed'}</pre>
              </div>

              ${app.notes ? `
                <div>
                  <p style="margin: 0 0 0.5rem 0; color: #94a3b8; font-size: 0.85rem;">Notes</p>
                  <p style="margin: 0; padding: 0.75rem; background: #111827; border: 1px solid #1f2937; border-radius: 4px; color: #e7ecf6; font-size: 0.9rem;">${app.notes}</p>
                </div>
              ` : ''}

              <p style="margin: 1rem 0 0 0; color: #60a5fa; font-size: 0.75rem; font-family: monospace;">ID: ${appId}</p>
            </div>
          `;
        });

        html += '</div>';
        html = `<p style="color: #22c55e; font-weight: 600; margin-bottom: 1rem;">Total Applications: ${count}</p>` + html;
        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading tournament applications:', error);
        container.innerHTML = '<p style="color: #ef4444;">Error loading applications. Check console.</p>';
        log(`‚ùå Error loading applications: ${error.message}`, 'error');
      }
    };

    log('üî• Firestore initialized and ready!', 'success');
  </script>
</body>
</html>
